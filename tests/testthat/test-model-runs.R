context("test models and their parameters")
set.seed(10)

test_that("p-model run check GPP", {
  skip_on_cran()
  
  # load parameters (valid ones)
  params_modl <- list(
    kphio              = 0.04998, # setup ORG in Stocker et al. 2020 GMD
    kphio_par_a        = 0.01,  # set to zero to disable temperature-dependence of kphio, setup ORG in Stocker et al. 2020 GMD
    kphio_par_b        = 1.0,
    soilm_thetastar    = 0.6 * 240,  # to recover old setup with soil moisture stress
    soilm_betao        = 0.01,
    beta_unitcostratio = 146.0,
    rd_to_vcmax        = 0.014, # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41
  )
  
  # read in demo data
  df_drivers <- p_model_drivers
  
  # run the SOFUN Fortran P-model
  mod <- run_pmodel_f_bysite( 
    df_drivers$sitename[1],
    df_drivers$params_siml[[1]],
    df_drivers$site_info[[1]],
    df_drivers$forcing[[1]], 
    params_modl = params_modl,
    makecheck = FALSE
  )
  
  # test if the returned values
  # are in a list (don't error / warning)
  expect_type(mod, "list")
  
  # test runread_pmodel_f
  df_output <- runread_pmodel_f(
    df_drivers,
    par = params_modl, 
    makecheck = FALSE,
    parallel = FALSE
  )
  
  # test for correctly returned values
  expect_type(df_output, "list")
  
  # test runread_pmodel_f
  df_output_p <- runread_pmodel_f(
    df_drivers,
    par = params_modl,
    makecheck = TRUE,
    parallel = TRUE
  )
  
  # test for correctly returned values
  expect_type(df_output_p, "list")
})

test_that("p-model run check Vcmax25", {
  skip_on_cran()
  
  # load parameters (valid ones)
  params_modl <- list(
    kphio              = 0.04998, # setup ORG in Stocker et al. 2020 GMD
    kphio_par_a        = 0.01,  # set to zero to disable temperature-dependence of kphio, setup ORG in Stocker et al. 2020 GMD
    kphio_par_b        = 1.0,
    soilm_thetastar    = 0.6 * 240,  # to recover old setup with soil moisture stress
    soilm_betao        = 0.01,
    beta_unitcostratio = 146.0,
    rd_to_vcmax        = 0.014, # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41
  )
  
  # read in demo data
  df_drivers <- p_model_drivers_vcmax25
  
  # run the SOFUN Fortran P-model
  mod <- run_pmodel_f_bysite( 
    df_drivers$sitename[1],
    df_drivers$params_siml[[1]],
    df_drivers$site_info[[1]],
    df_drivers$forcing[[1]], 
    params_modl = params_modl,
    makecheck = FALSE
  )
  
  # test if the returned values
  # are in a list (don't error / warning)
  expect_type(mod, "list")
  
  # test runread_pmodel_f
  df_output <- runread_pmodel_f(
    df_drivers,
    par = params_modl, 
    makecheck = FALSE,
    parallel = FALSE
  )
  
  # test for correctly returned values
  expect_type(df_output, "list")
  
  # test runread_pmodel_f
  df_output_p <- runread_pmodel_f(
    df_drivers,
    par = params_modl,
    makecheck = TRUE,
    parallel = TRUE,
    ncores = 1
  )
  
  # test for correctly returned values
  expect_type(df_output_p, "list")
})

test_that("biomeE output check (gs leuning)", {
  skip_on_cran()
  
  out <- runread_biomee_f(
    biomee_gs_leuning_drivers,
    makecheck = TRUE,
    parallel = FALSE)
  
  output_annual_tile <- out$data[[1]]$output_annual_tile
  
  expect_true(all.equal(colMeans(output_annual_tile), colMeans(biomee_gs_leuning_output$data[[1]]$output_annual_tile), tolerance = 1e-4))
  
  # If this test fails it means that the output of the model is out of sync with the data in the data directory.
  # It could either mean that:
  # - the model was accidentally altered and should be fixed to deliver the expected output
  # - the model, drivers, or parameters was changed and the output data needs to be re-generetaed using the scripts in
  #   raw-data directory.
})


test_that("biomee output check (p-model)", {
  skip_on_cran()
  
  out <- runread_biomee_f(
    biomee_p_model_drivers,
    makecheck = TRUE,
    parallel = FALSE)
  
  output_annual_tile <- out$data[[1]]$output_annual_tile
  
  expect_true(all.equal(colMeans(output_annual_tile), colMeans(biomee_p_model_output$data[[1]]$output_annual_tile), tolerance = 1e-4))
  
  # If this test fails it means that the output of the model is out of sync with the data in the data directory.
  # It could either mean that:
  # - the model was accidentally altered and should be fixed to deliver the expected output
  # - the model, drivers, or parameters was changed and the output data needs to be re-generetaed using the scripts in
  #   raw-data directory.
})

test_that("biomee parallel run check (gs leuning)", {
  skip_on_cran()
  
  df_drivers <- biomee_gs_leuning_drivers
  df_drivers$params_siml[[1]]$spinup <- FALSE
  
  df_output <- runread_biomee_f(
    df_drivers,
    makecheck = FALSE,
    parallel = TRUE,
    ncores = 2
  )
  
  # test for correctly returned values
  expect_type(df_output, "list")
  
})


test_that("Regression tests run_biomee_f_bysite()", {
  skip_on_cran()
  
  # read in demo data
  df_drivers_BiomeE_Pmodel <- rsofun::biomee_p_model_drivers
  df_drivers_BiomeE_gsLeun <- rsofun::biomee_gs_leuning_drivers
  # remove spinup that we can check initial conditions and transient phases
  df_drivers_BiomeE_Pmodel$params_siml[[1]]$spinupyears = 0
  df_drivers_BiomeE_gsLeun$params_siml[[1]]$spinupyears = 0
  df_drivers_BiomeE_Pmodel$params_siml[[1]]$nyeartrend = 251
  df_drivers_BiomeE_gsLeun$params_siml[[1]]$nyeartrend = 251
  df_drivers_BiomeE_Pmodel$forcing[[1]] <- df_drivers_BiomeE_Pmodel$forcing[[1]] |>
    # repeat forcing and update dates
    list() |> rep(251) |> bind_rows(.id = "repeatedyear") |> 
    mutate(date = date + lubridate::years(as.numeric(repeatedyear) - 1)) |> 
    select(-repeatedyear)
  df_drivers_BiomeE_gsLeun$forcing[[1]] <- df_drivers_BiomeE_gsLeun$forcing[[1]] |>
    # repeat forcing and update dates
    list() |> rep(251) |> bind_rows(.id = "repeatedyear") |> 
    mutate(date = date + lubridate::years(as.numeric(repeatedyear) - 1)) |> 
    select(-repeatedyear)
  
  
  # check run_biomee_f_bysite()
  # run the SOFUN Fortran P-model using the internal function `run_biomee_f_bysite`
  mod_BiomeE_Pmodel <- run_biomee_f_bysite(
    sitename       = df_drivers_BiomeE_Pmodel$sitename[1],
    params_siml    = df_drivers_BiomeE_Pmodel$params_siml[[1]],
    site_info      = df_drivers_BiomeE_Pmodel$site_info[[1]],
    forcing        = df_drivers_BiomeE_Pmodel$forcing[[1]],
    params_tile    = df_drivers_BiomeE_Pmodel$params_tile[[1]],
    params_species = df_drivers_BiomeE_Pmodel$params_species[[1]],
    init_cohort    = df_drivers_BiomeE_Pmodel$init_cohort[[1]],
    init_soil      = df_drivers_BiomeE_Pmodel$init_soil[[1]],
    makecheck      = TRUE
  )
  mod_BiomeE_gsLeun <- run_biomee_f_bysite(
    sitename       = df_drivers_BiomeE_gsLeun$sitename[1],
    params_siml    = df_drivers_BiomeE_gsLeun$params_siml[[1]],
    site_info      = df_drivers_BiomeE_gsLeun$site_info[[1]],
    forcing        = df_drivers_BiomeE_gsLeun$forcing[[1]],
    params_tile    = df_drivers_BiomeE_gsLeun$params_tile[[1]],
    params_species = df_drivers_BiomeE_gsLeun$params_species[[1]],
    init_cohort    = df_drivers_BiomeE_gsLeun$init_cohort[[1]],
    init_soil      = df_drivers_BiomeE_gsLeun$init_soil[[1]],
    makecheck      = TRUE
  )

  # Rerun again (inverse order) to test memory leakage:
  mod_BiomeE_gsLeun_2ndTry <- run_biomee_f_bysite(
    sitename       = df_drivers_BiomeE_gsLeun$sitename[1],
    params_siml    = df_drivers_BiomeE_gsLeun$params_siml[[1]],
    site_info      = df_drivers_BiomeE_gsLeun$site_info[[1]],
    forcing        = df_drivers_BiomeE_gsLeun$forcing[[1]],
    params_tile    = df_drivers_BiomeE_gsLeun$params_tile[[1]],
    params_species = df_drivers_BiomeE_gsLeun$params_species[[1]],
    init_cohort    = df_drivers_BiomeE_gsLeun$init_cohort[[1]],
    init_soil      = df_drivers_BiomeE_gsLeun$init_soil[[1]],
    makecheck      = TRUE
  )
  mod_BiomeE_Pmodel_2ndTry <- run_biomee_f_bysite(
    sitename       = df_drivers_BiomeE_Pmodel$sitename[1],
    params_siml    = df_drivers_BiomeE_Pmodel$params_siml[[1]],
    site_info      = df_drivers_BiomeE_Pmodel$site_info[[1]],
    forcing        = df_drivers_BiomeE_Pmodel$forcing[[1]],
    params_tile    = df_drivers_BiomeE_Pmodel$params_tile[[1]],
    params_species = df_drivers_BiomeE_Pmodel$params_species[[1]],
    init_cohort    = df_drivers_BiomeE_Pmodel$init_cohort[[1]],
    init_soil      = df_drivers_BiomeE_Pmodel$init_soil[[1]],
    makecheck      = TRUE
  )
  
  # Testing if the returned values are in a list (don't error / warning)
  expect_type(mod_BiomeE_Pmodel, "list")
  expect_s3_class(mod_BiomeE_Pmodel$output_daily_tile, "data.frame")
  expect_s3_class(mod_BiomeE_Pmodel$output_annual_tile, "data.frame")
  expect_s3_class(mod_BiomeE_Pmodel$output_annual_cohorts, "data.frame")
  
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel$output_daily_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel$output_annual_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel$output_annual_cohorts))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun$output_daily_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun$output_annual_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun$output_annual_cohorts))))
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel_2ndTry$output_daily_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel_2ndTry$output_annual_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_Pmodel_2ndTry$output_annual_cohorts))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun_2ndTry$output_daily_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun_2ndTry$output_annual_tile))))
  expect_true(all(!is.na(tibble(mod_BiomeE_gsLeun_2ndTry$output_annual_cohorts))))

  # Testing memory leakage, i.e. repeatability
  expect_equal(tibble(mod_BiomeE_Pmodel$output_daily_tile    ), tibble(mod_BiomeE_Pmodel_2ndTry$output_daily_tile    ), tolerance = 1e-6)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_tile   ), tibble(mod_BiomeE_Pmodel_2ndTry$output_annual_tile   ), tolerance = 1e-6)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_cohorts), tibble(mod_BiomeE_Pmodel_2ndTry$output_annual_cohorts), tolerance = 1e-6)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_daily_tile    ), tibble(mod_BiomeE_gsLeun_2ndTry$output_daily_tile    ), tolerance = 1e-6)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_tile   ), tibble(mod_BiomeE_gsLeun_2ndTry$output_annual_tile   ), tolerance = 1e-6)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_cohorts), tibble(mod_BiomeE_gsLeun_2ndTry$output_annual_cohorts), tolerance = 1e-6)
  
  # Hardcoded reference outputs.
  # NOTE: this is expected to change reasonably frequently whenever something is
  #       changed in the model.
  #       If this is expected, please update the hardcoded reference values below.
  #       To do so, simply use the commented code, making use of dput(). Thanks!
  # mod_BiomeE_Pmodel$output_daily_tile|>filter(year==  1, doy %in% c(1, 2, 180, 364, 365)) |> dput()
  # mod_BiomeE_Pmodel$output_daily_tile|>filter(year==251, doy %in% c(1, 2, 180, 364, 365)) |> dput()
  # mod_BiomeE_Pmodel$output_annual_tile|>filter(           year %in% c(1, 2, 8, 9, 16, 251)) |> dput()
  # mod_BiomeE_Pmodel$output_annual_cohorts|>filter(year==  1) |> dput()
  # mod_BiomeE_Pmodel$output_annual_cohorts|>filter(year==  2) |> dput()
  # mod_BiomeE_Pmodel$output_annual_cohorts|>filter(year==251) |> dput()
  # mod_BiomeE_gsLeun$output_daily_tile|>filter(year==  1, doy %in% c(1, 2, 180, 364, 365)) |> dput()
  # mod_BiomeE_gsLeun$output_daily_tile|>filter(year==251, doy %in% c(1, 2, 180, 364, 365)) |> dput()
  # mod_BiomeE_gsLeun$output_annual_tile|>filter(           year %in% c(1, 2, 8, 9, 16, 251)) |> dput()
  # mod_BiomeE_gsLeun$output_annual_cohorts|>filter(year==  1) |> dput()
  # mod_BiomeE_gsLeun$output_annual_cohorts|>filter(year==  2) |> dput()
  # mod_BiomeE_gsLeun$output_annual_cohorts|>filter(year==251) |> dput()
  ref_BiomeE_Pmodel_odt_yr1 <- tibble(
    year      = c(1,1,1,1,1),
    doy       = c(1,2,180,364,365),
    Tc        = c(273.533660888672,271.508483886719,290.345184326172,271.626403808594,273.387603759766),
    Prcp      = c(1.43654549121857,2.00381827354431,2.4158182144165,2.05754542350769,1.82609081268311),
    totWs     = c(799.944641113281,799.947204589844,799.132995605469,799.930969238281,799.904113769531),
    Trsp      = c(0,0,0,0,0),
    Evap      = c(0.0553628616034985,0.0527696460485458,0.86699104309082,0.0690217763185501,0.0958721935749054),
    Runoff    = c(1.43654549121857,1.94845604896545,1.08583438396454,1.97007417678833,1.7570686340332),
    ws1       = c(19.944637298584,19.9472312927246,19.1330089569092,19.9309787750244,19.9041271209717),
    ws2       = c(179.999984741211,179.999984741211,179.999984741211,179.999984741211,179.999984741211),
    ws3       = c(600,600,600,600,600),
    LAI       = c(0,0.000364852574421093,0.0114324083551764,0.0127687528729439,0.0127752413973212),
    GPP       = c(0,2.63143874690286e-07,3.22258856613189e-05,7.48024604035891e-06,8.22854053694755e-06),
    Rauto     = c(2.97977797991678e-09,5.82753855269402e-05,6.309212949418e-06,5.25199948242516e-06,5.27596557731158e-06),
    Rh        = c(2.77344884125341e-06,2.75237016467145e-06,1.07434552774066e-05,2.56022349276464e-06,2.55488953371241e-06),
    NSC       = c(0.00582691049203277,0.00565236015245318,0.00282966601662338,0.00326418946497142,0.0032569149043411),
    seedC     = c(0,0,0,0,0),
    leafC     = c(0,6.20249411440454e-05,0.00194350944366306,0.00217068823985755,0.0021717909257859),
    rootC     = c(0,3.70325360563584e-05,0.00116038939449936,0.00129602837841958,0.00129668682347983),
    SW_C      = c(0.00250000017695129,0.00163698103278875,0.00191771448589861,0.00227195932529867,0.00227372720837593),
    HW_C      = c(0,0.000880499777849764,0.00132242543622851,0.00156663579400629,0.00156784884165972),
    NSN       = c(0.000293089426122606,0.000291046482743695,0.000211518447031267,0.000204672847758047,0.000204501309781335),
    seedN     = c(0,0,0,0,0),
    leafN     = c(0,1.06719380710274e-06,3.34398027916905e-05,3.73486764146946e-05,3.73676484741736e-05),
    rootN     = c(0,9.25813424146327e-07,2.90097468678141e-05,3.24007014569361e-05,3.24171633110382e-05),
    SW_N      = c(7.14285715730512e-06,4.67708878204576e-06,5.47918443771778e-06,6.49131243335432e-06,6.49636376692797e-06),
    HW_N      = c(0,2.51571350418089e-06,3.77835863218934e-06,4.47610136689036e-06,4.47956654170412e-06),
    McrbC     = c(3.69218014384387e-07,7.35389221517835e-07,0.000101825418823864,0.000244502676650882,0.000244682451011613),
    fastSOM   = c(0.009996865876019,0.00999375618994236,0.00964521057903767,0.00866263173520565,0.00866431463509798),
    slowSOM   = c(0.000999990850687027,0.000999981770291924,0.00114093674346805,0.00132215826306492,0.00132322614081204),
    McrbN     = c(3.6921800727896e-08,7.3538920730698e-08,1.01825417004875e-05,2.44502680288861e-05,2.44682451011613e-05),
    fastSoilN = c(0.000666457752231508,0.000666250416543335,0.000634163210634142,0.000566055125091225,0.000566033646464348),
    slowSoilN = c(2.49997719947714e-05,2.4999544621096e-05,2.70212040049955e-05,2.96476737275952e-05,2.96629095828393e-05),
    mineralN  = c(0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_uptk    = c(0,0,0,0,0))
  ref_BiomeE_Pmodel_odt_yr251 <- tibble(
    year      = c(251,251,251,251,251),
    doy       = c(1,2,180,364,365),
    Tc        = c(273.533660888672,271.508483886719,290.345184326172,271.626403808594,273.387603759766),
    Prcp      = c(1.43654549121857,2.00381827354431,2.4158182144165,2.05754542350769,1.82609081268311),
    totWs     = c(799.960327148438,799.958984375,799.517150878906,799.951416015625,799.930114746094),
    Trsp      = c(0,0,0,0,0),
    Evap      = c(0.0396863967180252,0.0409640371799469,0.482832998037338,0.0485558584332466,0.0698865652084351),
    Runoff    = c(1.36665010452271,1.96413207054138,1.7444463968277,1.99358665943146,1.7775354385376),
    ws1       = c(19.9603137969971,19.9590358734131,19.5171661376953,19.9514465332031,19.9301147460938),
    ws2       = c(179.999984741211,179.999984741211,179.999984741211,179.999984741211,179.999984741211),
    ws3       = c(600,600,600,600,600),
    LAI       = c(3.54567694664001,3.55218386650085,3.65710687637329,3.77837681770325,3.77898812294006),
    GPP       = c(0.00136288069188595,0.0011933104833588,0.00945090595632792,0.00202355487272143,0.00222517573274672),
    Rauto     = c(4.07092011300847e-05,0.00233412231318653,0.00251131108961999,0.00192437425721437,0.00193062878679484),
    Rh        = c(0.00148504110984504,0.00147604499943554,0.00584590435028076,0.00144432729575783,0.00144304963760078),
    NSC       = c(2.10462856292725,2.09888339042664,2.32708692550659,2.1756317615509,2.17215013504028),
    seedC     = c(0.000596853904426098,0.000776010332629085,0.0325699262320995,0.0712852999567986,0.0714782923460007),
    leafC     = c(0.602765142917633,0.603871285915375,0.621708154678345,0.642324090003967,0.642427921295166),
    rootC     = c(0.36664879322052,0.36655056476593,0.370728135108948,0.383505165576935,0.383567243814468),
    SW_C      = c(4.56127452850342,4.54935073852539,4.69102621078491,4.90145397186279,4.9024977684021),
    HW_C      = c(3.47563409805298,3.48942971229553,3.65400004386902,3.80709719657898,3.80784773826599),
    NSN       = c(0.0627694353461266,0.0627025738358498,0.0639615803956985,0.0655358210206032,0.0654799491167068),
    seedN     = c(2.98426930385176e-05,3.88005137210712e-05,0.00162849621847272,0.00356426439248025,0.00357391429133713),
    leafN     = c(0.0103711765259504,0.0103902090340853,0.0106971114873886,0.0110518261790276,0.0110536152496934),
    rootN     = c(0.00916620250791311,0.00916374567896128,0.00926818512380123,0.009587612003088,0.00958916265517473),
    SW_N      = c(0.0130322137847543,0.0129981450736523,0.0134029313921928,0.0140041541308165,0.014007137157023),
    HW_N      = c(0.0099303862079978,0.00996980257332325,0.0104400031268597,0.0108774257823825,0.0108795687556267),
    McrbC     = c(0.124839879572392,0.124841667711735,0.125752657651901,0.12452670186758,0.124523378908634),
    fastSOM   = c(2.14155578613281,2.14213514328003,2.15683460235596,1.99661135673523,1.99728727340698),
    slowSOM   = c(69.0633392333984,69.0628204345703,68.8691482543945,68.425537109375,68.4250411987305),
    McrbN     = c(0.0124839879572392,0.0124841667711735,0.0125752659514546,0.0124526703730226,0.0124523378908634),
    fastSoilN = c(0.112321674823761,0.112333320081234,0.111948661506176,0.105792284011841,0.105806097388268),
    slowSoilN = c(-0.229132562875748,-0.229127779603004,-0.228195950388908,-0.227049291133881,-0.227044239640236),
    mineralN  = c(0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_uptk    = c(0,0,0,0,0))
  ref_BiomeE_Pmodel_oat <- tibble(
    year            = c(1,2,8,9,16,251),
    CAI             = c(0.00405973428860307,0.00528940046206117,0.0150721985846758,0.0172902140766382,0.0522034913301468,1.37233078479767),
    LAI             = c(0.0127817085012794,0.0103041492402554,0.0474587865173817,0.0544437877833843,0.158660411834717,3.77959847450256),
    Density         = c(500,494.729370117188,462.252288818359,456.624847412109,2168.74096679688,43808.20703125),
    DBH             = c(0.664211988449097,0.797969460487366,1.67813861370087,1.85405588150024,1.17340326309204,1.06312143802643),
    Density12       = c(0,0,0,0,0,103.165672302246),
    DBH12           = c(0,0,0,0,0,24.2523612976074),
    QMD12           = c(0,0,0,0,0,24.2788753509521),
    NPP             = c(0.00393238849937916,0.00679537653923035,0.0198027081787586,0.0227339081466198,0.0667569115757942,1.44258284568787),
    GPP             = c(0.00745523814111948,0.00850020628422499,0.0287621635943651,0.0331381112337112,0.0980574190616608,2.21592283248901),
    Rauto           = c(0.00352284475229681,0.00170483184047043,0.00895946566015482,0.0104041984304786,0.031300526112318,0.773340880870819),
    Rh              = c(0.00246010161936283,0.00226421980187297,0.00382962869480252,0.00449846684932709,0.0135388551279902,1.35561752319336),
    rain            = c(587.529663085938,587.529663085938,587.529663085938,587.529663085938,587.529663085938,587.529663085938),
    SoilWater       = c(799.904113769531,799.904052734375,799.90478515625,799.904968261719,799.906982421875,799.930114746094),
    Transp          = c(0,0,0,0,0,0),
    Evap            = c(159.255844116211,159.255340576172,157.617523193359,157.285614013672,152.670364379883,94.149055480957),
    Runoff          = c(428.369323730469,428.273864746094,429.911560058594,430.24365234375,434.858764648438,493.380340576172),
    plantC          = c(0.0105614811182022,0.0157219562679529,0.0664887428283691,0.0805049166083336,0.270114004611969,11.9783458709717),
    soilC           = c(0.01023771148175,0.0096083777025342,0.0222407914698124,0.026460038498044,0.0855240449309349,70.5484771728516),
    plantN          = c(0.000285134417936206,0.000247161951847374,0.00119579688180238,0.00140023196581751,0.00404958426952362,0.114545591175556),
    soilN           = c(0.0156202921643853,0.0155606595799327,0.0151013219729066,0.0149276871234179,0.0128978732973337,-0.0937480330467224),
    totN            = c(0.0159054268151522,0.0158078223466873,0.0162971187382936,0.0163279194384813,0.0169474575668573,0.0207975581288338),
    NSC             = c(0.00324669643305242,0.00714651541784406,0.021900437772274,0.0259315352886915,0.0797630548477173,2.16837739944458),
    SeedC           = c(0,0,0.00174317846540362,0.00256941723637283,0.00449186703190207,0.0716710016131401),
    leafC           = c(0.00217289058491588,0.00175170530565083,0.00806799344718456,0.00925544369965792,0.0269722677767277,0.642531633377075),
    rootC           = c(0.00129734340589494,0.00102298962883651,0.00481706624850631,0.00552604394033551,0.0161040294915438,0.38362917304039),
    SapwoodC        = c(0.00227549090050161,0.00212571839801967,0.0177348908036947,0.0220341514796019,0.0837161839008331,4.90354013442993),
    WoodC           = c(0.00156905956100672,0.0036750272847712,0.0122251799330115,0.0151883289217949,0.0590666234493256,3.80859613418579),
    NSN             = c(0.000204329844564199,0.000174874017830007,0.000763793475925922,0.000868011440616101,0.00255035609006882,0.0654240995645523),
    SeedN           = c(0,0,8.71589145390317e-05,0.000128470783238299,0.0002245933865197,0.0035835497546941),
    leafN           = c(3.73865696019493e-05,3.01396794384345e-05,0.000138817587867379,0.000159248840645887,0.000464084267150611,0.0110554005950689),
    rootN           = c(3.24335705954581e-05,2.55747108894866e-05,0.000120426666398998,0.000138150979182683,0.000402599747758359,0.00959071330726147),
    SapwoodN        = c(6.50140236757579e-06,6.07348101766547e-06,5.0671114877332e-05,6.29547212156467e-05,0.000239189103012905,0.0140101136639714),
    WoodN           = c(4.48302625954966e-06,1.05000799521804e-05,3.49290676240344e-05,4.33952009188943e-05,0.000168761878740042,0.010881707072258),
    McrbC           = c(0.000244682451011613,0.000358526827767491,0.000687434221617877,0.000794921885244548,0.00227368529886007,0.124523378908634),
    fastSOM         = c(0.00866872165352106,0.00752501981332898,0.0136959059163928,0.0159694291651249,0.0470854938030243,1.99859094619751),
    SlowSOM         = c(0.0013243070570752,0.00172483082860708,0.00785745214670897,0.00969568826258183,0.036164864897728,68.4253616333008),
    McrbN           = c(2.44682451011613e-05,3.58526813215576e-05,6.87434221617877e-05,7.94921870692633e-05,0.000227368524065241,0.0124523378908634),
    fastSoilN       = c(0.000566145987249911,0.000485254422528669,0.000614426797255874,0.00070906471228227,0.00206336285918951,0.10583933442831),
    slowSoilN       = c(2.96782218356384e-05,3.95530259993393e-05,-0.000581847736611962,-0.000860869069583714,-0.0043928581289947,-0.227039709687233),
    mineralN        = c(0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_fxed          = c(0,0,0,0,0,0),
    N_uptk          = c(2.43937665800331e-05,0,0.000366597203537822,0.000402942299842834,0.0011336033931002,0.0226072128862143),
    N_yrMin         = c(-0.0519865341484547,-0.0519134774804115,-0.0520324818789959,-0.0520263910293579,-0.0519089959561825,-0.0341280214488506),
    N_P2S           = c(4.24973768531345e-05,3.76145362679381e-05,0.00017427685088478,0.000201485832803883,0.00059368455549702,0.0219358261674643),
    N_loss          = c(0.0528971552848816,0.0528973713517189,0.0528935790061951,0.0528930500149727,0.0528868474066257,0.0527308881282806),
    totseedC        = c(0,0,0,0,0,0.067626103758812),
    totseedN        = c(0,0,0,0,0,0.0033813058398664),
    Seedling_C      = c(0,0,0,0,0,0.067626103758812),
    Seedling_N      = c(0,0,0,0,0,0.0033813058398664),
    MaxAge          = c(1.00000047683716,1.99997925758362,8.00019931793213,9.00026512145996,16.0007247924805,81.9219436645508),
    MaxVolume       = c(0.000207813529414125,0.000316894293064252,0.00175170926377177,0.00220314995385706,0.0082816369831562,0.830334901809692),
    MaxDBH          = c(0.00664211995899677,0.00797969475388527,0.0167813859879971,0.0185405593365431,0.0329720042645931,0.244444251060486),
    NPPL            = c(0.00255186832509935,2.29823399422457e-06,0.00270513794384897,0.00305092777125537,0.00903066247701645,0.168135315179825),
    NPPW            = c(0.00134455063380301,0.00199672137387097,0.00641023553907871,0.00762713793665171,0.02389170601964,0.675228536128998),
    n_deadtrees     = c(3.00569490718772e-06,2.64780169345613e-06,1.4557523172698e-05,1.7537275198265e-05,5.9667549066944e-05,0.00939261913299561),
    c_deadtrees     = c(0.000111332017695531,0.000168426471645944,0.000809428049251437,0.00100828788708895,0.00409236736595631,0.877536237239838),
    m_turnover      = c(0.000111332017695531,0.000168426471645944,0.000809428049251437,0.00100828788708895,0.00409236736595631,0.877536237239838),
    c_turnover_time = c(1.16697692871094,1.84053087234497,1.90713429450989,1.99135363101959,2.47226476669312,5.64045476913452))
  ref_BiomeE_Pmodel_oac_yr1 <- tibble(
    cohort      = "1",
    year        = 1,
    cID         = 1,
    PFT         = 2,
    layer       = 1,
    density     = 500,
    flayer      = 0.00306598958559334,
    DBH         = 0.664211988449097,
    dDBH        = 0.113396346569061,
    height      = 2.93403148651123,
    age         = 1.00000047683716,
    BA          = 3.46500055457e-05,
    dBA         = 3.46500055457e-05,
    Acrown      = 0.0811946839094162,
    Aleaf       = 0.255634158849716,
    nsc         = 0.0649339258670807,
    seedC       = 0.00408659689128399,
    leafC       = 0,
    rootC       = 0.0434578098356724,
    sapwC       = 0.0259468667209148,
    woodC       = 0.0455098152160645,
    nsn         = 0.0313811898231506,
    treeG       = 0.130252033472061,
    fseed       = 0,
    fleaf       = 0.391835480928421,
    froot       = 0.401710838079453,
    fwood       = 0.206453680992126,
    GPP         = 0.149104759097099,
    NPP         = 0.0786477699875832,
    Rauto       = 0.0704568848013878,
    Nupt        = 0.00048787533887662,
    Nfix        = 0,
    n_deadtrees = 3.00569490718772e-06,
    c_deadtrees = 0.000111332017695531,
    deathrate   = 0.0105413272976875)
  ref_BiomeE_Pmodel_oac_yr2 <- tibble(
    cohort      = "2",
    year        = 2,
    cID         = 1,
    PFT         = 2,
    layer       = 1,
    density     = 494.729370117188,
    flayer      = 0.0040169395506382,
    DBH         = 0.797969460487366,
    dDBH        = 0.133757472038269,
    height      = 3.21594667434692,
    age         = 1.99997925758362,
    BA          = 5.00106471008621e-05,
    dBA         = 1.53606415551621e-05,
    Acrown      = 0.106915026903152,
    Aleaf       = 0.208278506994247,
    nsc         = 0.144453033804893,
    seedC       = 0.0035347412340343,
    leafC       = 0,
    rootC       = 0.0354073457419872,
    sapwC       = 0.0206777639687061,
    woodC       = 0.0429672971367836,
    nsn         = 0.074283592402935,
    treeG       = 0.057836040854454,
    fseed       = 0,
    fleaf       = 0.000803207978606224,
    froot       = 0.301364243030548,
    fwood       = 0.697832584381104,
    GPP         = 0.171815320849419,
    NPP         = 0.13735543191433,
    Rauto       = 0.0344598852097988,
    Nupt        = 0,
    Nfix        = 0,
    n_deadtrees = 2.64780169345613e-06,
    c_deadtrees = 0.000168426471645944,
    deathrate   = 0.0107128191739321)
  ref_BiomeE_Pmodel_oac_yr251 <- tibble(
    cohort      = c("251","502","753","1004","1255"),
    year        = c(251,251,251,251,251),
    cID         = c(23,23,23,23,23),
    PFT         = c(2,2,2,2,2),
    layer       = c(1,1,1,2,2),
    density     = c(100.290580749512,2.87509489059448,4228.7509765625,1153.57653808594,38322.71484375),
    flayer      = c(0.176964774727821,0.00306387385353446,0.819971323013306,0.0238543692976236,0.0840449556708336),
    DBH         = c(24.4444255828857,17.5526580810547,5.78979730606079,4.65543413162231,0.370992064476013),
    dDBH        = c(0.436174869537354,0.399026274681091,0.281577169895172,0.056992843747139,0.0302785076200962),
    height      = c(17.7989501953125,15.0825729370117,8.66272926330566,7.76752710342407,2.19273519515991),
    age         = c(81.9219436645508,81.9219436645508,31.7518215179443,31.751823425293,2.84310746192932),
    BA          = c(0.0469298921525478,0.0241977870464325,0.00263279257342219,0.00170219875872135,1.08098365672049e-05),
    dBA         = c(0.00165984779596329,0.00108767673373222,0.000249856151640415,-0.000680737663060427,1.02954800240695e-09),
    Acrown      = c(18.1282634735107,11.0305862426758,2.08961009979248,1.50671625137329,0.0338949263095856),
    Aleaf       = c(57.0999908447266,34.7432174682617,6.58100605010986,2.37300658226013,0.0366001687943935),
    nsc         = c(40.4446334838867,24.045389175415,4.00610208511353,0.341217547655106,0.0058450335636735),
    seedC       = c(0.918515384197235,0.5807044506073,0.104706086218357,0.0396970063447952,0.00187574094161391),
    leafC       = c(1.38477265834808,0.820930957794189,0.134673714637756,0.00517394253984094,0),
    rootC       = c(9.70699882507324,5.90634727478027,1.11877107620239,0.403411120176315,0.00622202875092626),
    sapwC       = c(5.7956485748291,3.52643609046936,0.667972087860107,0.240860134363174,0.00371491652913392),
    woodC       = c(181.886611938477,84.9112930297852,6.62316608428955,2.0628650188446,0.00423682481050491),
    nsn         = c(125.337287902832,58.5130043029785,4.56426286697388,4.71297979354858,0.0159087404608727),
    treeG       = c(23.0908241271973,13.8812999725342,2.46863126754761,0.493890434503555,0.0108649441972375),
    fseed       = c(0.0599706918001175,0.0591393411159515,0.0545540004968643,0.0104758916422725,0),
    fleaf       = c(0.0965606421232224,0.100491337478161,0.122458748519421,0.0783605501055717,0.313920468091965),
    froot       = c(0.303732395172119,0.308115303516388,0.332001149654388,0.527946352958679,0.356385111808777),
    fwood       = c(0.539736211299896,0.532254040241241,0.490986168384552,0.383217185735703,0.329694449901581),
    GPP         = c(37.1911659240723,22.5364723205566,4.17520666122437,0.400555223226547,0.00643333327025175),
    NPP         = c(24.2126598358154,14.7389669418335,2.78701972961426,0.127163007855415,0.00059631303884089),
    Rauto       = c(12.9785089492798,7.79751491546631,1.38818788528442,0.273392230272293,0.00583701953291893),
    Nupt        = c(0.321804583072662,0.232588201761246,0.0444839894771576,0.00434971088543534,0),
    Nfix        = c(0,0,0,0,0),
    n_deadtrees = c(0.00285760848782957,2.93337579932995e-05,0.00181504897773266,0.00181504897773266,0.00287557835690677),
    c_deadtrees = c(0.478431105613708,0.00426857592537999,0.173203229904175,0.173203229904175,0.0484300963580608),
    deathrate   = c(0.130856424570084,0.0835384204983711,0.023931410163641,0.023931410163641,0.351747900247574))
  ref_BiomeE_gsLeun_odt_yr1 <- tibble(
    year      = c(1,1,1,1,1),
    doy       = c(1,2,180,364,365),
    Tc        = c(273.533660888672,271.508483886719,290.34521484375,271.626373291016,273.387603759766),
    Prcp      = c(1.43654537200928,2.00381803512573,2.4158182144165,2.05754518508911,1.8260909318924),
    totWs     = c(799.998291015625,799.998168945312,799.987243652344,799.997924804688,799.997619628906),
    Trsp      = c(0,1.49713571317989e-06,0.00989423505961895,0.000119651507702656,0.000218600151129067),
    Evap      = c(0.0556573569774628,0.0521354898810387,0.929720222949982,0.07036142796278,0.100025936961174),
    Runoff    = c(1.38256895542145,1.95178186893463,0.611501753330231,1.98658740520477,1.72619795799255),
    ws1       = c(19.9983215332031,19.9982204437256,19.9872608184814,19.9979648590088,19.9976501464844),
    ws2       = c(179.999984741211,179.999984741211,179.999984741211,179.999984741211,179.999984741211),
    ws3       = c(600,600,600,600,600),
    LAI       = c(0,0.000364852749044076,0.011269086971879,0.0120545439422131,0.012058237567544),
    GPP       = c(0,6.26108729306907e-08,3.06351903418545e-05,8.34546085570764e-07,1.98450516109006e-06),
    Rauto     = c(2.98780267193877e-09,5.82782595301978e-05,8.66287246026332e-06,4.15019985666731e-06,4.35614811067353e-06),
    Rh        = c(2.7720184334612e-06,2.75420779871638e-06,1.07334790300229e-05,2.55169356933038e-06,2.54445421887795e-06),
    NSC       = c(0.00582691328600049,0.00565216084942222,0.00134072790388018,0.00179522286634892,0.00178503000643104),
    seedC     = c(0,0,0,0,0),
    leafC     = c(0,6.20249702478759e-05,0.0019157447386533,0.00204927264712751,0.0020499003585428),
    rootC     = c(0,3.70325542462524e-05,0.00114381220191717,0.00122353609185666,0.00122391094919294),
    SW_C      = c(0.00250000017695129,0.00163698103278875,0.00187556317541748,0.0020797720644623,0.00208074669353664),
    HW_C      = c(0,0.000880499777849764,0.00129258120432496,0.00143350858706981,0.00143417331855744),
    NSN       = c(0.000293089426122606,0.000291046482743695,0.000213006234844215,0.000189515107194893,0.000189369806321338),
    seedN     = c(0,0,0,0,0),
    leafN     = c(0,1.06719437553693e-06,3.2962067052722e-05,3.52595379808918e-05,3.52703427779488e-05),
    rootN     = c(0,9.2581376520684e-07,2.85953265120042e-05,3.05883622786496e-05,3.05977337120567e-05),
    SW_N      = c(7.14285715730512e-06,4.67708878204576e-06,5.35875187779311e-06,5.94220591665362e-06,5.94499078943045e-06),
    HW_N      = c(0,2.51571350418089e-06,3.69308986591932e-06,4.0957388591778e-06,4.09763833886245e-06),
    McrbC     = c(3.68914641057927e-07,7.35217042802105e-07,0.000101686237030663,0.000243882124777883,0.000244060705881566),
    fastSOM   = c(0.00999687053263187,0.00999375898391008,0.00963238812983036,0.00862457603216171,0.00862602982670069),
    slowSOM   = c(0.00099999166559428,0.000999983283691108,0.00113767047878355,0.00131190498359501,0.00131291372235864),
    McrbN     = c(3.68914641057927e-08,7.35217042802105e-08,1.01686237030663e-05,2.43882132053841e-05,2.44060702243587e-05),
    fastSoilN = c(0.000666458043269813,0.000666250591166317,0.00063381198560819,0.000564941379707307,0.000564913265407085),
    slowSoilN = c(2.49997920036549e-05,2.49995828198735e-05,2.69737010967219e-05,2.95015670417342e-05,2.95159279630752e-05),
    mineralN  = c(0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_uptk    = c(0,0,0,3.26594630450927e-07,0))
  ref_BiomeE_gsLeun_odt_yr251 <- tibble(
    year      = c(251,251,251,251,251),
    doy       = c(1,2,180,364,365),
    Tc        = c(273.533660888672,271.508483886719,290.34521484375,271.626373291016,273.387603759766),
    Prcp      = c(1.43654537200928,2.00381803512573,2.4158182144165,2.05754518508911,1.8260909318924),
    totWs     = c(731.164733886719,733.100830078125,716.131103515625,729.361206054688,731.053649902344),
    Trsp      = c(0.0344678051769733,0.0267226919531822,2.92578029632568,0.0337419398128986,0.0616292916238308),
    Evap      = c(0.0402824692428112,0.0410229787230492,0.483833283185959,0.0493568405508995,0.0718512162566185),
    Runoff    = c(0,0,0,0,0),
    ws1       = c(19.9980888366699,19.9979629516602,19.6839447021484,19.9976615905762,19.9972991943359),
    ws2       = c(179.998962402344,179.998901367188,133.943588256836,179.998718261719,179.998504638672),
    ws3       = c(531.167663574219,533.103942871094,562.503601074219,529.364807128906,531.057861328125),
    LAI       = c(3.25403642654419,3.31764793395996,3.32860231399536,3.39499855041504,3.39532446861267),
    GPP       = c(0.000524534785654396,0.000223315844777972,0.00905360467731953,0.000235706131206825,0.000560263695660979),
    Rauto     = c(0.000125647362438031,0.0108530195429921,0.00284489570185542,0.00137514597736299,0.00143388856668025),
    Rh        = c(0.00099808000959456,0.000994771136902273,0.00401309318840504,0.000972399662714452,0.000972421607002616),
    NSC       = c(1.15120446681976,1.11899769306183,1.16031241416931,1.18785095214844,1.18436563014984),
    seedC     = c(0.000137575043481775,0.000451966043328866,0.0157529786229134,0.0365422554314137,0.0366444736719131),
    leafC     = c(0.553186297416687,0.564000070095062,0.565862357616425,0.577149748802185,0.577205121517181),
    rootC     = c(0.330284982919693,0.336364269256592,0.33338075876236,0.33924001455307,0.339270621538162),
    SW_C      = c(4.18843507766724,4.18769931793213,4.27440547943115,4.38803911209106,4.38859939575195),
    HW_C      = c(2.99533867835999,2.99904584884644,3.06052398681641,3.14654517173767,3.14696836471558),
    NSN       = c(0.0552602037787437,0.0548694208264351,0.0549194179475307,0.055515144020319,0.0555202923715115),
    seedN     = c(6.87875262883608e-06,2.25983039854327e-05,0.00078764877980575,0.00182711286470294,0.00183222361374646),
    leafN     = c(0.00951812695711851,0.00970419123768806,0.00973623525351286,0.00993044394999743,0.00993139762431383),
    rootN     = c(0.00825711991637945,0.00840909965336323,0.00833450816571712,0.00848098285496235,0.00848174653947353),
    SW_N      = c(0.0119669558480382,0.0119648557156324,0.0122125865891576,0.0125372549518943,0.0125388512387872),
    HW_N      = c(0.00855811219662428,0.00856870505958796,0.00874435529112816,0.00899013131856918,0.00899134017527103),
    McrbC     = c(0.103956334292889,0.103956826031208,0.104550376534462,0.103543065488338,0.103540726006031),
    fastSOM   = c(1.75759303569794,1.75816917419434,1.78778755664825,1.67230677604675,1.67293691635132),
    slowSOM   = c(37.8931121826172,37.8929290771484,37.8068389892578,37.5839691162109,37.583797454834),
    McrbN     = c(0.0103956330567598,0.0103956824168563,0.0104550374671817,0.0103543065488338,0.0103540727868676),
    fastSoilN = c(0.0914474055171013,0.0914599299430847,0.0917267054319382,0.0873922258615494,0.0874061733484268),
    slowSoilN = c(-0.193332701921463,-0.193328455090523,-0.192495435476303,-0.191494047641754,-0.191489636898041),
    mineralN  = c(0.0149541581049562,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_uptk    = c(0.00110154075082392,3.98107522414648e-06,0.000193415718968026,4.75575870950706e-05,4.82684954477008e-05))
  ref_BiomeE_gsLeun_oat <- tibble(
    year            = c(1,2,8,9,16,251),
    CAI             = c(0.00383033487014472,0.00450962223112583,0.00819942075759172,0.0089819049462676,0.0171406716108322,1.15652751922607),
    LAI             = c(0.012061906978488,0.00972219835966825,0.0258209034800529,0.0282852370291948,0.0513404086232185,3.39564800262451),
    Density         = c(500,494.74462890625,463.442840576172,458.261749267578,918.901733398438,23760.080078125),
    DBH             = c(0.638946235179901,0.717453956604004,1.11637961864471,1.19524621963501,1.02929449081421,1.45303297042847),
    Density12       = c(0,0,0,0,0,24.9917449951172),
    DBH12           = c(0,0,0,0,0,21.3747997283936),
    QMD12           = c(0,0,0,0,0,21.3747978210449),
    NPP             = c(0.00188672903459519,0.00392864737659693,0.00732014887034893,0.00800003856420517,0.0142090143635869,0.971164345741272),
    GPP             = c(0.00582598941400647,0.00570838898420334,0.0126636316999793,0.0138930305838585,0.0253501199185848,1.73267769813538),
    Rauto           = c(0.00393926212564111,0.00177974288817495,0.00534348795190454,0.00589299434795976,0.0111410990357399,0.76151317358017),
    Rh              = c(0.00245671276934445,0.00224067294038832,0.00248544989153743,0.00272041140124202,0.00508538819849491,0.913783609867096),
    rain            = c(587.529663085938,587.529663085938,587.529663085938,587.529663085938,587.529663085938,587.529663085938),
    SoilWater       = c(799.997619628906,799.997619628906,799.997619628906,799.997619628906,799.997619628906,731.053649902344),
    Transp          = c(1.58682346343994,1.54753375053406,3.43921232223511,3.77336263656616,6.87999677658081,471.390258789062),
    Evap            = c(176.599166870117,176.623168945312,175.792205810547,175.648391723633,174.330139160156,99.848747253418),
    Runoff          = c(409.372680664062,409.386566162109,408.328338623047,408.135467529297,406.338348388672,15.0407629013062),
    plantC          = c(0.00856858212500811,0.0110101932659745,0.0254160854965448,0.0289349593222141,0.0626543983817101,9.67161273956299),
    soilC           = c(0.0101881846785545,0.00943439546972513,0.0146548906341195,0.0164152216166258,0.0339097157120705,39.3617134094238),
    plantN          = c(0.000265159993432462,0.00023071575560607,0.000603965658228844,0.000672495923936367,0.00126933900173753,0.0972623601555824),
    soilN           = c(0.0156189557164907,0.0155555000528693,0.0154885100200772,0.0154348835349083,0.0149154616519809,-0.0786959081888199),
    totN            = c(0.0158841162919998,0.0157862156629562,0.0160924755036831,0.0161073803901672,0.016184801235795,0.0185664519667625),
    NSC             = c(0.00177722354419529,0.00394269358366728,0.00615795096382499,0.00694745220243931,0.0143724847584963,1.18175745010376),
    SeedC           = c(0,0,0.000483855401398614,0.000698169227689505,0.000431179039878771,0.0367463864386082),
    leafC           = c(0.00205052434466779,0.00165277381893247,0.00438955379649997,0.00480849016457796,0.00872786995023489,0.577260196208954),
    rootC           = c(0.00122428347822279,0.000872367119882256,0.00262082135304809,0.00287095131352544,0.00521105108782649,0.33930104970932),
    SapwoodC        = c(0.0020817150361836,0.00166484387591481,0.00696399761363864,0.00805681198835373,0.0197972003370523,4.38915681838989),
    WoodC           = c(0.00143483537249267,0.00287751504220068,0.00479990663006902,0.00555308582261205,0.0141146080568433,3.14739060401917),
    NSN             = c(0.000189224607311189,0.000167490958119743,0.000405114697059616,0.00044419351615943,0.000870441494043916,0.0554771982133389),
    SeedN           = c(0,0,2.41927609749837e-05,3.49084657500498e-05,2.15589316212572e-05,0.00183731934521347),
    leafN           = c(3.52810748154297e-05,2.84374400507659e-05,7.55266009946354e-05,8.27347903396003e-05,0.000150171588757075,0.00993234384804964),
    rootN           = c(3.0607043299824e-05,2.18091845454182e-05,6.55204858048819e-05,7.17737420927733e-05,0.000130276122945361,0.00848250743001699),
    SapwoodN        = c(5.94775701756589e-06,4.75669639854459e-06,1.9897135643987e-05,2.30194636969827e-05,5.65634290978778e-05,0.0125404475256801),
    WoodN           = c(4.09952963309479e-06,8.22147558210418e-06,1.3714029591938e-05,1.58659677254036e-05,4.03274570999201e-05,0.00899254623800516),
    McrbC           = c(0.000244060705881566,0.000355546886567026,0.000498957117088139,0.000536960025783628,0.00094179785810411,0.103540726006031),
    fastSOM         = c(0.00863019004464149,0.00738893868401647,0.00865897629410028,0.00945140421390533,0.0172651894390583,1.67409074306488),
    SlowSOM         = c(0.00131393398623914,0.00168990984093398,0.00549695733934641,0.00642685731872916,0.0157027263194323,37.5840835571289),
    McrbN           = c(2.44060702243587e-05,3.55546872015111e-05,4.98957124364097e-05,5.36960033059586e-05,9.41797843552195e-05,0.0103540727868676),
    fastSoilN       = c(0.00056501931976527,0.000481053197290748,0.000417977687902749,0.000448278355179355,0.000800038746092469,0.0874356031417847),
    slowSoilN       = c(2.95303816528758e-05,3.88929038308561e-05,2.0636787667172e-05,-6.7090368247591e-05,-0.000978756812401116,-0.191485583782196),
    mineralN        = c(0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239,0.0149999996647239),
    N_fxed          = c(0,0,0,0,0,0),
    N_uptk          = c(3.19233095069649e-06,3.21314303164399e-07,0.000157412388944067,0.000172907326486893,0.00028531753923744,0.0168303567916155),
    N_yrMin         = c(-0.68156760931015,-0.681483685970306,-0.681664407253265,-0.681664645671844,-0.68166196346283,-0.667197227478027),
    N_P2S           = c(4.10517786804121e-05,3.44256659445819e-05,9.57487791310996e-05,0.000105227780295536,0.000193606290849857,0.0169456228613853),
    N_loss          = c(0.682522118091583,0.682522118091583,0.682521104812622,0.682521224021912,0.682520568370819,0.682251811027527),
    totseedC        = c(0,0,0,0,0.00248533301055431,0.0353716835379601),
    totseedN        = c(0,0,0,0,0.000124266938655637,0.00176858354825526),
    Seedling_C      = c(0,0,0,0,0.00248533301055431,0.0353716835379601),
    Seedling_N      = c(0,0,0,0,0.000124266953207552,0.00176858354825526),
    MaxAge          = c(0.999922752380371,2.00033664703369,7.9944634437561,8.9969425201416,16.0144596099854,139.018890380859),
    MaxVolume       = c(0.000190083810593933,0.0002481410629116,0.0006860465509817,0.000802674621809274,0.00211384077556431,0.609839200973511),
    MaxDBH          = c(0.00638946238905191,0.00717453984543681,0.0111637962982059,0.0119524616748095,0.0182092916220427,0.213747978210449),
    NPPL            = c(0.0024177273735404,1.75831144133554e-06,0.00128914858214557,0.00140485574956983,0.00275850435718894,0.140794068574905),
    NPPW            = c(0.00101654999889433,0.00106277200393379,0.00173990649636835,0.00197750912047923,0.00430274149402976,0.352771282196045),
    n_deadtrees     = c(2.78702714240353e-06,2.44736429522163e-06,6.75206683808938e-06,7.60372995500802e-06,1.55495472426992e-05,0.00491177663207054),
    c_deadtrees     = c(9.00621089385822e-05,0.00011679285671562,0.000284140463918447,0.000327159796142951,0.000774936750531197,0.415144175291061),
    m_turnover      = c(9.00621089385822e-05,0.00011679285671562,0.000284140463918447,0.000327159796142951,0.000774936750531197,0.415144175291061),
    c_turnover_time = c(1.41147541999817,2.70755624771118,2.75871539115906,2.8081214427948,3.28037548065186,8.92190170288086))
  ref_BiomeE_gsLeun_oac_yr1 <- tibble(
    cohort      = "1", 
    year        = 1, 
    cID         = 1, 
    PFT         = 2, 
    layer       = 1, 
    density     = 500, 
    flayer      = 0.00306598958559334, 
    DBH         = 0.638946235179901, 
    dDBH        = 0.0881305932998657, 
    height      = 2.87767958641052, 
    age         = 0.999922752380371,
    BA          = 3.20640610880218e-05,
    dBA         = 3.20640610880218e-05,
    Acrown      = 0.0766066983342171,
    Aleaf       = 0.241238132119179,
    nsc         = 0.0355444699525833,
    seedC       = 0.00378449214622378,
    leafC       = 0,
    rootC       = 0.0410104840993881,
    sapwC       = 0.0244856681674719,
    woodC       = 0.0416342988610268,
    nsn         = 0.0286967065185308,
    treeG       = 0.118728518486023,
    fseed       = 0,
    fleaf       = 0.407269865274429,
    froot       = 0.421490788459778,
    fwood       = 0.171239390969276,
    GPP         = 0.116519793868065,
    NPP         = 0.0377345941960812,
    Rauto       = 0.0787852257490158,
    Nupt        = 6.38466153759509e-05,
    Nfix        = 0,
    n_deadtrees = 2.78702714240353e-06,
    c_deadtrees = 9.00621089385822e-05,
    deathrate   = 0.0105107361450791)
  ref_BiomeE_gsLeun_oac_yr2 <- tibble(
    cohort      = "2", 
    year        = 2, 
    cID         = 1, 
    PFT         = 2, 
    layer       = 1, 
    density     = 494.74462890625, 
    flayer      = 0.00379007519222796, 
    DBH         = 0.717453956604004, 
    dDBH        = 0.0785077437758446, 
    height      = 3.04936408996582,
    age         = 2.00033664703369,
    BA          = 4.04276033805218e-05,
    dBA         = 8.36354229249991e-06,
    Acrown      = 0.0911504998803139,
    Aleaf       = 0.196509435772896,
    nsc         = 0.0796914920210838,
    seedC       = 0.00338540226221085,
    leafC       = 0,
    rootC       = 0.0334066040813923,
    sapwC       = 0.0176326744258404,
    woodC       = 0.0336505696177483,
    nsn         = 0.058161623775959,
    treeG       = 0.035260483622551,
    fseed       = 0,
    fleaf       = 0.00100792094599456,
    froot       = 0.389776825904846,
    fwood       = 0.609215199947357,
    GPP         = 0.115380510687828,
    NPP         = 0.0794076025485992,
    Rauto       = 0.0359729565680027,
    Nupt        = 6.49454887025058e-06,
    Nfix        = 0,
    n_deadtrees = 2.44736429522163e-06,
    c_deadtrees = 0.00011679285671562,
    deathrate   = 0.0106077026575804)
  ref_BiomeE_gsLeun_oac_yr251 <- tibble(
    cohort      = c("251","502","753","1004","1255","1506","1757","2008","2259","2510"),
    year        = c(251,251,251,251,251,251,251,251,251,251),
    cID         = c(40,117,117,185,196,205,209,213,217,221),
    PFT         = c(2,2,2,2,2,2,2,2,2,2),
    layer       = c(1,1,2,2,2,2,2,2,2,2),
    density     = c(24.9917449951172,3051.89453125,93.0557708740234,2.37667727470398,28.3467636108398,73.972900390625,305.655364990234,1402.40344238281,7120.03759765625,11657.345703125),
    flayer      = c(0.0364958606660366,0.960054218769073,0.0241257902234793,0.000103919395769481,0.000701286015100777,0.00126169121358544,0.00367818330414593,0.0112265115603805,0.0344583094120026,0.015027473680675),
    DBH         = c(21.3747978210449,7.7843017578125,6.76903343200684,2.11387372016907,1.46058881282806,1.14893805980682,0.918075323104858,0.7073073387146,0.516905009746552,0.38764163851738),
    dDBH        = c(0.211912393569946,0.16106441617012,0.0840798020362854,0.0732675194740295,0.0646425411105156,0.0594982877373695,0.0546658411622047,0.0493528321385384,0.0464871972799301,0.0749638974666595),
    height      = c(16.64381980896,10.0441303253174,9.36624526977539,5.23412847518921,4.35077476501465,3.85886263847351,3.44944357872009,3.02769613265991,2.58827567100525,2.24142980575562),
    age         = c(139.018890380859,67.9092330932617,67.3973770141602,30.2183113098145,20.86643409729,16.0075016021729,11.9977960586548,7.9880256652832,3.99460077285767,1.39321005344391),
    BA          = c(0.0358834266662598,0.00475914822891355,0.00359868002124131,0.000350952206645161,0.000167550548212603,0.000103677179140504,6.61982558085583e-05,3.92921938328072e-05,2.09851168619934e-05,1.18018679131637e-05),
    dBA         = c(0.000707976520061493,0.000190359074622393,8.88451468199492e-05,2.39066139329225e-05,1.45026715472341e-05,1.04599093901925e-05,7.64870492275804e-06,5.29197859577835e-06,3.60480953531805e-06,1.45841841003858e-06),
    Acrown      = c(14.8230457305908,3.2577691078186,2.64167976379395,0.461005508899689,0.264776736497879,0.18472295999527,0.131945297122002,0.0892255082726479,0.0557441040873528,0.0362006835639477),
    Aleaf       = c(46.6906890869141,10.2610969543457,4.1604323387146,0.497814446687698,0.285906285047531,0.199457854032516,0.142465621232986,0.0963355377316475,0.0601816363632679,0.0390721708536148),
    nsc         = c(17.2000980377197,3.5075843334198,1.37352025508881,0.265533119440079,0.145201027393341,0.0978555753827095,0.0672483444213867,0.0432897321879864,0.0264431331306696,0.0234699416905642),
    seedC       = c(0.732490420341492,0.161034971475601,0.0653149336576462,0.00474500702694058,0.00272517721168697,0.00190307002048939,0.00135923561174423,0.000918502453714609,0.00169598811771721,0.00213751173578203),
    leafC       = c(0.567994654178619,0.115359500050545,0.0129345478489995,0,0,0,0,0,0,0),
    rootC       = c(7.93741703033447,1.74438655376434,0.707273542881012,0.0846284553408623,0.0486040711402893,0.0339078344404697,0.0242191553115845,0.0163770411163568,0.0102308783680201,0.00664226897060871),
    sapwC       = c(4.73910427093506,1.04150128364563,0.422283858060837,0.025985911488533,0.014924306422472,0.010411698371172,0.00743670435622334,0.00502871442586184,0.00314148119650781,0.00203956686891615),
    woodC       = c(133.588729858398,13.0854501724243,4.87936592102051,0.231844514608383,0.0990628600120544,0.0570376440882683,0.034047469496727,0.0186871960759163,0.00908366497606039,0.00468475604429841),
    nsn         = c(92.0517730712891,9.01799964904785,11.1481018066406,0.870507121086121,0.371978223323822,0.214164033532143,0.127845630049706,0.0701730251312256,0.034114908427,0.0175981596112251),
    treeG       = c(13.1313953399658,2.82696580886841,1.13397109508514,0.138895481824875,0.0776932537555695,0.05330491065979,0.0373654589056969,0.0247106701135635,0.0156471896916628,0.0152894575148821),
    fseed       = c(0.0432547070086002,0.0408068262040615,0.0114064179360867,0,0,0,0,0,0,0),
    fleaf       = c(0.132434323430061,0.145182713866234,0.138724908232689,0.153452053666115,0.165410995483398,0.174429222941399,0.184251099824905,0.197132244706154,0.211453557014465,0.357199609279633),
    froot       = c(0.435018658638,0.446928530931473,0.44936004281044,0.228073492646217,0.23514387011528,0.239866659045219,0.245203584432602,0.251769304275513,0.250615477561951,0.0745696872472763),
    fwood       = c(0.389292359352112,0.367081969976425,0.400508642196655,0.618474423885345,0.599445164203644,0.58570408821106,0.570545256137848,0.551098465919495,0.537930965423584,0.568230748176575),
    GPP         = c(24.0496978759766,5.24036979675293,2.07000660896301,0.264297813177109,0.150635629892349,0.104455828666687,0.0741392374038696,0.0497130304574966,0.0305801462382078,0.0186414308845997),
    NPP         = c(13.39381980896,2.94410991668701,1.14456343650818,0.153608128428459,0.0883700549602509,0.0615964792668819,0.0439721159636974,0.0296694505959749,0.0180348288267851,0.00809822138398886),
    Rauto       = c(10.6558752059937,2.29626059532166,0.925443947315216,0.110689707100391,0.0622656010091305,0.042859323322773,0.0301671270281076,0.0200435854494572,0.0125453155487776,0.0105432132259011),
    Nupt        = c(0.226463928818703,0.0525825135409832,0.0179873835295439,0.00164998578839004,0.000990381464362144,0.0007167948060669,0.000529507698956877,0.000176085217390209,0,0),
    Nfix        = c(0,0,0,0,0,0,0,0,0,0),
    n_deadtrees = c(0.000451631844043732,0.00276859058067203,0.000119085001642816,5.15107160481421e-07,3.91209960071137e-06,7.43757527743583e-06,2.25572257477324e-05,7.14058987796307e-05,0.000500370748341084,0.000966270570643246),
    c_deadtrees = c(0.0696461498737335,0.276003122329712,0.0164205525070429,7.61558767408133e-05,0.000503623043186963,0.000873036391567439,0.0024265053216368,0.00694022234529257,0.020028056576848,0.0222267899662256),
    deathrate   = c(0.108821861445904,0.031718485057354,0.0951597318053246,0.216726556420326,0.261360436677933,0.285504907369614,0.304401010274887,0.32228085398674,0.338847905397415,0.350268691778183))
  
  expect_equal(tibble(mod_BiomeE_Pmodel$output_daily_tile )|>filter(year==  1, doy %in% c(1, 2, 180, 364, 365)),  ref_BiomeE_Pmodel_odt_yr1)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_daily_tile )|>filter(year==251, doy %in% c(1, 2, 180, 364, 365)),  ref_BiomeE_Pmodel_odt_yr251)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_tile)|>filter(           year %in% c(1, 2, 8, 9, 16, 251)), ref_BiomeE_Pmodel_oat)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_cohorts)|>filter(year==  1),                                ref_BiomeE_Pmodel_oac_yr1)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_cohorts)|>filter(year==  2),                                ref_BiomeE_Pmodel_oac_yr2)
  expect_equal(tibble(mod_BiomeE_Pmodel$output_annual_cohorts)|>filter(year==251),                                ref_BiomeE_Pmodel_oac_yr251)

  expect_equal(tibble(mod_BiomeE_gsLeun$output_daily_tile )|>filter(year==  1, doy %in% c(1, 2, 180, 364, 365)),  ref_BiomeE_gsLeun_odt_yr1)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_daily_tile )|>filter(year==251, doy %in% c(1, 2, 180, 364, 365)),  ref_BiomeE_gsLeun_odt_yr251)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_tile)|>filter(           year %in% c(1, 2, 8, 9, 16, 251)), ref_BiomeE_gsLeun_oat)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_cohorts)|>filter(year==  1),                                ref_BiomeE_gsLeun_oac_yr1)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_cohorts)|>filter(year==  2),                                ref_BiomeE_gsLeun_oac_yr2)
  expect_equal(tibble(mod_BiomeE_gsLeun$output_annual_cohorts)|>filter(year==251),                                ref_BiomeE_gsLeun_oac_yr251)
  
})



<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sensitivity analysis • rsofun</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Sensitivity analysis">
<meta property="og:description" content="rsofun">
<meta name="twitter:card" content="summary">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>rsofun <small>v4.4</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/biomee_model_structure.html">BiomeE model structure</a>
    </li>
    <li>
      <a href="../articles/biomee_use.html">BiomeE usage</a>
    </li>
    <li>
      <a href="../articles/new_cost_function.html">Parameter calibration and cost functions</a>
    </li>
    <li>
      <a href="../articles/pmodel_use.html">P-model usage</a>
    </li>
    <li>
      <a href="../articles/prepare_forcing.html">Prepare forcing</a>
    </li>
    <li>
      <a href="../articles/sensitivity_analysis.html">Sensitivity analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/geco-bern/rsofun/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Sensitivity analysis</h1>
                        <h4 data-toc-skip class="author">Pepa Aran</h4>
            
            <h4 data-toc-skip class="date">2023-04-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/geco-bern/rsofun/blob/HEAD/vignettes/sensitivity_analysis.Rmd" class="external-link"><code>vignettes/sensitivity_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>sensitivity_analysis.Rmd</code></div>

    </div>

    
    
<p>Parameter calibration can have a big impact on our modeling effort
and use big computational resources. Hence, it is worth our time to
explore which parameters should actually be calibrated (the ones that
impact the simulations greatly) and to examine if the calibration
routines behave as expected. This vignette explains how to perform a
simple parameter sensitivity analysis for the P-model and how to
interpret the outputs of the calibration using the
<code>BayesianTools</code> package.</p>
<div class="section level2">
<h2 id="morris-sensitivity-analysis">Morris sensitivity analysis<a class="anchor" aria-label="anchor" href="#morris-sensitivity-analysis"></a>
</h2>
<p>The Morris method for global sensitivity analysis allows to explore
which parameters have the biggest influence on the model fit. In this
example, we will quantify how different values of the calibratable model
parameters lead to more variability in the match between GPP predicted
by the P-model and GPP observations. It would be wise to repeat this
exercise for various targets because they may be simulated by equations
in the P-model that involve different model parameters.</p>
<p>If the P-model has very low sensitivity to a certain parameter,
calibrating it will not improve the model substantially. But if it’s
very sensitive to another parameter, calibrating this second parameter
could improve the P-model fit greatly. We should spend our computational
resources on calibrating the parameters to which the model is most
sensitive.</p>
<p>First of all, let’s define a function which measures the agreement
between GPP predictions from the P-model and GPP observations, for a set
of values of the calibratable parameters. It computes the normal
log-likelihood of the GPP predictions, given the observed GPP and its
uncertainty. We want to see how sensitive this function is to changes in
the parameter values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define log-likelihood function</span></span>
<span><span class="va">ll_pmodel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">par_v</span>                 <span class="co"># a vector of all calibratable parameters including errors</span></span>
<span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">rsofun</span><span class="fu">::</span><span class="fu"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span><span class="op">(</span>        <span class="co"># reuse likelihood cost function</span></span>
<span>    <span class="va">par_v</span>,</span>
<span>    obs <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_validation.html">p_model_validation</a></span>,</span>
<span>    drivers <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_drivers.html">p_model_drivers</a></span>,</span>
<span>    targets <span class="op">=</span> <span class="st">"gpp"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute log-likelihood for a given set of parameters</span></span>
<span><span class="fu">ll_pmodel</span><span class="op">(</span> par_v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">0.09423773</span>, <span class="co"># setup ORG in Stocker et al. 2020 GMD</span></span>
<span>  kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,        <span class="co"># set to zero to disable temperature-dependence of kphio, setup ORG in Stocker et al. 2020 GMD</span></span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover old setup with soil moisture stress</span></span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>,</span>
<span>  error_gpp          <span class="op">=</span> <span class="fl">0.9</span>         <span class="co"># value from previous simulations</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -56672.71</span></span></code></pre></div>
<p>Some parameters are constrained by their physical interpretation
(e.g. <code>kphio &gt; 0</code>) and it’s also necessary to provide a
bounded parameter space for Morris’ method to sample the parameter
space. We define the parameter space by their lower and upper
bounds.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># best parameter values (from previous literature)</span></span>
<span><span class="va">par_cal_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">25</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span><span class="op">*</span><span class="fl">240</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>,</span>
<span>    error_gpp          <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># lower bound</span></span>
<span><span class="va">par_cal_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">50.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">7.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    error_gpp          <span class="op">=</span> <span class="fl">0.01</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># upper bound</span></span>
<span><span class="va">par_cal_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">5.0</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">40.0</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">200.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">60.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    error_gpp          <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We use the <code>morris()</code> function from the
<code>{sensitivity}</code> package to perform the sensitivity analysis.
As a target function, we will use the posterior density (log-likelihood)
of the parameters given the GPP data which we obtain via the function
<code><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html" class="external-link">BayesianTools::createBayesianSetup()</a></code>. Note that, because of
using a uniform prior, the posterior distribution is proportional to the
GPP log-likelihood (defined previously) wherever the parameter values
are feasible and zero outside of the parameter ranges.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">morris_setup</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html" class="external-link">createBayesianSetup</a></span><span class="op">(</span></span>
<span>  likelihood <span class="op">=</span> <span class="va">ll_pmodel</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createUniformPrior.html" class="external-link">createUniformPrior</a></span><span class="op">(</span><span class="va">par_cal_min</span>, <span class="va">par_cal_max</span>, <span class="va">par_cal_best</span><span class="op">)</span>,</span>
<span>  names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In the following chunk, we run the Morris sensitivity analysis, using
a grid with <code>r=500</code> values for each parameter and a
one-at-a-time design. Running the sensitivity analysis may take a few
minutes, even for this small example dataset, and is still
computationally cheaper than running the parameter calibration.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">432</span><span class="op">)</span></span>
<span><span class="va">morrisOut</span> <span class="op">&lt;-</span> <span class="fu">sensitivity</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/morris.html" class="external-link">morris</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">morris_setup</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">density</span>,</span>
<span>  factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span>, </span>
<span>  r <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>  design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"oat"</span>, levels <span class="op">=</span> <span class="fl">20</span>, grid.jump <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, </span>
<span>  binf <span class="op">=</span> <span class="va">par_cal_min</span>, </span>
<span>  bsup <span class="op">=</span> <span class="va">par_cal_max</span>, </span>
<span>  scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The analysis evaluates the variability of the target function,
i.e. the log-likelihood, for several points across the parameter space.
Statistics <span class="math inline">\(\mu *\)</span> and <span class="math inline">\(\sigma\)</span> measure the average of the
absolute differences between these log-likelihood values and their
standard deviation, respectively. The higher the value of these
statistics for a given parameter, the more influential the parameter
is.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summarise the morris output</span></span>
<span><span class="va">morrisOut.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span>,</span>
<span>  mu.star <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">morrisOut</span><span class="op">$</span><span class="va">ee</span><span class="op">)</span>, <span class="fl">2</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">morrisOut</span><span class="op">$</span><span class="va">ee</span>, <span class="fl">2</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span> <span class="va">mu.star</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">morrisOut.df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span> <span class="op">-</span><span class="va">parameter</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">value</span><span class="op">)</span>,</span>
<span>    <span class="va">value</span>, </span>
<span>    fill <span class="op">=</span> <span class="va">variable</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span><span class="st">""</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mu.star'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">*</span> <span class="st">"*"</span><span class="op">)</span>,</span>
<span>                                   <span class="st">'sigma'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span>, legend.justification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="interpretation-of-bayesian-calibration-routine">Interpretation of Bayesian calibration routine<a class="anchor" aria-label="anchor" href="#interpretation-of-bayesian-calibration-routine"></a>
</h2>
<p>It is always important to check the convergence of the MCMC algorithm
used for the Bayesian calibration. Here we show some plots and
statistics that may help you assess whether the parameter calibration
has converged.</p>
<p>According to the previous sensitivity analysis, calibrating the error
parameter for GPP and the Jmax cost ratio parameters will have the most
impact on the model fit. Let’s run the calibration:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define calibration settings</span></span>
<span><span class="va">settings_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"BayesianTools"</span>,</span>
<span>  metric <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler <span class="op">=</span> <span class="st">"DEzs"</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">300</span>,</span>
<span>      iterations <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>      startValue <span class="op">=</span> <span class="fl">3</span>       <span class="co"># number of chains to be sampled</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kc_jmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.2</span>, upper <span class="op">=</span> <span class="fl">0.8</span>, init <span class="op">=</span> <span class="fl">0.41</span><span class="op">)</span>,</span>
<span>    err_gpp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">3</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calibrate parameters kc_jmax and err_gpp </span></span>
<span><span class="va">par_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_calib</span>,</span>
<span>  par_fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    kphio_par_a <span class="op">=</span> <span class="op">-</span><span class="fl">0.0001</span>,</span>
<span>    kphio_par_b <span class="op">=</span> <span class="fl">33</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span><span class="op">*</span><span class="fl">240</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span><span class="op">)</span>,</span>
<span>  targets <span class="op">=</span> <span class="st">"gpp"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>BayesianTools</code> makes it easy to produce the trace plot of
the MCMC chains and the posterior density plot for the parameters. Trace
plots show the time series of the sampled chains, which should reach a
stationary state. One can also choose a burnin visually, to discard the
early iterations and keep only the samples from the stationary
distribution to which they converge (we set above). The samples after
the burnin period are then used for inference.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># par(mar = c(2,2,2,2))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The posterior density plots may be lumpy. In this case it’s advisable
to run the MCMC algorithm for more iterations, in order to get a better
estimate of the parameters’ posterior distributions. A good posterior
should look more gaussian (although it can be skewed). A multimodal
density indicates that the MCMC is still exploring the parameter space
and hasn’t converged yet.</p>
<p>When convergence has been reached, the oscillation of the time series
should look like white noise. The presence of a trend indicates that
convergence hasn’t been reached.</p>
<p>Trace plots can be deceiving and partial autocorrelation plots can
throw some light. If autocorrelation is present, this can mean that the
sampling is stuck in local maxima and the posterior parameter space may
not be explored fully.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define function for plotting chains separately</span></span>
<span><span class="va">plot_acf_mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">chains</span>, <span class="va">par_names</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># chains: from the BayesianTools output</span></span>
<span>  <span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">chains</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par_names</span><span class="op">)</span>, <span class="va">n_chains</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">par_name</span> <span class="kw">in</span> <span class="va">par_names</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">chains</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="va">par_name</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">pacf</a></span><span class="op">(</span>main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Series of "</span>, <span class="va">par_name</span>, <span class="st">" , chain "</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">plot_acf_mcmc</span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">$</span><span class="va">chain</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"err_gpp"</span>, <span class="st">"kc_jmax"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Looking at the correlation between chains is also helpful because
parameter correlation may slow down convergence, or the chains may
oscillate in the multivariate posterior space. Here the correlation is
very small and we saw above that the chains reached a stationary
distribution quite quickly.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">correlationPlot</span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-14-1.png" width="480" style="display: block; margin: auto;"></p>
<p>In addition to visualizations, it’s helpful to compute some
convergence diagnostics, like the Gelman-Brooks-Rubin (GBR) “potential
scale factor” (psf). This diagnostic compares the variance within chains
to that across chains and should progressively get closer to 1. It is
common in the literature to accept a GBR between 1.05 and 1.1,
indicating convergence.</p>
<p>We use the <code>summary</code> function from the
<code>BayesianTools</code> library, which shows the psf next to other
parameter estimations. Finally, the parameter MAP estimates can be
derived from the chains (that converged) after removing the burnin
period.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in</span></span>
<span><span class="co">#&gt; dplyr 1.1.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `reframe()` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> When switching from `summarise()` to `reframe()`, remember that `reframe()`</span></span>
<span><span class="co">#&gt;   always returns an ungrouped data frame and adjust accordingly.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">rsofun</span> package.</span></span>
<span><span class="co">#&gt;   Please report the issue at <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/geco-bern/rsofun/issues&gt;</span>.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt; # # # # # # # # # # # # # # # # # # # # # # # # # </span></span>
<span><span class="co">#&gt; ## MCMC chain summary ## </span></span>
<span><span class="co">#&gt; # # # # # # # # # # # # # # # # # # # # # # # # # </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; # MCMC sampler:  DEzs </span></span>
<span><span class="co">#&gt; # Nr. Chains:  3 </span></span>
<span><span class="co">#&gt; # Iterations per chain:  901 </span></span>
<span><span class="co">#&gt; # Rejection rate:  0.791 </span></span>
<span><span class="co">#&gt; # Effective sample size:  275 </span></span>
<span><span class="co">#&gt; # Runtime:  114.502  sec. </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; # Parameters</span></span>
<span><span class="co">#&gt;           psf   MAP  2.5% median 97.5%</span></span>
<span><span class="co">#&gt; kc_jmax 1.003 0.388 0.367  0.388 0.407</span></span>
<span><span class="co">#&gt; err_gpp 1.003 2.176 2.113  2.172 2.236</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ## DIC:  10969.53 </span></span>
<span><span class="co">#&gt; ## Convergence </span></span>
<span><span class="co">#&gt;  Gelman Rubin multivariate psrf:   </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; ## Correlations </span></span>
<span><span class="co">#&gt;         kc_jmax err_gpp</span></span>
<span><span class="co">#&gt; kc_jmax   1.000  -0.031</span></span>
<span><span class="co">#&gt; err_gpp  -0.031   1.000</span></span></code></pre></div>
<p>More details on diagnosing MCMC convergence can be found in <a href="https://florianhartig.github.io/BayesianTools/articles/BayesianTools.html#running-mcmc-and-smc-functions" class="external-link">this
vignette from BayesianTools</a> and <a href="https://theoreticalecology.wordpress.com/2011/12/09/mcmc-chain-analysis-and-convergence-diagnostics-with-coda-in-r/" class="external-link">this
blogpost</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>

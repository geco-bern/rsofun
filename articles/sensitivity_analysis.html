<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sensitivity analysis and calibration interpretation • rsofun</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Sensitivity analysis and calibration interpretation">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>rsofun <small>v5.1.0.9000</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/geco-bern/rsofun/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Sensitivity analysis and calibration
interpretation</h1>
                        <h4 data-toc-skip class="author">Josefa
Arán</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/geco-bern/rsofun/blob/master/vignettes/sensitivity_analysis.Rmd" class="external-link"><code>vignettes/sensitivity_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>sensitivity_analysis.Rmd</code></div>

    </div>

    
    
<p>Parameter calibration can have a big impact on our modeling effort
and use big computational resources. Hence, it is worth our time to
explore which parameters should actually be calibrated (the ones that
impact the simulations greatly) and to examine if the calibration
routines behave as expected. This vignette explains how to perform a
simple parameter sensitivity analysis for the P-model and how to
interpret the outputs of the calibration using the
<code>BayesianTools</code> package.</p>
<div class="section level2">
<h2 id="morris-sensitivity-analysis">Morris sensitivity analysis<a class="anchor" aria-label="anchor" href="#morris-sensitivity-analysis"></a>
</h2>
<p>The Morris method for global sensitivity analysis allows to explore
which parameters have the biggest influence on the model fit. In this
example, we will quantify how different values of the calibratable model
parameters lead to more variability in the match between GPP predicted
by the P-model and GPP observations. It would be wise to repeat this
exercise for various targets because they may be simulated by equations
in the P-model that involve different model parameters.</p>
<p>If the P-model has very low sensitivity to a certain parameter,
calibrating it will not improve the model substantially. But if it’s
very sensitive to another parameter, calibrating this second parameter
could improve the P-model fit greatly. We should spend our computational
resources on calibrating the parameters to which the model is most
sensitive.</p>
<p>First of all, let’s define a function which measures the agreement
between GPP predictions from the P-model and GPP observations, for a set
of values of the calibratable parameters. It computes the normal
log-likelihood of the GPP predictions, given the observed GPP and its
uncertainty. We want to see how sensitive this function is to changes in
the parameter values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define log-likelihood function</span></span>
<span><span class="va">ll_pmodel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">par_v</span>                 <span class="co"># a named vector of all calibratable parameters including errors</span></span>
<span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">rsofun</span><span class="fu">::</span><span class="fu"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span><span class="op">(</span>        <span class="co"># reuse likelihood cost function</span></span>
<span>    <span class="va">par_v</span>,</span>
<span>    obs <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_validation.html">p_model_validation</a></span>,</span>
<span>    drivers <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_drivers.html">p_model_drivers</a></span>,</span>
<span>    targets <span class="op">=</span> <span class="st">"gpp"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute log-likelihood for a given set of parameters</span></span>
<span><span class="fu">ll_pmodel</span><span class="op">(</span> par_v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">4.102119e-02</span>,</span>
<span>  kphio_par_a        <span class="op">=</span><span class="op">-</span><span class="fl">2.289344e-03</span>,</span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">1.525094e+01</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">1.577507e+02</span>,</span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">1.169702e-04</span>,</span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">20.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>,</span>
<span>  error_gpp          <span class="op">=</span> <span class="fl">0.9</span>         <span class="co"># value from previous simulations</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -2758.147</span></span></code></pre></div>
<p>Some parameters are constrained by their physical interpretation
(e.g. <code>kphio &gt; 0</code>) and it’s also necessary to provide a
bounded parameter space for Morris’ method to sample the parameter
space. We define the parameter space by their lower and upper
bounds.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># best parameter values (initial values, taken from Stocker et al., 2020 GMD)</span></span>
<span><span class="va">par_cal_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>  kphio_par_a        <span class="op">=</span> <span class="op">-</span><span class="fl">0.0025</span>,</span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span><span class="op">*</span><span class="fl">240</span>,</span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>,</span>
<span>  error_gpp          <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lower bound</span></span>
<span><span class="va">par_cal_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>  kphio_par_a        <span class="op">=</span> <span class="op">-</span><span class="fl">0.004</span>,</span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">50.0</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">7.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  error_gpp          <span class="op">=</span> <span class="fl">0.01</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># upper bound</span></span>
<span><span class="va">par_cal_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  kphio_par_a        <span class="op">=</span> <span class="op">-</span><span class="fl">0.001</span>,</span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">240</span>,</span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">200.0</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">60.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  error_gpp          <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We use the <code>morris()</code> function from the
<code>{sensitivity}</code> package to perform the sensitivity analysis.
As a target function, we will use the posterior density (log-likelihood)
of the parameters given the GPP data which we obtain via the function
<code><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html" class="external-link">BayesianTools::createBayesianSetup()</a></code>. Note that, because of
using a uniform prior, the posterior distribution is proportional to the
GPP log-likelihood (defined previously) wherever the parameter values
are feasible and zero outside of the parameter ranges.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">morris_setup</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createBayesianSetup.html" class="external-link">createBayesianSetup</a></span><span class="op">(</span></span>
<span>  likelihood <span class="op">=</span> <span class="va">ll_pmodel</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/createUniformPrior.html" class="external-link">createUniformPrior</a></span><span class="op">(</span><span class="va">par_cal_min</span>, <span class="va">par_cal_max</span>, <span class="va">par_cal_best</span><span class="op">)</span>,</span>
<span>  names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In the following chunk, we run the Morris sensitivity analysis, using
a grid with <code>r=1000</code> values for each parameter and a
one-at-a-time design. Running the sensitivity analysis may take a few
minutes, even for this small example dataset, and is still
computationally cheaper than running the parameter calibration.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">432</span><span class="op">)</span></span>
<span><span class="va">morrisOut</span> <span class="op">&lt;-</span> <span class="fu">sensitivity</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sensitivity/man/morris.html" class="external-link">morris</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">morris_setup</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">density</span>,</span>
<span>  factors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span>, </span>
<span>  r <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>  design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"oat"</span>, levels <span class="op">=</span> <span class="fl">20</span>, grid.jump <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, </span>
<span>  binf <span class="op">=</span> <span class="va">par_cal_min</span>, </span>
<span>  bsup <span class="op">=</span> <span class="va">par_cal_max</span>, </span>
<span>  scale <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The analysis evaluates the variability of the target function,
i.e. the log-likelihood, for several points across the parameter space.
It is an approximation of the derivatives of the log-likelihood with
respect to the model parameters. Statistics
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>*</mo></mrow><annotation encoding="application/x-tex">\mu *</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
can be interpreted as the mean absolute derivative and the standard
deviation of the derivative, respectively. The higher the value of these
statistics for a given parameter, the more influential the parameter
is.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarise the morris output</span></span>
<span><span class="va">morrisOut.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_cal_best</span><span class="op">)</span>,</span>
<span>  mu.star <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">morrisOut</span><span class="op">$</span><span class="va">ee</span><span class="op">)</span>, <span class="fl">2</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">morrisOut</span><span class="op">$</span><span class="va">ee</span>, <span class="fl">2</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span> <span class="va">mu.star</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">morrisOut.df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span> <span class="op">-</span><span class="va">parameter</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">value</span><span class="op">)</span>,</span>
<span>    <span class="va">value</span>, </span>
<span>    fill <span class="op">=</span> <span class="va">variable</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">'identity'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="st">""</span>, </span>
<span>                    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mu.star'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">*</span> <span class="st">"*"</span><span class="op">)</span>,</span>
<span>                               <span class="st">'sigma'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mu.star'</span> <span class="op">=</span> <span class="st">"#29a274ff"</span>, </span>
<span>                               <span class="st">'sigma'</span> <span class="op">=</span> <span class="st">"#777055ff"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span><span class="op">)</span>, legend.justification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># make horizontal</span></span>
<span><span class="co">#&gt; Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2</span></span>
<span><span class="co">#&gt; 3.5.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use the `legend.position.inside` argument of `theme()` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The outcome of the Morris sensitivity analysis depends strongly on
the choice of parameter ranges and how parameters interact with each
other in the underlying model. In this example, we constrained the
parameters based on their physical meaning
(e.g. <code>soilm_betao</code> should be in <code>[0,1]</code>) and the
site FR-Pue where the data is coming from (e.g. <code>kphio_par_b</code>
around
25<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi></mi><mi>o</mi></msup><annotation encoding="application/x-tex">^{o}</annotation></semantics></math>C).
When observing the figure above, we notice that parameters
<code>kphio</code> and <code>kc_jmax</code> have a high impact on the
model fit (big
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>*</mo></mrow><annotation encoding="application/x-tex">\mu *</annotation></semantics></math>),
but also the magnitude of this dependence of GPP on the two parameters
changes across the parameter space (big
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>).
This happens because parameters interact in the light use efficiency
calculation and the calibration may be harder and require data from
several sites.</p>
<p>The log-likelihood is most sensitive to <code>err_gpp</code> with a
very large variation in the magnitude of this dependence. This makes
sense because for higher values of the standard deviation the normal
likelihood is flatter (and similar log-likelihood values are calculated,
whether the model predictions using the rest of parameters are good or
bad) and for lower <code>err_gpp</code> values the likelihood is pointy
(hence good model fits achieve a big log-likelihood value and and poor
model fits, a very small value).</p>
<p>To help you interpret this sensitivity analysis and better understand
the parameter-model relationship, it may be wise to run it several times
for different parameter ranges and validation data. Note how
<code>rd_to_vcmax</code> does not affect GPP, but it would actually
affect dark respiration predictions, so trait data could also be added
for validation.</p>
</div>
<div class="section level2">
<h2 id="interpretation-of-bayesian-calibration-routine">Interpretation of Bayesian calibration routine<a class="anchor" aria-label="anchor" href="#interpretation-of-bayesian-calibration-routine"></a>
</h2>
<p>It is always important to check the convergence of the MCMC algorithm
used for the Bayesian calibration. Here we show some plots and
statistics that may help you assess whether the parameter calibration
has converged.</p>
<p>According to the previous sensitivity analysis, calibrating the error
parameter for GPP and the quantum yield efficiency parameters will have
a high impact on the model fit. Let’s run the calibration:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calibrates kphio, kphio_par_b, kc_jmax - top 3 model params</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define calibration settings</span></span>
<span><span class="va">settings_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"BayesianTools"</span>,</span>
<span>  metric <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler <span class="op">=</span> <span class="st">"DEzs"</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">12000</span>,</span>
<span>      iterations <span class="op">=</span> <span class="fl">24000</span>,</span>
<span>      nrChains <span class="op">=</span> <span class="fl">3</span>,       <span class="co"># number of independent chains</span></span>
<span>      startValue <span class="op">=</span> <span class="fl">3</span>      <span class="co"># number of internal chains to be sampled</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.02</span>, upper <span class="op">=</span> <span class="fl">0.15</span>, init <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    kphio_par_a <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">0.004</span>, upper <span class="op">=</span> <span class="op">-</span><span class="fl">0.001</span>, init <span class="op">=</span> <span class="op">-</span><span class="fl">0.0025</span><span class="op">)</span>,</span>
<span>    kphio_par_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">30</span>, init <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>    soilm_thetastar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      lower <span class="op">=</span> <span class="fl">0.01</span> <span class="op">*</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_drivers.html">p_model_drivers</a></span><span class="op">$</span><span class="va">site_info</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">whc</span>,</span>
<span>      upper <span class="op">=</span> <span class="fl">1.0</span>  <span class="op">*</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_drivers.html">p_model_drivers</a></span><span class="op">$</span><span class="va">site_info</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">whc</span>,</span>
<span>      init  <span class="op">=</span> <span class="fl">0.6</span>  <span class="op">*</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/p_model_drivers.html">p_model_drivers</a></span><span class="op">$</span><span class="va">site_info</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">whc</span></span>
<span>    <span class="op">)</span>,</span>
<span>    soilm_betao <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.0</span>, upper <span class="op">=</span> <span class="fl">1.0</span>, init <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span>,</span>
<span>    err_gpp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">3</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">par_fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>  kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">20.0</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate kphio-related parameters and err_gpp</span></span>
<span><span class="va">par_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_calib</span>,</span>
<span>  par_fixed <span class="op">=</span> <span class="va">par_fixed</span>,</span>
<span>  targets <span class="op">=</span> <span class="st">"gpp"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">par_calib</span>, <span class="st">"files/sensitivity_analysis.Rmd__par_calib.RDS"</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This code takes 15 minutes to run</span></span></code></pre></div>
<p><code>BayesianTools</code> makes it easy to produce the trace plot of
the MCMC chains and the posterior density plot for the parameters. Trace
plots show the time series of the sampled chains, which should reach a
stationary state. One can also choose a burnin visually, to discard the
early iterations and keep only the samples from the stationary
distribution to which they converge. We set above from previous runs,
and those iterations are not shown by the following trace plot. The
samples after the burnin period should be used for inference.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-7-2.png" width="672" style="display: block; margin: auto;"></p>
<!-- Internal recommendation: When you run the MCMC simulations with the DEzs sampler, there are two parameters that control the number of chains used: nrChains (documented for runMCMC) and startValue (documented for DEzs). The first dictates the number of independent chains to be run by the algorithm, while the second determines the number of internal chains to be run from a starting population (i.e. a population of initial parameter seeds). As Florian points out in this issue (https://github.com/florianhartig/BayesianTools/issues/224#issuecomment-877416919) the chains from within a population tend to be more correlated than those from independent "chains", and therefore internal chains should not be regarded as independent chains. This supports why for r3PG, they use nrChains=3 and startValue=3 (used by default), leading to 3*3=9 chains being plotted. For the example above, it doesn't make a big difference because the convergence is quite fast. -->
<p>The posterior density plots may be lumpy. In this case it’s advisable
to run the MCMC algorithm for more iterations, in order to get a better
estimate of the parameters’ posterior distributions. A good posterior
should look more gaussian (although it can be skewed). A multimodal
density indicates that the MCMC is still exploring the parameter space
and hasn’t converged yet. The posteriors can be plotted against the
priors using <code><a href="https://rdrr.io/pkg/BayesianTools/man/marginalPlot.html" class="external-link">BayesianTools::marginalPlot()</a></code>.</p>
<p>When convergence has been reached, the oscillation of the time series
should look like white noise. It’s normal that consecutive MCMC samples
are correlated because of the sampling algorithm’s nature, but the
presence of a more general trend indicates that convergence hasn’t been
reached.</p>
<!-- Furthermore, trace plots can be deceiving and partial autocorrelation plots can throw some light. If autocorrelation is present, this can mean that the sampling is stuck in local maxima and the posterior parameter space may not be explored fully. Sometimes, thinning is used to deal with this autocorrelation. -->
<p>Looking at the correlation between chains for different parameters is
also helpful because parameter correlation may slow down convergence, or
the chains may oscillate in the multivariate posterior space. In this
calibration we expect parameter samples to be somewhat correlated,
especially <code>kphio_par_a</code> and <code>kphio_par_b</code> because
they specify the shape of the temperature dependence of the quantum
yield efficiency,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>φ</mi><mi>o</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\varphi_o(T)</annotation></semantics></math>.
We can also see that <code>err_gpp</code> is correlated with
<code>kphio</code> (to which the P-model is very sensitive), since the
error represents how good the model fits the observed GPP.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">correlationPlot</span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span>, thin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>   <span class="co"># use all samples, no thinning</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-9-1.png" width="480" style="display: block; margin: auto;"></p>
<p>In addition to visualizations, it’s helpful to compute some
convergence diagnostics, like the Gelman-Brooks-Rubin (GBR) potential
scale factors. This diagnostic compares the variance within chains to
that across chains and should progressively get closer to 1. It is
common in the literature (Gelman, A., Carlin, J.B., Stern, H.S., Rubin,
D.B.: Bayesian Data Analysis, 2nd edn. Chapman &amp; Hall, London
(2004)) to accept convergence with a GBR between 1.05 and 1.1.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gelmanDiagnostics</span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; Potential scale reduction factors:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                 Point est. Upper C.I.</span></span>
<span><span class="co">#&gt; kphio                 1.01       1.02</span></span>
<span><span class="co">#&gt; kphio_par_a           1.01       1.01</span></span>
<span><span class="co">#&gt; kphio_par_b           1.00       1.01</span></span>
<span><span class="co">#&gt; soilm_thetastar       1.02       1.04</span></span>
<span><span class="co">#&gt; soilm_betao           1.02       1.04</span></span>
<span><span class="co">#&gt; err_gpp               1.02       1.03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Multivariate psrf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1.03</span></span></code></pre></div>
<p>Finally, the parameter MAP estimates can be derived from the chains
(that converged) after removing the burnin period. They can be seen,
next to other statistics, using the <code>summary</code> function from
the <code>BayesianTools</code> library.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; # # # # # # # # # # # # # # # # # # # # # # # # # </span></span>
<span><span class="co">#&gt; ## MCMC chain summary ## </span></span>
<span><span class="co">#&gt; # # # # # # # # # # # # # # # # # # # # # # # # # </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; # MCMC sampler:  DEzs </span></span>
<span><span class="co">#&gt; # Nr. Chains:  9 </span></span>
<span><span class="co">#&gt; # Iterations per chain:  4001 </span></span>
<span><span class="co">#&gt; # Rejection rate:  0.849 </span></span>
<span><span class="co">#&gt; # Effective sample size:  3377 </span></span>
<span><span class="co">#&gt; # Runtime:  1301.851  sec. </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; # Parameters</span></span>
<span><span class="co">#&gt;                   psf     MAP    2.5%  median   97.5%</span></span>
<span><span class="co">#&gt; kphio           1.010   0.041   0.040   0.041   0.042</span></span>
<span><span class="co">#&gt; kphio_par_a     1.006  -0.002  -0.003  -0.002  -0.002</span></span>
<span><span class="co">#&gt; kphio_par_b     1.004  15.251  14.888  15.350  15.803</span></span>
<span><span class="co">#&gt; soilm_thetastar 1.021 157.751 151.926 160.060 168.101</span></span>
<span><span class="co">#&gt; soilm_betao     1.021   0.000   0.000   0.008   0.038</span></span>
<span><span class="co">#&gt; err_gpp         1.016   1.074   1.040   1.074   1.111</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ## DIC:  5561.961 </span></span>
<span><span class="co">#&gt; ## Convergence </span></span>
<span><span class="co">#&gt;  Gelman Rubin multivariate psrf:  1.034 </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; ## Correlations </span></span>
<span><span class="co">#&gt;                  kphio kphio_par_a kphio_par_b soilm_thetastar soilm_betao</span></span>
<span><span class="co">#&gt; kphio            1.000      -0.097       0.287           0.236       0.236</span></span>
<span><span class="co">#&gt; kphio_par_a     -0.097       1.000      -0.201           0.116       0.000</span></span>
<span><span class="co">#&gt; kphio_par_b      0.287      -0.201       1.000           0.301       0.189</span></span>
<span><span class="co">#&gt; soilm_thetastar  0.236       0.116       0.301           1.000       0.128</span></span>
<span><span class="co">#&gt; soilm_betao      0.236       0.000       0.189           0.128       1.000</span></span>
<span><span class="co">#&gt; err_gpp          0.229      -0.002       0.098           0.042       0.147</span></span>
<span><span class="co">#&gt;                 err_gpp</span></span>
<span><span class="co">#&gt; kphio             0.229</span></span>
<span><span class="co">#&gt; kphio_par_a      -0.002</span></span>
<span><span class="co">#&gt; kphio_par_b       0.098</span></span>
<span><span class="co">#&gt; soilm_thetastar   0.042</span></span>
<span><span class="co">#&gt; soilm_betao       0.147</span></span>
<span><span class="co">#&gt; err_gpp           1.000</span></span></code></pre></div>
<p>More details on diagnosing MCMC convergence can be found in <a href="https://florianhartig.github.io/BayesianTools/articles/BayesianTools.html#running-mcmc-and-smc-functions" class="external-link">this
vignette from BayesianTools</a> and <a href="https://theoreticalecology.wordpress.com/2011/12/09/mcmc-chain-analysis-and-convergence-diagnostics-with-coda-in-r/" class="external-link">this
blogpost</a>.</p>
<div class="section level3">
<h3 id="plotting-p-model-output-after-calibration">Plotting P-model output after calibration<a class="anchor" aria-label="anchor" href="#plotting-p-model-output-after-calibration"></a>
</h3>
<p>After we have run and checked the calibration, let’s see how the
model performs.</p>
<p>To compute the credible intervals for GPP prediction, we ran the
P-model for 600 samples from the posterior distribution of the
calibrated parameters. As a result, we obtain the posterior distribution
of modeled GPP at each time step and also the posterior distribution of
predicted GPP, which incorporates the Gaussian model error.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluation of the uncertainty coming from the model parameters' uncertainty</span></span>
<span></span>
<span><span class="co"># Sample parameter values from the posterior distribution</span></span>
<span><span class="va">samples_par</span> <span class="op">&lt;-</span> <span class="fu">getSample</span><span class="op">(</span></span>
<span>  <span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">60</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mcmc_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">mcmc_id</span>, .key <span class="op">=</span> <span class="st">"pars"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_pmodel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Function that runs the P-model for a sample of parameters</span></span>
<span>  <span class="co"># and also adds the new observation error</span></span>
<span>  </span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span></span>
<span>    drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>    par <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      kphio              <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">kphio</span>,</span>
<span>      kphio_par_a        <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">kphio_par_a</span>,</span>
<span>      kphio_par_b        <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">kphio_par_b</span>,</span>
<span>      soilm_thetastar    <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">soilm_thetastar</span>,</span>
<span>      soilm_betao        <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">soilm_betao</span>,</span>
<span>      beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>      rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>      tau_acclim         <span class="op">=</span> <span class="fl">20.0</span>,</span>
<span>      kc_jmax            <span class="op">=</span> <span class="fl">0.41</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return modelled GPP and prediction for a new GPP observation</span></span>
<span>  <span class="va">gpp</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"gpp"</span><span class="op">]</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    gpp <span class="op">=</span> <span class="va">gpp</span>, </span>
<span>    gpp_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gpp</span><span class="op">)</span>, </span>
<span>      mean <span class="op">=</span> <span class="va">gpp</span>,</span>
<span>      sd <span class="op">=</span> <span class="va">par</span><span class="op">$</span><span class="va">err_gpp</span></span>
<span>      <span class="op">)</span>,</span>
<span>    date <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"date"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the P-model for each set of parameters</span></span>
<span><span class="va">pmodel_runs</span> <span class="op">&lt;-</span> <span class="va">samples_par</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">pars</span>, <span class="op">~</span><span class="fu">run_pmodel</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># format to obtain 90% credible intervals</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mcmc_id</span>, <span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># compute quantiles for each day</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    gpp_q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gpp</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    gpp_q50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gpp</span>, <span class="fl">0.5</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,          <span class="co"># get median</span></span>
<span>    gpp_q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gpp</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    gpp_pred_q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gpp_pred</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    gpp_pred_q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">gpp_pred</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># run model with maximum a posteriori parameter estimates</span></span>
<span><span class="va">pmodel_run_map</span> <span class="op">&lt;-</span> <span class="fu">run_pmodel</span><span class="op">(</span></span>
<span>  <span class="fu">MAP</span><span class="op">(</span><span class="va">par_calib</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span><span class="op">$</span><span class="va">parametersMAP</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Below we plot the first year of observed GPP (in black) against the
predicted GPP (in grey), computed as the median of the posterior
distribution of modeled GPP. This information is accompanied by the 90%
credible interval for predicted GPP (shaded in blue, very narrow) and
the 90% predictive interval (shaded in grey). We can see that the
parameter uncertainty captured in the credible interval is quite small,
in comparison to the model uncertainty captured by the predictive
interval.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add transparency to color given as a name</span></span>
<span><span class="va">add_alpha</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span> <span class="va">col</span>, <span class="va">alpha</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">col</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/col2rgb.html" class="external-link">col2rgb</a></span><span class="op">(</span> <span class="va">col</span>, alpha <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span><span class="op">/</span><span class="fl">255</span></span>
<span>  <span class="va">col</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">alpha</span></span>
<span>  <span class="va">col</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="va">col</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,<span class="va">col</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span>,<span class="va">col</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span>,<span class="va">col</span><span class="op">[</span><span class="fl">4</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="va">col</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Plot the credible intervals computed above</span></span>
<span><span class="co"># for the first year only</span></span>
<span><span class="va">data_to_plot</span> <span class="op">&lt;-</span> <span class="va">pmodel_runs</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Plot only first year</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">365</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="co"># Merge GPP validation data (first year)</span></span>
<span>    <span class="va">p_model_validation</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">365</span>, <span class="op">]</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>gpp_obs <span class="op">=</span> <span class="va">gpp</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"date"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_gpp_error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_to_plot</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      ymin <span class="op">=</span> <span class="va">gpp_pred_q05</span>,</span>
<span>      ymax <span class="op">=</span> <span class="va">gpp_pred_q95</span>,</span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"Model uncertainty"</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      ymin <span class="op">=</span> <span class="va">gpp_q05</span>, </span>
<span>      ymax <span class="op">=</span> <span class="va">gpp_q95</span>,</span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"Parameter uncertainty"</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Include observations in the plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>     y <span class="op">=</span> <span class="va">gpp_obs</span>,</span>
<span>     color <span class="op">=</span> <span class="st">"Observations"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">gpp_q50</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"Predictions"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">'Date'</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"GPP (g C m"</span><span class="op">^</span><span class="op">-</span><span class="fl">2</span>, <span class="st">"s"</span><span class="op">^</span><span class="op">-</span><span class="fl">1</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="cn">NULL</span>,</span>
<span>                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Observations"</span>,</span>
<span>                                <span class="st">"Predictions"</span><span class="op">)</span>,</span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"tomato"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="cn">NULL</span>,</span>
<span>                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Model uncertainty"</span>,</span>
<span>                               <span class="st">"Parameter uncertainty"</span><span class="op">)</span>,</span>
<span>                    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">add_alpha</span><span class="op">(</span><span class="st">"tomato"</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                               <span class="st">"#1b9e77"</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plot_gpp_error</span></span>
<span><span class="co">#&gt; Warning: Removed 42 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="sensitivity_analysis_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;"></p>
<!-- Below we plot the first year of predicted GPP (in grey) against GPP observations (in black). -->
<!-- We ran the P-model using the MAP estimates for all calibrated parameters and  -->
<!-- computed a 90% predictive interval for GPP (grey shade), based on the normality assumption -->
<!-- with standard deviation `err_gpp`. -->
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>

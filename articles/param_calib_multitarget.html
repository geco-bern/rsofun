<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameter calibration (P-Model) to multiple targets (GPP, bigD13C) • rsofun</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Parameter calibration (P-Model) to multiple targets (GPP, bigD13C)">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>rsofun <small>v5.1.0.9001</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/geco-bern/rsofun/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parameter calibration (P-Model) to multiple
targets (GPP, bigD13C)</h1>
                        <h4 data-toc-skip class="author">Josefa Arán,
Fabian Bernhard</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/geco-bern/rsofun/blob/master/vignettes/param_calib_multitarget.Rmd" class="external-link"><code>vignettes/param_calib_multitarget.Rmd</code></a></small>
      <div class="hidden name"><code>param_calib_multitarget.Rmd</code></div>

    </div>

    
    
<p>This vignette showcases a simplified version of the Bayesian
calibration to with a joint log-likelihood to multiple target variables
taken from the documentation paper <a href="https://doi.org/10.5194/gmd-18-9855-2025" class="external-link">Paredes et
al. (2025)</a>. The separate vignette ‘Parameter calibration (P-Model)
and cost functions’ (see <code><a href="../articles/new_cost_function.html">vignette("new_cost_function")</a></code>)
provides simpler examples.</p>
<p>You may be interested in calibrating the model to different target
variables simultaneously, like flux and leaf trait measurements.</p>
<div class="section level3">
<h3 id="calibrating-one-gpp-and-one-d13c-site">Calibrating one GPP and one D13C site<a class="anchor" aria-label="anchor" href="#calibrating-one-gpp-and-one-d13c-site"></a>
</h3>
<p>In this section we present an example, where we use
<code><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel()</a></code> to compute the joint likelihood of
all the targets specified (that is, by summing the log-likelihoods of
GPP and bigD13C) and ultimately calibrate the
<code>beta_unitcostratio</code> parameter. In the section after, we
calibrate another example to multiple sites.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings for two targets</span></span>
<span><span class="va">params_to_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  beta_unitcostratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">14.6</span>,  upper <span class="op">=</span> <span class="fl">440</span>, init <span class="op">=</span> <span class="fl">146.0</span><span class="op">)</span>,  <span class="co"># uniform priors</span></span>
<span>  kc_jmax            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.2</span>,   upper <span class="op">=</span> <span class="fl">0.8</span>, init <span class="op">=</span> <span class="fl">0.41</span><span class="op">)</span>,   <span class="co"># uniform priors</span></span>
<span>  err_gpp            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">4</span>,   init <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  err_bigD13C        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>,  upper <span class="op">=</span> <span class="fl">3</span>,   init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params_fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="co"># fix parameter value from previous calibration</span></span>
<span>  kphio              <span class="op">=</span> <span class="fl">0.041</span>,</span>
<span>  kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>  kphio_par_b        <span class="op">=</span> <span class="fl">16</span>,</span>
<span>  soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover paper setup with soil moisture stress</span></span>
<span>  soilm_betao        <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>  tau_acclim         <span class="op">=</span> <span class="fl">30.0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">settings_joint_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"BayesianTools"</span>,</span>
<span>  metric  <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler_runMCMC <span class="op">=</span> <span class="st">"DREAMzs"</span>,</span>
<span>    settings_runMCMC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co"># burnin = 1500,             # kept artificially low</span></span>
<span>      <span class="co"># iterations = 3000,</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      iterations <span class="op">=</span> <span class="fl">50</span>,   <span class="co"># kept artificially low</span></span>
<span>      nrChains   <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># optional parallelization</span></span>
<span>    n_parallel_nrChains <span class="op">=</span> <span class="fl">1</span>  <span class="co"># 2, this can be parallelized</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># parameters</span></span>
<span>  par <span class="op">=</span> <span class="va">params_to_estimate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the calibration on the observational data of two sites</span></span>
<span><span class="va">drivers</span> <span class="op">&lt;-</span> <span class="va">pmodel_drivers</span>    <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FR-Pue"</span>, <span class="st">"lon_+146.13_lat_-032.97"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">pmodel_validation</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FR-Pue"</span>, <span class="st">"lon_+146.13_lat_-032.97"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par_calib_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers  <span class="op">=</span> <span class="va">drivers</span>,</span>
<span>  obs      <span class="op">=</span> <span class="va">obs</span>,</span>
<span>  settings_calib <span class="op">=</span> <span class="va">settings_joint_likelihood</span>,</span>
<span>  <span class="co"># arguments for the cost function</span></span>
<span>  par_fixed <span class="op">=</span> <span class="va">params_fixed</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Calibration with <code>calib_sofun</code> returns an object that
contains the maximum-a-posteriori (MAP) estimates of the parameters in
<code>par</code> and the full distribution of the parameters in the MCMC
chains in <code>mod</code>. Besides those it also reports additional
information.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_calib_join</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; beta_unitcostratio            kc_jmax            err_gpp        err_bigD13C </span></span>
<span><span class="co">#&gt;        338.8871156          0.3435334          1.4141445          1.8159620 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mod</span></span>
<span><span class="co">#&gt; [1] "mcmcSamplerList - you can use the following methods to summarize, plot or reduce this class:"</span></span>
<span><span class="co">#&gt; [1] plot    print   summary</span></span>
<span><span class="co">#&gt; see '?methods' for accessing help and source code</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "out_calib_my_calibration_name.rds.log.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $logpath</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $walltime</span></span>
<span><span class="co">#&gt; Time difference of 1.476193 secs</span></span></code></pre></div>
<p>Note that GPP predictions are directly compared to GPP observations
on that day, but the leaf trait bigD13C is predicted by the P-model as
“onestep” prediction for average conditions over the growing season and
compared to the (multiple) bigD13C observations taken across trees per
site. This is specified by the arguments <code>drivers</code> and
<code>obs</code>. Namely, it is specified by the column
<code>params_siml$onestep</code> within <code>drivers</code>, which can
be <code>FALSE</code> (for daily simulation) or <code>TRUE</code> (for
onestep acclimation), by the corresponding column <code>forcing</code>
containing daily or average conditions, and by the column
<code>targets</code> specified for each simulation site (i.e. each row
in <code>drivers</code> and <code>obs</code>).</p>
<p>For more details, unfold the code below or check the documentation of
<code>pmodel_drivers</code> and <code>pmodel_validation</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note the columns: 'targets', and 'data' (containing observations)</span></span>
<span><span class="va">pmodel_validation</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">unnest_wider</a></span><span class="op">(</span><span class="va">targets</span>, names_sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 4</span></span></span>
<span><span class="co">#&gt;    sitename                targets_1 targets_2 data                </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>              </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CH-Dav                  gpp       le        <span style="color: #949494;">&lt;tibble [714 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CZ-BK1                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [479 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> DK-Sor                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [720 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> FI-Hyy                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [704 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> FR-Pue                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [1,924 × 7]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> GF-Guy                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [319 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> US-Ha1                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [502 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> US-PFa                  gpp       <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [669 × 7]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_+010.52_lat_+051.08 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [8 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_+011.10_lat_+048.30 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_+112.58_lat_+023.13 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [94 × 2]&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_+145.13_lat_-005.83 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> lon_+146.13_lat_-032.97 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [19 × 2]&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> lon_+148.30_lat_-036.10 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [2 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> lon_+153.00_lat_-026.85 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [25 × 2]&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> lon_-079.10_lat_+035.97 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [4 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> lon_-116.45_lat_+047.16 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [18 × 2]&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span> lon_-119.82_lat_+034.50 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [13 × 2]&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span> lon_-122.98_lat_+038.40 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span> lon_-149.61_lat_+063.97 bigD13C   <span style="color: #BB0000;">NA</span>        <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span></span></span>
<span><span class="va">pmodel_validation</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 187 × 4</span></span></span>
<span><span class="co">#&gt;    sitename                targets   id                       bigD13C</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Acer platanoides       19.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Acer pseudoplatanus    19.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Carpinus betulus       19.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Fagus engleriana       19.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Fraxinus excelsior     18.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Quercus x mannifera    20.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Tilia cordata          19.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2001_Tilia x europaea       18.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_+011.10_lat_+048.30 <span style="color: #949494;">&lt;chr [1]&gt;</span> 2002_Fagus engleriana       22.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_+112.58_lat_+023.13 <span style="color: #949494;">&lt;chr [1]&gt;</span> 1985_Adenosma glutinosa     22.8</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 177 more rows</span></span></span>
<span><span class="va">pmodel_validation</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^[A-Z]"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6,031 × 9</span></span></span>
<span><span class="co">#&gt;    sitename targets   date          gpp gpp_qc   nee nee_qc    le le_qc</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-01  0.855  1     1.44   1      9.49     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-02 -<span style="color: #BB0000;">0.943</span>  1     2.62   1     65.0      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-03 -<span style="color: #BB0000;">0.951</span>  1     2.39   1     48.6      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-04  1.23   0.979 0.958  0.979 14.7      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-05  1.36   1     0.992  1     37.5      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-06  1.67   1     1.02   1     31.4      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-07  2.27   0.979 0.575  0.979 16.9      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-08  2.00   1     0.854  1     21.5      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-09  1.20   0.979 1.53   0.979 24.6      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CH-Dav   <span style="color: #949494;">&lt;chr [2]&gt;</span> 2007-01-10  0.732  0.958 1.72   0.958 28.3      1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6,021 more rows</span></span></span>
<span></span>
<span><span class="va">pmodel_drivers</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">forcing</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 8</span></span></span>
<span><span class="co">#&gt;    sitename               params_siml site_info  temp   vpd    ppfd   co2   patm</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lon_+010.52_lat_+051.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   11.6  363. 2.61<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.75<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lon_+011.10_lat_+048.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   12.4  399. 2.99<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.53<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lon_+112.58_lat_+023.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   23.7  666. 3.27<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.92<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lon_+145.13_lat_-005.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   16.0  382. 3.46<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 7.29<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lon_+146.13_lat_-032.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   21.5 <span style="text-decoration: underline;">1</span>231. 4.27<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.94<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lon_+148.30_lat_-036.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   10.7  384. 3.82<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 8.60<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lon_+153.00_lat_-026.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   23.6  813. 4.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 1.01<span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lon_-079.10_lat_+035.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   19.0  762. 3.58<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.94<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_-116.45_lat_+047.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   14.3  696. 3.85<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.16<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_-119.82_lat_+034.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   18.3  818. 4.23<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.43<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_-122.98_lat_+038.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   17.1  651. 3.84<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.81<span style="color: #949494;">e</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_-149.61_lat_+063.… <span style="color: #949494;">&lt;tibble&gt;</span>    <span style="color: #949494;">&lt;tibble&gt;</span>   10.9  495. 3.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  370. 9.27<span style="color: #949494;">e</span>4</span></span>
<span><span class="va">pmodel_drivers</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^[A-Z]"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">forcing</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7,300 × 17</span></span></span>
<span><span class="co">#&gt;    sitename params_siml       site_info date         temp   vpd    ppfd   netrad</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-01  2.87  234.  4.26<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> -<span style="color: #BB0000;">28.0</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-02 -<span style="color: #BB0000;">4.67</span>  110.  6.21<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span>  -<span style="color: #BB0000;">0.394</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-03 -<span style="color: #BB0000;">3.67</span>  101.  9.80<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span>  -<span style="color: #BB0000;">7.05</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-04  0.463  45.1 7.24<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span>  -<span style="color: #BB0000;">0.092</span><span style="color: #BB0000; text-decoration: underline;">7</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-05 -<span style="color: #BB0000;">1.30</span>   95.3 1.55<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  23.4   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-06  0.982 149.  1.50<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -<span style="color: #BB0000;">21.3</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-07  2.01  149.  1.52<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -<span style="color: #BB0000;">15.4</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-08  2.05  270.  1.22<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -<span style="color: #BB0000;">26.7</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-09  2.21   20.9 6.22<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span>   6.76  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> CH-Dav   <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  2007-01-10  6.19  237.  1.57<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> -<span style="color: #BB0000;">37.7</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7,290 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 9 more variables: patm &lt;dbl&gt;, snow &lt;dbl&gt;, rain &lt;dbl&gt;, tmin &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   tmax &lt;dbl&gt;, wind &lt;dbl&gt;, fapar &lt;dbl&gt;, co2 &lt;dbl&gt;, ccov &lt;dbl&gt;</span></span></span>
<span></span>
<span><span class="va">pmodel_drivers</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">params_siml</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 5</span></span></span>
<span><span class="co">#&gt;    sitename                lc4   onestep site_info        forcing         </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lon_+010.52_lat_+051.08 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lon_+011.10_lat_+048.30 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lon_+112.58_lat_+023.13 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lon_+145.13_lat_-005.83 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lon_+146.13_lat_-032.97 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lon_+148.30_lat_-036.10 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lon_+153.00_lat_-026.85 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lon_-079.10_lat_+035.97 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_-116.45_lat_+047.16 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_-119.82_lat_+034.50 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_-122.98_lat_+038.40 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_-149.61_lat_+063.97 FALSE TRUE    <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;tibble [1 × 5]&gt;</span></span></span>
<span><span class="va">pmodel_drivers</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^[A-Z]"</span>, <span class="va">sitename</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">params_siml</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 15</span></span></span>
<span><span class="co">#&gt;   sitename spinup spinupyears recycle outdt ltre  ltne  ltrd  ltnd  lgr3  lgn3 </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> CH-Dav   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> CZ-BK1   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> DK-Sor   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> FI-Hyy   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> FR-Pue   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> GF-Guy   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> US-Ha1   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> US-PFa   TRUE            10       1     1 FALSE FALSE FALSE FALSE TRUE  FALSE</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more variables: lgr4 &lt;lgl&gt;, onestep &lt;lgl&gt;, site_info &lt;list&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   forcing &lt;list&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calibrating-multiple-gpp-and-d13c-sites">Calibrating multiple GPP and D13C sites<a class="anchor" aria-label="anchor" href="#calibrating-multiple-gpp-and-d13c-sites"></a>
</h3>
<div class="section level4">
<h4 id="some-helper-functions-for-calibration">Some helper functions for calibration<a class="anchor" aria-label="anchor" href="#some-helper-functions-for-calibration"></a>
</h4>
<p>Below we define some helper functions to facilitate model calibration
with different target variables, resulting thus in different calibration
setups. These helper functions simplify the use of parallel execution
and avoid code repetition.</p>
<p>Here, we showcase two different setups. The first setup uses only
D13C as target variable (corresponds to Setup S1 in the documentation
paper). The second setup uses D13C and GPP as calibration targets and
(truncated) normal priors for the parameters (Setup S6). In below code,
we define first these two different calibration setups by specifying the
function <code>setup_rsofun_calibration()</code>, that returns an object
with the necessary specifications.</p>
<p>These specifications can differ in the selection of calibration
parameters and priors, in the data used and potentially in the
test-train split. Here, setups are uniquely identified with a numeric
identifer. Below code defines <code>setup_rsofun_calibration()</code>
for setups 226 and 231.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#    226: Setup c)      Delta^'13 C*',VJ</span></span>
<span><span class="co">#    231: Setup h)      Delta^'13 C*',VJ, GPP</span></span>
<span></span>
<span><span class="va">setup_rsofun_calibration</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Load forcing and targets data from disk (here now from package) ----</span></span>
<span>  <span class="va">bigD13C_vj_gpp_drivers</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/pmodel_drivers.html">pmodel_drivers</a></span></span>
<span>  <span class="va">bigD13C_vj_gpp_obs</span>     <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/pmodel_validation.html">pmodel_validation</a></span></span>
<span></span>
<span>  <span class="co"># ## Read test-train split from disk ----</span></span>
<span>  <span class="co"># read_csv(here::here("data/01_test_train_split.csv"))</span></span>
<span>  <span class="co"># Not needed here for vignette</span></span>
<span></span>
<span>  <span class="co">## Preprocess observation data (gpp) ----</span></span>
<span>  <span class="co">## # no additinal QC needed</span></span>
<span></span>
<span>  <span class="co">## Apply test-train split to data ----</span></span>
<span>  <span class="va">train_drivers</span> <span class="op">&lt;-</span> <span class="va">bigD13C_vj_gpp_drivers</span></span>
<span>  <span class="va">train_obs</span>     <span class="op">&lt;-</span> <span class="va">bigD13C_vj_gpp_obs</span></span>
<span></span>
<span>  <span class="va">test_drivers</span> <span class="op">&lt;-</span> <span class="va">bigD13C_vj_gpp_drivers</span> <span class="op">|&gt;</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">test_obs</span>     <span class="op">&lt;-</span> <span class="va">bigD13C_vj_gpp_obs</span>     <span class="op">|&gt;</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Setup the settings for the different calibration scenarios ----</span></span>
<span>  <span class="co">## Define default parameter</span></span>
<span>  <span class="va">default_par_fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="co"># fix parameter value from previous calibration</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.04998</span>,    <span class="co"># value from Stocker et al. 2020</span></span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,        <span class="co"># 0 corresponds to no temperature dependency of kphio (ORG setup in Stocker et al. 2020)</span></span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">1.0</span>,        <span class="co">#</span></span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover paper setup with soil moisture stress</span></span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.01</span>,       <span class="co"># 1 corresponds to no reduction, 0 to full reduction at theta==0</span></span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,      <span class="co"># value from Stocker et al. 2020</span></span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">14.0</span>,       <span class="co"># value from Liu et al. 2024</span></span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span>        <span class="co"># value from Stocker et al. 2024 (citing Wang et al. 2017)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Define parameters to estimate and their priors</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">223</span>, <span class="fl">226</span>, <span class="fl">231</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># 231 is like 223 but using posteriors from 226</span></span>
<span>    <span class="va">par_to_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      kphio           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.02</span>, upper <span class="op">=</span> <span class="fl">0.15</span>, init <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>      kphio_par_a     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">0.004</span>, upper <span class="op">=</span> <span class="op">-</span><span class="fl">0.001</span>, init <span class="op">=</span> <span class="op">-</span><span class="fl">0.0025</span><span class="op">)</span>,</span>
<span>      kphio_par_b     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">30</span>, init <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>      soilm_thetastar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1</span>, upper <span class="op">=</span> <span class="fl">250</span>, init <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>      beta_unitcostratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">3.0</span>, init <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">146.0</span><span class="op">)</span>,</span>
<span>      <span class="co"># truncated normal, with ~14 days as mean, taken from Liu et al.</span></span>
<span>      <span class="co"># 2024, Nat.Plants and Mäkelä et al. 2004, Tree Phys.</span></span>
<span>      tau_acclim      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">14</span>, sd <span class="op">=</span> <span class="fl">8</span>, lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>,</span>
<span>      kc_jmax         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fl">0.41</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">3.0</span>, init <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      err_gpp         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">3</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>      err_bigD13C     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">3</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">223</span>, <span class="fl">226</span>, <span class="fl">231</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">par_to_estimate</span><span class="op">$</span><span class="va">err_bigD13C</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">15</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Unsupported scenario: %d"</span>, <span class="va">scenario</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">231</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># 231 is like 223 but using posteriors from 226</span></span>
<span>    <span class="co"># for beta_unitcostratio and kc_jmax as priors</span></span>
<span>    <span class="co"># Below was done iteratively</span></span>
<span>    <span class="co"># calib_scen226 &lt;- readr::read_rds(file.path(rsofun_doc_output_path, "data","calibrations","out_calib__scen226_DREAMzs-100000-0iter_8x3chains_on_CPU8x1_continued.rds"))</span></span>
<span>    <span class="co"># # i) extract samples as a data.frame</span></span>
<span>    <span class="co"># burnins_scen226 &lt;- 30000</span></span>
<span>    <span class="co"># samples_scen226 &lt;- getSample(calib_scen226$mod, thin = 1, start = burnins_scen226) %&gt;% as.data.frame()</span></span>
<span>    <span class="co">#</span></span>
<span>    <span class="co"># # ii) fit normal and lognormal distributions for each parameter</span></span>
<span>    <span class="co"># param_normals_scen226 &lt;- lapply(setNames(names(samples_scen226), names(samples_scen226)), function(p) {</span></span>
<span>    <span class="co">#   list(mean = mean(samples_scen226[[p]]),</span></span>
<span>    <span class="co">#       sd   = sd(  samples_scen226[[p]]))</span></span>
<span>    <span class="co"># })[c('beta_unitcostratio', 'kc_jmax')] # only keep these</span></span>
<span>    <span class="co">#</span></span>
<span>    <span class="co"># # then pass on these as prior for these</span></span>
<span>    <span class="co"># par_to_estimate$beta_unitcostratio &lt;- param_normals_scen226$beta_unitcostratio</span></span>
<span>    <span class="co"># par_to_estimate$kc_jmax            &lt;- param_normals_scen226$kc_jmax</span></span>
<span></span>
<span>    <span class="va">par_to_estimate</span><span class="op">$</span><span class="va">beta_unitcostratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean    <span class="op">=</span> <span class="fl">207.86</span>, sd    <span class="op">=</span> <span class="fl">6.79</span><span class="op">)</span></span>
<span>    <span class="va">par_to_estimate</span><span class="op">$</span><span class="va">kc_jmax</span>            <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean    <span class="op">=</span> <span class="fl">0.4244</span>, sd    <span class="op">=</span> <span class="fl">0.0217</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">231</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># truncated normal:</span></span>
<span>      <span class="va">par_to_estimate</span><span class="op">$</span><span class="va">beta_unitcostratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean    <span class="op">=</span> <span class="fl">207.86</span>, sd    <span class="op">=</span> <span class="fl">6.79</span>,</span>
<span>        lower <span class="op">=</span> <span class="fl">207.86</span> <span class="op">-</span> <span class="fl">3</span> <span class="op">*</span> <span class="fl">6.79</span>,</span>
<span>        upper <span class="op">=</span> <span class="fl">207.86</span> <span class="op">+</span> <span class="fl">3</span> <span class="op">*</span> <span class="fl">6.79</span><span class="op">)</span></span>
<span>      <span class="co"># normal:</span></span>
<span>      <span class="va">par_to_estimate</span><span class="op">$</span><span class="va">kc_jmax</span>            <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean    <span class="op">=</span> <span class="fl">0.4244</span>, sd    <span class="op">=</span> <span class="fl">0.0217</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Remove parameters that are defined to be estimated from default_par_fixed</span></span>
<span>  <span class="va">par_to_fix</span> <span class="op">&lt;-</span> <span class="va">default_par_fixed</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">default_par_fixed</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_to_estimate</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">## Setup the data (drivers and obs) for the three calibration scenarios ----</span></span>
<span></span>
<span>  <span class="co"># Subset different combination sites to dfeine target variables.</span></span>
<span>  <span class="co"># For easier handling do this in combined drivobs-object.</span></span>
<span>  <span class="va">drivobs_train_bigD13C_vj_gpp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="va">train_drivers</span>,</span>
<span>    <span class="va">train_obs</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">drivobs_test_bigD13C_vj_gpp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="va">test_drivers</span>,</span>
<span>    <span class="va">test_obs</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">all_potential_targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">drivobs_train_bigD13C_vj_gpp</span><span class="op">$</span><span class="va">targets</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">223</span>, <span class="fl">224</span>, <span class="fl">225</span>, <span class="fl">229</span>, <span class="fl">230</span>, <span class="fl">231</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># GPP and traits data</span></span>
<span>    <span class="va">targets_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gpp"</span>, <span class="st">"bigD13C"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">scenario</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">226</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>       <span class="co"># only traits data, either both, or vj only, or bigD13C only</span></span>
<span>    <span class="va">targets_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bigD13C"</span><span class="op">)</span></span>
<span>    <span class="co"># } else if (scenario %in% c(220)) {  # only GPP data from FR-Pue</span></span>
<span>    <span class="co">#   targets_to_keep &lt;- c("gpp")</span></span>
<span>    <span class="co">#   sites_to_keep &lt;- "FR-Pue"</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Unsupported scenario: %d"</span>, <span class="va">scenario</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">targets_to_keep</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">all_potential_targets</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">drivobs_train</span> <span class="op">&lt;-</span> <span class="va">drivobs_train_bigD13C_vj_gpp</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># keep only sites with targets we want</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">targets_to_keep</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">.data</span><span class="op">$</span><span class="va">targets</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># remove other unwanted target specifications from sites we keep (e.g. ET observations for a site with GPP and ET)</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">targets</span>, <span class="va">targets_to_keep</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">drivobs_test</span> <span class="op">&lt;-</span> <span class="va">drivobs_test_bigD13C_vj_gpp</span> <span class="co">## for the test data set keep all</span></span>
<span></span>
<span>  <span class="co">## return ---</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    drivobs_train <span class="op">=</span> <span class="va">drivobs_train</span>,</span>
<span>    drivobs_test <span class="op">=</span> <span class="va">drivobs_test</span>,</span>
<span>    par_fixed <span class="op">=</span> <span class="va">par_to_fix</span>,</span>
<span>    par <span class="op">=</span> <span class="va">par_to_estimate</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="fu">setup_rsofun_calibration</span><span class="op">(</span><span class="fl">226</span><span class="op">)</span></span>
<span><span class="co">#&gt; $drivobs_train</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 6</span></span></span>
<span><span class="co">#&gt;    sitename                params_siml      site_info forcing  targets data    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lon_+011.10_lat_+048.30 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lon_+112.58_lat_+023.13 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lon_+145.13_lat_-005.83 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lon_+146.13_lat_-032.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lon_+148.30_lat_-036.10 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lon_+153.00_lat_-026.85 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lon_-079.10_lat_+035.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_-116.45_lat_+047.16 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_-119.82_lat_+034.50 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_-122.98_lat_+038.40 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_-149.61_lat_+063.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $drivobs_test</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 6</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 variables: sitename &lt;chr&gt;, params_siml &lt;list&gt;, site_info &lt;list&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   forcing &lt;list&gt;, targets &lt;list&gt;, data &lt;list&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par_fixed</span></span>
<span><span class="co">#&gt; $par_fixed$soilm_betao</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par_fixed$rd_to_vcmax</span></span>
<span><span class="co">#&gt; [1] 0.014</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; $par$kphio</span></span>
<span><span class="co">#&gt; $par$kphio$lower</span></span>
<span><span class="co">#&gt; [1] 0.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio$upper</span></span>
<span><span class="co">#&gt; [1] 0.15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio$init</span></span>
<span><span class="co">#&gt; [1] 0.05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a</span></span>
<span><span class="co">#&gt; $par$kphio_par_a$lower</span></span>
<span><span class="co">#&gt; [1] -0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a$upper</span></span>
<span><span class="co">#&gt; [1] -0.001</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a$init</span></span>
<span><span class="co">#&gt; [1] -0.0025</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b</span></span>
<span><span class="co">#&gt; $par$kphio_par_b$lower</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b$upper</span></span>
<span><span class="co">#&gt; [1] 30</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b$init</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar</span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$lower</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$upper</span></span>
<span><span class="co">#&gt; [1] 250</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$init</span></span>
<span><span class="co">#&gt; [1] 40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio</span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$lower</span></span>
<span><span class="co">#&gt; [1] 14.6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$upper</span></span>
<span><span class="co">#&gt; [1] 438</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$init</span></span>
<span><span class="co">#&gt; [1] 146</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim</span></span>
<span><span class="co">#&gt; $par$tau_acclim$mean</span></span>
<span><span class="co">#&gt; [1] 14</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$sd</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$upper</span></span>
<span><span class="co">#&gt; [1] 40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kc_jmax</span></span>
<span><span class="co">#&gt; $par$kc_jmax$lower</span></span>
<span><span class="co">#&gt; [1] 0.041</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kc_jmax$upper</span></span>
<span><span class="co">#&gt; [1] 1.23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kc_jmax$init</span></span>
<span><span class="co">#&gt; [1] 0.41</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp</span></span>
<span><span class="co">#&gt; $par$err_gpp$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp$upper</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp$init</span></span>
<span><span class="co">#&gt; [1] 0.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C</span></span>
<span><span class="co">#&gt; $par$err_bigD13C$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C$upper</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C$init</span></span>
<span><span class="co">#&gt; [1] 0.8</span></span>
<span><span class="fu">setup_rsofun_calibration</span><span class="op">(</span><span class="fl">226</span><span class="op">)</span><span class="op">$</span><span class="va">drivobs_train</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 6</span></span></span>
<span><span class="co">#&gt;    sitename                params_siml      site_info forcing  targets data    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> lon_+011.10_lat_+048.30 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> lon_+112.58_lat_+023.13 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> lon_+145.13_lat_-005.83 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lon_+146.13_lat_-032.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lon_+148.30_lat_-036.10 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lon_+153.00_lat_-026.85 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lon_-079.10_lat_+035.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_-116.45_lat_+047.16 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_-119.82_lat_+034.50 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_-122.98_lat_+038.40 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_-149.61_lat_+063.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="fu">setup_rsofun_calibration</span><span class="op">(</span><span class="fl">231</span><span class="op">)</span></span>
<span><span class="co">#&gt; $drivobs_train</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 6</span></span></span>
<span><span class="co">#&gt;    sitename                params_siml       site_info forcing  targets data    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CH-Dav                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CZ-BK1                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> DK-Sor                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> FI-Hyy                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> FR-Pue                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> GF-Guy                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> US-Ha1                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> US-PFa                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_+011.10_lat_+048.30 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_+112.58_lat_+023.13 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_+145.13_lat_-005.83 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> lon_+146.13_lat_-032.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> lon_+148.30_lat_-036.10 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> lon_+153.00_lat_-026.85 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> lon_-079.10_lat_+035.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> lon_-116.45_lat_+047.16 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span> lon_-119.82_lat_+034.50 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span> lon_-122.98_lat_+038.40 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span> lon_-149.61_lat_+063.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $drivobs_test</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 6</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 variables: sitename &lt;chr&gt;, params_siml &lt;list&gt;, site_info &lt;list&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   forcing &lt;list&gt;, targets &lt;list&gt;, data &lt;list&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par_fixed</span></span>
<span><span class="co">#&gt; $par_fixed$soilm_betao</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par_fixed$rd_to_vcmax</span></span>
<span><span class="co">#&gt; [1] 0.014</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; $par$kphio</span></span>
<span><span class="co">#&gt; $par$kphio$lower</span></span>
<span><span class="co">#&gt; [1] 0.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio$upper</span></span>
<span><span class="co">#&gt; [1] 0.15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio$init</span></span>
<span><span class="co">#&gt; [1] 0.05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a</span></span>
<span><span class="co">#&gt; $par$kphio_par_a$lower</span></span>
<span><span class="co">#&gt; [1] -0.004</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a$upper</span></span>
<span><span class="co">#&gt; [1] -0.001</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_a$init</span></span>
<span><span class="co">#&gt; [1] -0.0025</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b</span></span>
<span><span class="co">#&gt; $par$kphio_par_b$lower</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b$upper</span></span>
<span><span class="co">#&gt; [1] 30</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kphio_par_b$init</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar</span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$lower</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$upper</span></span>
<span><span class="co">#&gt; [1] 250</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$soilm_thetastar$init</span></span>
<span><span class="co">#&gt; [1] 40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio</span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$mean</span></span>
<span><span class="co">#&gt; [1] 207.86</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$sd</span></span>
<span><span class="co">#&gt; [1] 6.79</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$lower</span></span>
<span><span class="co">#&gt; [1] 187.49</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$beta_unitcostratio$upper</span></span>
<span><span class="co">#&gt; [1] 228.23</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim</span></span>
<span><span class="co">#&gt; $par$tau_acclim$mean</span></span>
<span><span class="co">#&gt; [1] 14</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$sd</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$tau_acclim$upper</span></span>
<span><span class="co">#&gt; [1] 40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kc_jmax</span></span>
<span><span class="co">#&gt; $par$kc_jmax$mean</span></span>
<span><span class="co">#&gt; [1] 0.4244</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$kc_jmax$sd</span></span>
<span><span class="co">#&gt; [1] 0.0217</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp</span></span>
<span><span class="co">#&gt; $par$err_gpp$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp$upper</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_gpp$init</span></span>
<span><span class="co">#&gt; [1] 0.8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C</span></span>
<span><span class="co">#&gt; $par$err_bigD13C$lower</span></span>
<span><span class="co">#&gt; [1] 0.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C$upper</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $par$err_bigD13C$init</span></span>
<span><span class="co">#&gt; [1] 0.8</span></span>
<span><span class="fu">setup_rsofun_calibration</span><span class="op">(</span><span class="fl">231</span><span class="op">)</span><span class="op">$</span><span class="va">drivobs_train</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 6</span></span></span>
<span><span class="co">#&gt;    sitename                params_siml       site_info forcing  targets data    </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> CH-Dav                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> CZ-BK1                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> DK-Sor                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> FI-Hyy                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> FR-Pue                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> GF-Guy                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> US-Ha1                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> US-PFa                  <span style="color: #949494;">&lt;tibble [1 × 12]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lon_+010.52_lat_+051.08 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lon_+011.10_lat_+048.30 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lon_+112.58_lat_+023.13 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lon_+145.13_lat_-005.83 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> lon_+146.13_lat_-032.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> lon_+148.30_lat_-036.10 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> lon_+153.00_lat_-026.85 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> lon_-079.10_lat_+035.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> lon_-116.45_lat_+047.16 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span> lon_-119.82_lat_+034.50 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span> lon_-122.98_lat_+038.40 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span> lon_-149.61_lat_+063.97 <span style="color: #949494;">&lt;tibble [1 × 2]&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;list&gt;</span>  <span style="color: #949494;">&lt;tibble&gt;</span></span></span></code></pre></div>
<p>Then we also define a function to run the Markov Chain Monte Carlo
(MCMC) sampling <code>run_mcmc_rsofun()</code>. This function reads in
the unique setup identifier and uses the function
<code>setup_rsofun_calibration()</code> to get all the necessary
definitions. By doing so this code can easily be parallelized in
multiple jobs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_mcmc_rsofun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">curr_calibration_scenario</span>,</span>
<span>    <span class="co"># MCMC setup:</span></span>
<span>    <span class="va">iterations</span> <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    <span class="va">burnin</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">n_chains_independent</span>    <span class="op">=</span> <span class="fl">3</span>, <span class="co"># number of independent chains (called 'nrChains' in runMCMC)</span></span>
<span>    <span class="va">n_chains_within_sampler</span> <span class="op">=</span> <span class="fl">3</span>, <span class="co"># number of internal chains to be sampled (called 'startValue' in runMCMC, at least 2 for DEzs)</span></span>
<span></span>
<span>    <span class="co"># parallelization:</span></span>
<span>    <span class="va">n_parallel_independent</span>  <span class="op">=</span> <span class="fl">3</span>, <span class="co"># number of cores for parallelization of independent chains     https://cran.r-project.org/web/packages/BayesianTools/vignettes/InterfacingAModel.html#running-several-mcmcs-in-parallel</span></span>
<span>    <span class="va">outpath</span> <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>    <span class="va">suffix_str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>    <span class="va">sampler_runMCMC</span> <span class="op">=</span> <span class="st">"DREAMzs"</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Setup simulation model</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">setup_rsofun_calibration</span><span class="op">(</span>scenario <span class="op">=</span> <span class="va">curr_calibration_scenario</span><span class="op">)</span></span>
<span>  <span class="co"># res$drivobs_train</span></span>
<span>  <span class="co"># res$drivobs_test</span></span>
<span>  <span class="co"># res$par_fixed</span></span>
<span>  <span class="co"># res$par</span></span>
<span></span>
<span>  <span class="co"># Load loglikelihood (e.g. if using a tailor-made one, instead of package-provided):</span></span>
<span>  <span class="co"># source("R/calibration_helpers.R", echo = FALSE)</span></span>
<span>  <span class="co"># source("R/cost_likelihood_pmodel.R", echo = FALSE)</span></span>
<span></span>
<span>  <span class="co"># Setup MCMC          # uses drivobs_train, not drivobs_test</span></span>
<span>  <span class="va">driver_to_use_for_mcmc</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">sitename</span>, <span class="va">params_siml</span>, <span class="va">site_info</span>, <span class="va">forcing</span><span class="op">)</span></span>
<span>  <span class="va">obs_to_use_for_mcmc</span>    <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">sitename</span>, <span class="va">targets</span>, <span class="va">data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">calib_sofun_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"BayesianTools"</span>,</span>
<span>    metric <span class="op">=</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va"><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel</a></span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      sampler_runMCMC <span class="op">=</span> <span class="va">sampler</span>,</span>
<span>      settings_runMCMC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        burnin     <span class="op">=</span> <span class="va">burnin</span>,                 <span class="co"># 10000,</span></span>
<span>        iterations <span class="op">=</span> <span class="va">iterations</span>,             <span class="co"># 50000,</span></span>
<span>        nrChains   <span class="op">=</span> <span class="va">n_chains_independent</span>,   <span class="co"># number of independent chains to be sampled</span></span>
<span>        startValue <span class="op">=</span> <span class="va">n_chains_within_sampler</span> <span class="co"># number of internal chains to be sampled</span></span>
<span>      <span class="op">)</span>,</span>
<span>      n_parallel_nrChains <span class="op">=</span> <span class="va">n_parallel_independent</span></span>
<span>    <span class="op">)</span>,</span>
<span>    par <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">par</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># setup output directories for parallel calibration</span></span>
<span>  <span class="va">logpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outpath</span>, <span class="st">"calibrations"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"out_calib_"</span>, <span class="va">suffix_str</span>, <span class="st">".rds.log.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rds_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".log.txt"</span>, <span class="st">""</span>, <span class="va">logpath</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">logpath</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Run calibration in parallel</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">": start sampling of "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"out_calib_"</span>, <span class="va">suffix_str</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">out_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>    drivers   <span class="op">=</span> <span class="va">driver_to_use_for_mcmc</span>,</span>
<span>    obs       <span class="op">=</span> <span class="va">obs_to_use_for_mcmc</span>,</span>
<span>    settings_calib <span class="op">=</span> <span class="va">calib_sofun_settings</span>,</span>
<span>    logpath   <span class="op">=</span> <span class="va">logpath</span>,</span>
<span>    <span class="co"># other arguments for the cost function</span></span>
<span>    par_fixed <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">par_fixed</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co">## Store result object to file: ----</span></span>
<span>  <span class="co">## This enables easy continuation of MCMC sampling</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">out_calib</span>, file <span class="op">=</span> <span class="va">rds_path</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">": end   sampling of "</span>, <span class="va">out_calib</span><span class="op">$</span><span class="va">name</span>,</span>
<span>    <span class="st">". \nWritten *.rds-output to: "</span>, <span class="va">rds_path</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># return only performance results as tibble</span></span>
<span>  <span class="va">timings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    setup       <span class="op">=</span> <span class="va">curr_calibration_scenario</span>,</span>
<span>    name        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".rds.log.txt"</span>, <span class="st">""</span>, <span class="va">out_calib</span><span class="op">$</span><span class="va">name</span><span class="op">)</span>,</span>
<span>    <span class="co"># sampling options:</span></span>
<span>    sampler        <span class="op">=</span> <span class="va">calib_sofun_settings</span><span class="op">$</span><span class="va">control</span><span class="op">$</span><span class="va">sampler_runMCMC</span>,</span>
<span>    burnin         <span class="op">=</span> <span class="va">burnin</span>,</span>
<span>    iterations     <span class="op">=</span> <span class="va">iterations</span>,</span>
<span>    n_chains       <span class="op">=</span> <span class="va">n_chains_independent</span>,</span>
<span>    n_chains_inner <span class="op">=</span> <span class="va">n_chains_within_sampler</span>,</span>
<span>    <span class="co"># performance results:</span></span>
<span>    cores          <span class="op">=</span> <span class="va">n_parallel_independent</span>,</span>
<span>    walltime       <span class="op">=</span> <span class="va">out_calib</span><span class="op">$</span><span class="va">walltime</span> <span class="co"># ,</span></span>
<span>    <span class="co"># logfile        = out_calib$logpath</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">timings</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We additionally showcase below how to parallelize multiple chains to
different cores (<code>n_parallel_independent = 8</code>) and thus how
to significantly speed up long-running calibration tasks.</p>
<p>For long-running calibrations it can also be useful to be able to
continue an existing sampling chain with
<code>continue_mcmc_rsofun()</code>. While this is not shown in this
vignette, code for this is available on Zenodo (<a href="https://dx.doi.org/10.5281/zenodo.17204361" class="external-link">10.5281/zenodo.17204361</a>).</p>
</div>
<div class="section level4">
<h4 id="run-calibration">Run calibration<a class="anchor" aria-label="anchor" href="#run-calibration"></a>
</h4>
<p>With these helper functions specified, we can then run the two
calibration setups. The sampled MCMC chains are stored to a specified
path so that they can easily be loaded at a later time in a separate R
session.</p>
<p>Below, the second setup is run a second time making use of parallel
sampling of the independent chains.</p>
<p>We make use of arguments of the user-defined function
<code>run_mcmc_rsofun()</code> that allow us to specify the calibration
setup, the MCMC setup, and the parallelization strategy.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"vignettes/files/param_calib_multitarget/"</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_timings226</span> <span class="op">&lt;-</span> <span class="fu">run_mcmc_rsofun</span><span class="op">(</span><span class="fl">226</span>, suffix_str <span class="op">=</span> <span class="st">"setup_226"</span>,</span>
<span>  outpath <span class="op">=</span> <span class="st">"vignettes/files/param_calib_multitarget/"</span>,</span>
<span>  <span class="co"># mcmc setup:</span></span>
<span>  sampler <span class="op">=</span> <span class="st">"DREAMzs"</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">600</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  n_chains_independent      <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  n_chains_within_sampler   <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  <span class="co"># parallelization</span></span>
<span>  n_parallel_independent    <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 2025-12-16 10:49:52.217434: start sampling of out_calib_setup_226.rds</span></span>
<span><span class="co"># runMCMC terminated after 4.39500000000407seconds00 . Current logp  -389.1087 -421.1468 -396.6275 Please wait!</span></span>
<span><span class="co"># runMCMC terminated after 3.95499999998719seconds00 . Current logp  -377.7371 -379.5134 -377.3347 Please wait!</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># runMCMC terminated after 4.23500000000058seconds00 . Current logp  -397.9886 -379.6501 -382.6354 Please wait!</span></span>
<span></span>
<span><span class="va">df_timings231</span> <span class="op">&lt;-</span> <span class="fu">run_mcmc_rsofun</span><span class="op">(</span><span class="fl">231</span>, suffix_str <span class="op">=</span> <span class="st">"setup_231"</span>,</span>
<span>  outpath <span class="op">=</span> <span class="st">"vignettes/files/param_calib_multitarget/"</span>,</span>
<span>  <span class="co"># mcmc setup:</span></span>
<span>  sampler <span class="op">=</span> <span class="st">"DREAMzs"</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">600</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  n_chains_independent      <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  n_chains_within_sampler   <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  <span class="co"># parallelization</span></span>
<span>  n_parallel_independent    <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 2025-12-16 10:51:14.211219: start sampling of out_calib_setup_231.rds</span></span>
<span><span class="co"># Running DREAM-MCMC, chain  1 iteration 300 of 600 . Current logp  -14645.97 -14571.83 -15471.88 Please wait!</span></span>
<span><span class="co"># runMCMC terminated after 16.8090000000084seconds00 . Current logp  -14616.55 -14462.62 -14529.8 Please wait!</span></span>
<span><span class="co"># Running DREAM-MCMC, chain  2 iteration 300 of 600 . Current logp  -16760.01 -15828.73 -14948.44 Please wait!</span></span>
<span><span class="co"># runMCMC terminated after 16.4020000000019seconds00 . Current logp  -14955.26 -14941.47 -14441.98 Please wait!</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># runMCMC terminated after 17.8410000000003seconds00 . Current logp  -15023.04 -14854.75 -14265.61 Please wait!</span></span>
<span></span>
<span><span class="va">df_timings231p</span> <span class="op">&lt;-</span> <span class="fu">run_mcmc_rsofun</span><span class="op">(</span><span class="fl">231</span>, suffix_str <span class="op">=</span> <span class="st">"setup_231_parallel"</span>,</span>
<span>  outpath <span class="op">=</span> <span class="st">"vignettes/files/param_calib_multitarget/"</span>,</span>
<span>  <span class="co"># mcmc setup:</span></span>
<span>  sampler <span class="op">=</span> <span class="st">"DREAMzs"</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">600</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  n_chains_independent      <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  n_chains_within_sampler   <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  <span class="co"># parallelization</span></span>
<span>  n_parallel_independent    <span class="op">=</span> <span class="fl">8</span>     <span class="co"># here now we parallelize the 8 chains to 8 cores</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 2025-12-16 10:52:17.880666: start sampling of out_calib_setup_231_parallel.rds</span></span>
<span><span class="co"># Writing MCMC sampling log to: files/param_calib_multitarget//calibrations/out_calib_setup_231_parallel.rds.log.txt</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># 2025-12-16 10:55:56.813577: end   sampling of out_calib_setup_231_parallel.rds.log.txt.</span></span>
<span><span class="co"># Written *.rds-output to: files/param_calib_multitarget//calibrations/out_calib_setup_231_parallel.rds</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calib_timings &lt;- bind_rows(</span></span>
<span><span class="co">#   df_timings226,</span></span>
<span><span class="co">#   df_timings231,</span></span>
<span><span class="co">#   df_timings231p)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">calib_timings</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".rds.log.txt"</span>, <span class="st">""</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>resultfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"vignettes/"</span>, <span class="st">""</span>, <span class="va">resultfile</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="4%">
<col width="14%">
<col width="3%">
<col width="3%">
<col width="5%">
<col width="4%">
<col width="7%">
<col width="2%">
<col width="5%">
<col width="7%">
<col width="41%">
</colgroup>
<thead><tr class="header">
<th align="right">scenario</th>
<th align="left">name</th>
<th align="left">sampler</th>
<th align="right">burnin</th>
<th align="right">iterations</th>
<th align="right">n_chains</th>
<th align="right">n_chains_inner</th>
<th align="right">cores</th>
<th align="left">cores_inner</th>
<th align="left">walltime</th>
<th align="left">resultfile</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">226</td>
<td align="left">out_calib_setup_226</td>
<td align="left">DREAMzs</td>
<td align="right">0</td>
<td align="right">600</td>
<td align="right">8</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="left">33.20891 secs</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="right">231</td>
<td align="left">out_calib_setup_231</td>
<td align="left">DREAMzs</td>
<td align="right">0</td>
<td align="right">600</td>
<td align="right">8</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="left">152.50835 secs</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="right">231</td>
<td align="left">out_calib_setup_231_parallel</td>
<td align="left">DREAMzs</td>
<td align="right">0</td>
<td align="right">600</td>
<td align="right">8</td>
<td align="right">3</td>
<td align="right">8</td>
<td align="left">FALSE</td>
<td align="left">41.92838 secs</td>
<td align="left">files/param_calib_multitarget//calibrations/out_calib_setup_231_parallel.rds.log.txt</td>
</tr>
</tbody>
</table>
<p>Note how the parallelized version reduced the walltime by 4x. With
additional independent MCMC chains (e.g. the rsofun documentation paper
used up to 8 chains), this can become important.</p>
<p>Since MCMC sampling can be long running tasks, the resulting MCMC
sampling chains are stored to disk, so that they can easily be recovered
in a later R session for an analysis similar to the one below.</p>
<p>During the paralell MCMC sampling the workers don’t send output to
the console. This is why a logfile is created and progress can be
checked there. The above example resulted in a common log file of all
eight workers:</p>
<pre><code>starting worker pid=43576 on localhost:11353 at 11:15:05.976
starting worker pid=43589 on localhost:11353 at 11:15:06.058
starting worker pid=43602 on localhost:11353 at 11:15:06.142
starting worker pid=43615 on localhost:11353 at 11:15:06.224
starting worker pid=43628 on localhost:11353 at 11:15:06.306
starting worker pid=43641 on localhost:11353 at 11:15:06.389
starting worker pid=43654 on localhost:11353 at 11:15:06.476
starting worker pid=43668 on localhost:11353 at 11:15:06.570
Loading required package: rsofun
loaded rsofun and set parent environment
...
 Running DREAM-MCMC, chain  1 iteration 300 of 600 . Current logp  -15821.4 ... Please wait! 
 Running DREAM-MCMC, chain  1 iteration 300 of 600 . Current logp  -15415.3 ... Please wait! 
 Running DREAM-MCMC, chain  1 iteration 300 of 600 . Current logp  -14739.4 ... Please wait! 
...
 Running DREAM-MCMC, chain  1 iteration 600 of 600 . Current logp  -14654.7 ... Please wait! 
runMCMC terminated after 36.634seconds
 Running DREAM-MCMC, chain  1 iteration 600 of 600 . Current logp  -14927.0 ... Please wait! 
runMCMC terminated after 40.068seconds</code></pre>
</div>
<div class="section level4">
<h4 id="analyze-model-calibration">Analyze model calibration<a class="anchor" aria-label="anchor" href="#analyze-model-calibration"></a>
</h4>
<p>After the MCMC sampling we could (potentially in a new R script),
load the sampled chains and analyse the chain convergence and posterior
distribution. To do so we load the previous results from RDS files:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This loads MCMC chains that might have been generated with a separate R script</span></span>
<span><span class="va">out_calib_226</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"files/param_calib_multitarget/calibrations/out_calib_setup_226.rds"</span><span class="op">)</span></span>
<span><span class="va">out_calib_231p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"files/param_calib_multitarget/calibrations/out_calib_setup_231_parallel.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We define some labelling changes to obtain nicer looking plots.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rsofun_symbol_parname_description</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">variable</span>,            <span class="op">~</span><span class="va">label</span>,                                                      <span class="op">~</span><span class="va">Symbol_R</span>,</span>
<span>  <span class="st">"kphio"</span>,              <span class="st">"italic(phi)[0]^'*'*' (mol mol-\u00B9)'"</span>,               <span class="st">"italic(phi)[0]^'*'"</span>,</span>
<span>  <span class="st">"kphio_par_a"</span>,        <span class="st">"italic(a)[italic(phi)]*' (\u00B0C-\u00B2)'"</span>,           <span class="st">"italic(a)[italic(phi)]"</span>,</span>
<span>  <span class="st">"kphio_par_b"</span>,        <span class="st">"italic(b)[italic(phi)]*' (\u00B0C)'"</span>,                       <span class="st">"italic(b)[italic(phi)]"</span>,</span>
<span>  <span class="st">"soilm_thetastar"</span>,    <span class="st">"italic(theta)^'*'*' ('*'mm'*')'"</span>,                           <span class="st">"italic(theta)^'*'"</span>,</span>
<span>  <span class="st">"soilm_betao"</span>,        <span class="st">"italic(beta)[0]*' (-)'"</span>,                                    <span class="st">"italic(beta)[0]"</span>,</span>
<span>  <span class="st">"beta_unitcostratio"</span>, <span class="st">"italic(beta)*' (-)'"</span>,                                       <span class="st">"italic(beta)"</span>,</span>
<span>  <span class="st">"rd_to_vcmax"</span>,        <span class="st">"italic(b)[0]*' (-)'"</span>,                                       <span class="st">"italic(b)[0]"</span>,</span>
<span>  <span class="st">"tau_acclim"</span>,         <span class="st">"italic(tau)*' (days)'"</span>,                                     <span class="st">"italic(tau)"</span>,</span>
<span>  <span class="st">"kc_jmax"</span>,            <span class="st">"italic(c)^'*'*' (-)'"</span>,                                      <span class="st">"italic(c)^'*'"</span>,</span>
<span>  <span class="st">"err_gpp"</span>,            <span class="st">"italic(sigma)['GPP']*' (gC m -\u00B2 s-\u00B9)'"</span>, <span class="st">"italic(sigma)['GPP']"</span>,</span>
<span>  <span class="st">"err_bigD13C"</span>,        <span class="st">"italic(sigma)[Delta]*' ('*'\u2030'*')'"</span>,                    <span class="st">"italic(sigma)[Delta]"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">label_vec_short</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">rsofun_symbol_parname_description</span><span class="op">$</span><span class="va">Symbol_R</span>, <span class="va">rsofun_symbol_parname_description</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span></span>
<span><span class="va">custom_labeller_variable</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">labels</span>, <span class="va">multi_line</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># adapted from label_parsed</span></span>
<span>  <span class="va">replaced_labels</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">labels</span>, <span class="va">variable</span><span class="op">)</span>, <span class="co"># NOTE: this has variable hardcoded</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">rsofun_symbol_parname_description</span>, <span class="va">variable</span>, <span class="va">label</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># print(tibble(replaced_labels))</span></span>
<span>  <span class="va">replaced_labels</span> <span class="op">&lt;-</span> <span class="va">replaced_labels</span> <span class="op">|&gt;</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">variable</span><span class="op">)</span></span>
<span>  <span class="va">replaced_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labellers.html" class="external-link">label_value</a></span><span class="op">(</span><span class="va">replaced_labels</span>, multi_line <span class="op">=</span> <span class="va">multi_line</span><span class="op">)</span></span>
<span>  <span class="co"># print(replaced_labels)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">replaced_labels</span><span class="op">)</span>, <span class="va">lapply</span>, <span class="kw">function</span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And we define a function <code>plot_mcmc_trace()</code> to plot a
trace plot of the MCMC sampling including Gelman-Rubin statistics to
easily assess convergence for the two calibration setups. For this
vignette examples we did not run the MCMC long enough to see converging
trace plots. In a real application, one would need to increase the
number of iterations. What we can see is the number of chains, which are
the 8 independent chains, each consisting of 3 internal chains for a
total of 24 traces in the plots. Note that the 3 internal chains also
reduce the length of the iterations from the specified 600 to 200.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define plotting function</span></span>
<span><span class="va">plot_mcmc_trace</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">out_calib</span>, <span class="va">nr_internal_chains</span>, <span class="va">burnin_to_skip</span>, <span class="va">burnin_to_skip_gelman</span> <span class="op">=</span> <span class="va">burnin_to_skip</span>, <span class="va">dont_thin</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">end</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">out_calib</span><span class="op">$</span><span class="va">mod</span></span>
<span>  <span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">out_calib</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">curr_iter</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">settings</span><span class="op">$</span><span class="va">iterations</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">dont_thin</span> <span class="op">||</span> <span class="va">curr_iter</span> <span class="op">&lt;</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curr_thin</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">curr_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">curr_iter</span> <span class="op">/</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">xsample</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span><span class="va">x</span>, coda <span class="op">=</span> <span class="cn">T</span>, thin <span class="op">=</span> <span class="va">curr_thin</span>, start <span class="op">=</span> <span class="va">burnin_to_skip</span>, end <span class="op">=</span> <span class="va">end</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># nr_internal_chains will have same color</span></span>
<span>  <span class="va">dat_to_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">xsample</span>, <span class="kw">function</span><span class="op">(</span><span class="va">single_chain</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">single_chain</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">mutate</span><span class="op">(</span>iteration <span class="op">=</span> <span class="va">burnin_to_skip</span> <span class="op">+</span> <span class="va">curr_thin</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"chain_id"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">iteration</span>, <span class="va">chain_id</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"variable"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># mark inner and outer chains (assumes DEzs or DREAMzs):</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>outerChain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">chain_id</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      innerChain <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">chain_id</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>      innerChain_str <span class="op">=</span> <span class="va">letters</span><span class="op">[</span><span class="va">innerChain</span><span class="op">]</span>,</span>
<span>      chain_id_str <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">outerChain</span>, <span class="va">letters</span><span class="op">[</span><span class="va">innerChain</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co">#|&gt;</span></span>
<span>  <span class="co"># fix order: in order of appearance</span></span>
<span>  <span class="co"># mutate(variable = forcats::as_factor(variable))</span></span>
<span></span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dat_to_plot</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">outerChain</span>, linetype <span class="op">=</span> <span class="va">innerChain_str</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># geom_rug(sides = "r") +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>,  nrow <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, labeller <span class="op">=</span> <span class="va">custom_labeller_variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>, strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">""</span>, color <span class="op">=</span> <span class="st">"chain"</span>, linetype <span class="op">=</span> <span class="st">"internal\nchains"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># add Gelman Diagnostics</span></span>
<span>  <span class="va">get_gelman_diag</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mcmc</span>, <span class="va">burnin_to_skip</span>, <span class="va">end</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gelman_df</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/gelmanDiagnostics.html" class="external-link">gelmanDiagnostics</a></span><span class="op">(</span><span class="va">mcmc</span>, start <span class="op">=</span> <span class="va">burnin_to_skip</span>, end <span class="op">=</span> <span class="va">end</span><span class="op">)</span></span>
<span>    <span class="va">psrf_values</span> <span class="op">&lt;-</span> <span class="va">gelman_df</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>, <span class="st">"Point est."</span><span class="op">]</span></span>
<span>    <span class="co"># psrf_strings &lt;- paste0(substr(names(psrf_values),1,5), "..=", sprintf("%.2f", psrf_values))</span></span>
<span>    <span class="va">psrf_strings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"'*"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">label_vec_short</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">psrf_values</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="st">"*'="</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">psrf_values</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">psrf_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">psrf_strings</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">subtitle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"'GelmanDiagnostics: mpsrf=%.1f; psrf:%s'"</span>,</span>
<span>      <span class="va">gelman_df</span><span class="op">$</span><span class="va">mpsrf</span>,</span>
<span>      <span class="va">psrf_string</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">subtitle</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu">get_gelman_diag</span><span class="op">(</span><span class="va">x</span>, <span class="va">burnin_to_skip_gelman</span> <span class="op">+</span> <span class="fl">1</span>, end <span class="op">=</span> <span class="va">end</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">e</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="co"># unsure why min burnin of 1 is needed</span></span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">pl</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="va">title</span>, subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">subtitle</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">pl</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">burnin_to_skip_gelman</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pl</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_mcmc_trace</span><span class="op">(</span><span class="va">out_calib_226</span>, nr_internal_chains <span class="op">=</span> <span class="fl">3</span>, burnin_to_skip <span class="op">=</span> <span class="fl">0</span>, burnin_to_skip_gelman <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span></code></pre></div>
<p><img src="param_calib_multitarget_files/figure-html/plot%20MCMC%20trace%20plot-1.png" class="r-plt" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_mcmc_trace</span><span class="op">(</span><span class="va">out_calib_231p</span>, nr_internal_chains <span class="op">=</span> <span class="fl">3</span>, burnin_to_skip <span class="op">=</span> <span class="fl">0</span>, burnin_to_skip_gelman <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span></code></pre></div>
<p><img src="param_calib_multitarget_files/figure-html/plot%20MCMC%20trace%20plot-2.png" class="r-plt" width="672"></p>
<p>We illustrate the posterior (derived from these unconverged example
MCMC chains) by defining a function
<code>plot_prior_posterior_density()</code> that shows the prior and
posterior distributions.</p>
<p>We can clearly distinguish the different priors used in the the two
setups, and how the calibration constrains the posteriors to different
parameter values.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_prior_posterior_density</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">burnin_to_skip</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/florianhartig/BayesianTools" class="external-link">BayesianTools</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get matrices of prior and posterior samples</span></span>
<span>  <span class="va">posteriorMat</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span><span class="va">x</span>, parametersOnly <span class="op">=</span> <span class="cn">TRUE</span>, start <span class="op">=</span> <span class="va">burnin_to_skip</span><span class="op">)</span></span>
<span>  <span class="va">priorMat</span> <span class="op">&lt;-</span>  <span class="fu">BayesianTools</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSetup.html" class="external-link">getSetup</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="fu">sampler</span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span> <span class="co"># nPriorDraws = 10000</span></span>
<span></span>
<span>  <span class="co"># Parameter names</span></span>
<span>  <span class="va">parNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">posteriorMat</span><span class="op">)</span></span>
<span>  <span class="co"># rename columns priorMat</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">priorMat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">parNames</span></span>
<span></span>
<span>  <span class="co"># Create data frame for plotting</span></span>
<span>  <span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">priorMat</span>,     par_estimation <span class="op">=</span> <span class="st">"prior"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">posteriorMat</span>, par_estimation <span class="op">=</span> <span class="st">"posterior"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># dplyr::mutate(par_estimation = forcats::fct_inorder(par_estimation)) |&gt; # order by appearance</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">$</span><span class="va">par_estimation</span><span class="op">)</span></span>
<span>  <span class="co"># Plot with facet wrap</span></span>
<span>  <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">df_plot</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par_estimation</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"variable"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># dplyr::mutate(variable = forcats::fct_inorder(variable)) |&gt; # order by appearance</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">par_estimation</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>,  nrow <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free"</span>, labeller <span class="op">=</span> <span class="va">custom_labeller_variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># facet_wrap( ~ variable , nrow = 2, scales = "free") +</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>      axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>,</span>
<span>      axis.ticks.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="cn">NULL</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"posterior"</span> <span class="op">=</span> <span class="st">"#29a274ff"</span>,</span>
<span>      <span class="st">"prior"</span> <span class="op">=</span> <span class="st">"#777055ff"</span><span class="op">)</span><span class="op">)</span> <span class="co"># GECO colors</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">plot_prior_posterior_density</span><span class="op">(</span><span class="va">out_calib_226</span><span class="op">$</span><span class="va">mod</span>,  burnin_to_skip <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="va">out_calib_226</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: BayesianTools</span></span>
<span><span class="co">#&gt; Loading required package: tidyr</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">plot_prior_posterior_density</span><span class="op">(</span><span class="va">out_calib_231p</span><span class="op">$</span><span class="va">mod</span>, burnin_to_skip <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="va">out_calib_231p</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="param_calib_multitarget_files/figure-html/plot%20parameter%20distributions-1.png" class="r-plt" width="672"></p>
<p>The joint prior distributions of the parameters can be assessed for
correlation between parameters, indicating compensating effects between
them which is often also called equifinality - same model output with
different parameter sets.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/correlationPlot.html" class="external-link">correlationPlot</a></span><span class="op">(</span><span class="va">out_calib_231p</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="param_calib_multitarget_files/figure-html/plot%20parameter%20correlation-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level4">
<h4 id="compare-predictions-of-the-calibrated-model-with-observations">Compare predictions of the calibrated model with observations<a class="anchor" aria-label="anchor" href="#compare-predictions-of-the-calibrated-model-with-observations"></a>
</h4>
<p>Eventually, we want to use the calibrated model for predictions and
also check their agreement with the observations used for calibration.
For that we define another helper function
<code>run_prediction_rsofun()</code>, which samples parameter sets from
the MCMC chain to make predictions. A second function samples errors
from the identified structural uncertainty (error model) and combines
them with the predictions. To do so they use helper functions
(<code>setup_rsofun_calibration()</code>,
<code>apply_bias_correction_and_sample_error()</code>, and
<code>predict_sofun_parallelized()</code>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Samples posterior parameters (MAP or N=n_samples) and runs</span></span>
<span><span class="co"># model predictions</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># This allows to do two things:</span></span>
<span><span class="co"># A) make predictions at sites/dates/... where we have observations</span></span>
<span><span class="co"># B) make predictions also  on dates/... where we have no observations, e.g. for continuous time series</span></span>
<span><span class="co"># we do B) once {by setting `return_continuous_timeseries = TRUE`} and then derive A) from it.</span></span>
<span><span class="va">run_prediction_rsofun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">mcmc_posterior</span>,</span>
<span>    <span class="va">prediction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"both"</span>, <span class="st">"test"</span>, <span class="st">"train"</span><span class="op">)</span>,</span>
<span>    <span class="va">burnin_to_skip</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    <span class="va">n_samples</span> <span class="op">=</span> <span class="fl">100</span>,      <span class="co"># if n_samples == 1, use MAP</span></span>
<span>    <span class="va">n_cores</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">prediction</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"both"</span>, <span class="st">"test"</span>, <span class="st">"train"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># as expected</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Provide prediction as either: 'both', 'test' or 'train'"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">n_cores</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu">is</span><span class="op">(</span><span class="va">mcmc_posterior</span><span class="op">$</span><span class="va">mod</span>, <span class="st">"mcmcSamplerList"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">curr_calibration_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span></span>
<span>    <span class="st">".*_setup_([0-9]*)_.*"</span>,  <span class="co"># NOTE: hardcoded expected format of filename</span></span>
<span>    <span class="st">"\\1"</span>,</span>
<span>    <span class="va">mcmc_posterior</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">curr_calibration_scenario</span><span class="op">)</span><span class="op">)</span> <span class="co"># Catches if expected format is inaccurate</span></span>
<span></span>
<span>  <span class="co"># Setup simulation model</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">setup_rsofun_calibration</span><span class="op">(</span>scenario <span class="op">=</span> <span class="va">curr_calibration_scenario</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Set random seed for reproducibility</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2023</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Sample parameters from MCMC posterior</span></span>
<span>  <span class="co"># Evaluation of the uncertainty coming from the model parameters' uncertainty</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n_samples</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">samples_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/getSample.html" class="external-link">getSample</a></span><span class="op">(</span></span>
<span>      <span class="va">mcmc_posterior</span><span class="op">$</span><span class="va">mod</span>,</span>
<span>      thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      start <span class="op">=</span> <span class="va">burnin_to_skip</span>, numSamples <span class="op">=</span> <span class="va">n_samples</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="co"># Add sample IDs</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>posterior_sample_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">posterior_sample_id</span>, .key <span class="op">=</span> <span class="st">"pars"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># mcmc_posterior$par # these are already precomputed...</span></span>
<span>    <span class="co"># but more robust to recompute:</span></span>
<span>    <span class="va">samples_par</span> <span class="op">&lt;-</span> <span class="fu">BayesianTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BayesianTools/man/MAP.html" class="external-link">MAP</a></span><span class="op">(</span><span class="va">mcmc_posterior</span><span class="op">$</span><span class="va">mod</span><span class="op">)</span><span class="op">$</span><span class="va">parametersMAP</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="co"># Add sample IDs</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>posterior_sample_id <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># posterior_sample_id == 0 means MAP</span></span>
<span>      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">posterior_sample_id</span>, .key <span class="op">=</span> <span class="st">"pars"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Setup prediction</span></span>
<span>  <span class="va">predict_sofun_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n_cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">prediction</span> <span class="op">==</span> <span class="st">"both"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curr_driver</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">res</span><span class="op">$</span><span class="va">drivobs_test</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">params_siml</span>, <span class="va">site_info</span>, <span class="va">forcing</span><span class="op">)</span></span>
<span>    <span class="va">curr_obs</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">res</span><span class="op">$</span><span class="va">drivobs_test</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">targets</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">prediction</span> <span class="op">==</span> <span class="st">"train"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curr_driver</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">sitename</span>, <span class="va">params_siml</span>, <span class="va">site_info</span>, <span class="va">forcing</span><span class="op">)</span></span>
<span>    <span class="va">curr_obs</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_train</span>, <span class="va">sitename</span>, <span class="va">targets</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">prediction</span> <span class="op">==</span> <span class="st">"test"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curr_driver</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_test</span>, <span class="va">sitename</span>, <span class="va">params_siml</span>, <span class="va">site_info</span>, <span class="va">forcing</span><span class="op">)</span></span>
<span>    <span class="va">curr_obs</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">drivobs_test</span>, <span class="va">sitename</span>, <span class="va">targets</span>, <span class="va">data</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">curr_obs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Run prediction</span></span>
<span>  <span class="va">df_pred_vs_obs</span> <span class="op">&lt;-</span> <span class="fu">predict_sofun_parallelized</span><span class="op">(</span></span>
<span>    drivers     <span class="op">=</span> <span class="va">curr_driver</span>,</span>
<span>    obs         <span class="op">=</span> <span class="va">curr_obs</span>,</span>
<span>    settings    <span class="op">=</span> <span class="va">predict_sofun_settings</span>,</span>
<span>    par         <span class="op">=</span> <span class="va">samples_par</span>,</span>
<span>    par_fixed   <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">par_fixed</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df_pred_vs_obs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Runs the requested model predictions and returns results</span></span>
<span><span class="co"># Requested model predictions are defined by data.frame `par_df` containing</span></span>
<span><span class="co"># model parameter sets</span></span>
<span><span class="va">predict_sofun_parallelized</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">drivers</span>,</span>
<span>    <span class="va">obs</span>,</span>
<span>    <span class="va">settings</span>,</span>
<span>    <span class="va">par_fixed</span>,</span>
<span>    <span class="va">par_df</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Set number of cores if not specified</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span> <span class="co"># at most 20</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># ensure not more than needed</span></span>
<span>  <span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span>, <span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Function to run prediction for a single parameter set</span></span>
<span>  <span class="va">run_pmodel_single_prediction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">par_fixed</span>, <span class="va">drivers</span>, <span class="va">obs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Function that runs the P-model for a sample of parameters</span></span>
<span>    <span class="co"># but does not add the observation error</span></span>
<span></span>
<span>    <span class="co"># Taken from cost_likelihood_pmodel()</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>     <span class="co"># ensure some observation data are provided</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">drivers</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># ensure some driver data are provided</span></span>
<span></span>
<span>    <span class="co"># A) Include current parameters ----</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par_fixed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># no overlap</span></span>
<span>    <span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">par</span>, <span class="va">par_fixed</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># B,C) Run model and bring together with observed ----</span></span>
<span>    <span class="va">df_pred_vs_obs</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">:::</span><span class="fu"><a href="../reference/get_mod_obs_pmodel.html">get_mod_obs_pmodel</a></span><span class="op">(</span></span>
<span>      <span class="va">drivers</span>,</span>
<span>      <span class="va">obs</span>,</span>
<span>      <span class="va">params_modl</span>,</span>
<span>      parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      ncores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      return_continuous_timeseries <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># D) (DON'T) Sample error model ----</span></span>
<span>    <span class="co"># NOTE: sampling is not done here, but can optionally be done before plotting</span></span>
<span>    <span class="co">#       Here we rename to clarify that no error model has yet been applied.</span></span>
<span>    <span class="va">df_pred_vs_obs</span> <span class="op">&lt;-</span> <span class="va">df_pred_vs_obs</span> <span class="op">|&gt;</span></span>
<span>      <span class="co"># clarify name of model output (containing not yet any error model term)</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>mod_no_err <span class="op">=</span> <span class="va">mod</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod_no_err</span>, <span class="va">err_par_sd</span><span class="op">)</span>, .after <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">last_col</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df_pred_vs_obs</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Run the P-model predictions for each set of parameters</span></span>
<span>  <span class="co">## Prepare parallelization:</span></span>
<span>  <span class="va">parallel_flag</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">par_df</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="co"># setup helpers for conditional parallelization</span></span>
<span>  <span class="va">do_if</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">cond</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span> <span class="co"># enable conditional lines in dplyr piping</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cond</span><span class="op">)</span> <span class="fu">f</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="kw">else</span> <span class="va">df</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">parallel_flag</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/new_cluster.html" class="external-link">new_cluster</a></span><span class="op">(</span><span class="va">settings</span><span class="op">$</span><span class="va">n_cores</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/cluster_utils.html" class="external-link">cluster_library</a></span><span class="op">(</span></span>
<span>        packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"purrr"</span>, <span class="st">"rsofun"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">## Run predictions:</span></span>
<span>  <span class="va">df_model_predictions</span> <span class="op">&lt;-</span> <span class="va">par_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">do_if</span><span class="op">(</span><span class="va">parallel_flag</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/partition.html" class="external-link">partition</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">cl</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"sim"</span> <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>      <span class="va">pars</span>,</span>
<span>      <span class="op">~</span> <span class="fu">run_pmodel_single_prediction</span><span class="op">(</span></span>
<span>        par <span class="op">=</span> <span class="va">.x</span>,</span>
<span>        <span class="va">par_fixed</span>,</span>
<span>        <span class="va">drivers</span>,</span>
<span>        <span class="va">obs</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">do_if</span><span class="op">(</span><span class="va">parallel_flag</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df_model_predictions</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">apply_bias_correction_and_sample_error</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df_pred</span>, <span class="va">N_sample_error</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1982</span><span class="op">)</span></span>
<span>  <span class="va">df_pred</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># lazy_dt() |&gt;   # if needed, uses lazy data.table and dtplyr for speed</span></span>
<span>    <span class="co"># a) repeat lines: once for each sampled error</span></span>
<span>    <span class="co"># following line is basically a cross_join: with</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">N_sample_error</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>error_sample_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_sample_error</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">N_sample_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">posterior_sample_id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># b) sample the error:</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">err_par_sd</span>, <span class="va">err_par_bias</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>err_sample                <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,   sd <span class="op">=</span> <span class="va">err_par_sd</span><span class="op">)</span>,</span>
<span>      mod_biasremoved_no_err    <span class="op">=</span> <span class="va">mod_no_err</span> <span class="op">-</span> <span class="va">err_par_bias</span>,</span>
<span>      mod_biasremoved_with_err  <span class="op">=</span> <span class="va">mod_no_err</span> <span class="op">-</span> <span class="va">err_par_bias</span> <span class="op">+</span> <span class="va">err_sample</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># to access results of lazy dtplyr-computation as normal tibble()</span></span>
<span>    <span class="co"># keep output light: i.e. remove unneded columns:</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">err_sample</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html" class="external-link">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With these functions we can generate the predictions using e.g. the
Maximum-A-Posteriori (MAP) parameters as well as <code>n=20</code>
samples from the posterior.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get MAP and run model for MAP parameter set</span></span>
<span><span class="va">df_predict_MAP_train_231p</span> <span class="op">&lt;-</span> <span class="fu">run_prediction_rsofun</span><span class="op">(</span></span>
<span>  mcmc_posterior <span class="op">=</span> <span class="va">out_calib_231p</span>,</span>
<span>  prediction     <span class="op">=</span> <span class="st">"train"</span>,</span>
<span>  burnin_to_skip <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  n_samples      <span class="op">=</span> <span class="fl">1</span>, <span class="co"># n_samples == 1, requests MAP</span></span>
<span>  n_cores        <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># this could be increased e.g. to 4</span></span>
<span></span>
<span><span class="co"># get parameter samples and run model for thes parameter sets</span></span>
<span><span class="va">df_predict_train_231p</span> <span class="op">&lt;-</span> <span class="fu">run_prediction_rsofun</span><span class="op">(</span></span>
<span>  mcmc_posterior <span class="op">=</span> <span class="va">out_calib_231p</span>,</span>
<span>  prediction     <span class="op">=</span> <span class="st">"train"</span>,</span>
<span>  burnin_to_skip <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  n_samples      <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  n_cores        <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># this could be increased e.g. to 4</span></span>
<span></span>
<span><span class="va">df_predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co"># df_predict_test      |&gt; mutate(is_train0_test1 = 1L, is_MAP = FALSE),</span></span>
<span>  <span class="va">df_predict_train_231p</span>     <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_train0_test1 <span class="op">=</span> <span class="fl">0L</span>, is_MAP <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="co"># df_predict_MAP_test  |&gt; mutate(is_train0_test1 = 1L, is_MAP = TRUE),</span></span>
<span>  <span class="va">df_predict_MAP_train_231p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_train0_test1 <span class="op">=</span> <span class="fl">0L</span>, is_MAP <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Free memory:</span></span>
<span><span class="co"># rm(df_predict_train_231p,</span></span>
<span><span class="co">#    df_predict_MAP_train_231p)</span></span>
<span></span>
<span><span class="co"># df_predict_params&lt;- df_predict |&gt; select(posterior_sample_id, is_train0_test1, is_MAP, pars) |&gt; unnest(pars)</span></span>
<span><span class="va">df_predict_gpp</span>     <span class="op">&lt;-</span> <span class="va">df_predict</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">posterior_sample_id</span>, <span class="va">is_train0_test1</span>, <span class="va">is_MAP</span>, <span class="va">sim</span><span class="op">)</span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target</span> <span class="op">==</span> <span class="st">"gpp"</span><span class="op">)</span>     <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">obs_metadata</span><span class="op">)</span></span>
<span><span class="va">df_predict_bigD13C</span> <span class="op">&lt;-</span> <span class="va">df_predict</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">posterior_sample_id</span>, <span class="va">is_train0_test1</span>, <span class="va">is_MAP</span>, <span class="va">sim</span><span class="op">)</span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target</span> <span class="op">==</span> <span class="st">"bigD13C"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">obs_metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply bias-correction and simulate structural error</span></span>
<span><span class="va">N_sample_error</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">df_predict_231p_gpp_sampled</span> <span class="op">&lt;-</span> <span class="fu">apply_bias_correction_and_sample_error</span><span class="op">(</span></span>
<span>  <span class="va">df_predict_gpp</span>,</span>
<span>  N_sample_error <span class="op">=</span> <span class="va">N_sample_error</span><span class="op">)</span></span>
<span><span class="va">df_predict_231p_bigD13C_sampled</span> <span class="op">&lt;-</span> <span class="fu">apply_bias_correction_and_sample_error</span><span class="op">(</span></span>
<span>  <span class="va">df_predict_bigD13C</span>,</span>
<span>  N_sample_error <span class="op">=</span> <span class="va">N_sample_error</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save predictions to plot with separate script:</span></span>
<span><span class="co"># FOR STORAGE REASONS unnest the obs_metadata and save different targets separately:</span></span>
<span><span class="co"># out_prediction_template &lt;- file.path("files/param_calib_multitarget/",</span></span>
<span><span class="co">#                                       "predictions", "pred_231p_XXX.rds")</span></span>
<span><span class="co"># dir.create(dirname(out_prediction_template), showWarnings = FALSE)</span></span>
<span><span class="co"># fname_out_gpp     &lt;- gsub("_XXX",</span></span>
<span><span class="co">#                           paste0(    "_gpp_sampled_N", N_sample_error, "errors"),</span></span>
<span><span class="co">#                           out_prediction_template)</span></span>
<span><span class="co"># fname_out_bigD13C &lt;- gsub("_XXX",</span></span>
<span><span class="co">#                           paste0("_bigD13C_sampled_N", N_sample_error, "errors"),</span></span>
<span><span class="co">#                           out_prediction_template)</span></span>
<span><span class="co"># df_predict_231p_gpp_sampled     |&gt;</span></span>
<span><span class="co">#   select(posterior_sample_id,error_sample_id,is_train0_test1,is_MAP,sitename,target,obs,   date,err_par_bias,err_par_sd,mod_no_err,mod_biasremoved_no_err,mod_biasremoved_with_err) |&gt;</span></span>
<span><span class="co">#   saveRDS(fname_out_gpp,     compress = "xz")</span></span>
<span><span class="co"># df_predict_231p_bigD13C_sampled |&gt;</span></span>
<span><span class="co">#   select(posterior_sample_id,error_sample_id,is_train0_test1,is_MAP,sitename,target,obs,id,     err_par_bias,err_par_sd,mod_no_err,mod_biasremoved_no_err,mod_biasremoved_with_err) |&gt;</span></span>
<span><span class="co">#   saveRDS(fname_out_bigD13C, compress = "xz")</span></span>
<span></span>
<span><span class="co"># Load predictions for plotting with separate script:</span></span>
<span><span class="co"># df_predict_231p_gpp_sampled     &lt;- readRDS("files/param_calib_multitarget//predictions/pred_231p_gpp_sampled_N3errors.rds")</span></span>
<span><span class="co"># df_predict_231p_bigD13C_sampled &lt;- readRDS("files/param_calib_multitarget//predictions/pred_231p_bigD13C_sampled_N3errors.rds")</span></span>
<span><span class="co"># df_predict_231p_bigD13C_sampled &lt;- readr::read_rds(paste0("/storage/scratch/giub_geco/fbernhard/rsofun_doc_outputs/data/predictions/out_predict_",n_post,"_30000burnin__out_calib__scen222_DREAMzs-100000-0iter_8x3chains_on_CPU8x1_continued.rds_vj_sampled",n_err,".rds"))</span></span>
<span><span class="co"># df_predict_231p_gpp_sampled     &lt;- readr::read_rds(paste0("/storage/scratch/giub_geco/fbernhard/rsofun_doc_outputs/data/predictions/out_predict_",n_post,"_30000burnin__out_calib__scen222_DREAMzs-100000-0iter_8x3chains_on_CPU8x1_continued.rds_gpp_sampled",n_err,".rds"))</span></span></code></pre></div>
<p>With a function <code>plot_predobs_gpp_timeseries3()</code> and
<code>analyse_modobs3()</code>, model output and observations can be
compared as either time series plots or as scatter plots.</p>
<p>Below we plot a time series comparing predictions with observations,
we can distinguish the parametric uncertainty (‘Posterior’) related to
the width of the posterior distribtution of the parameters and
structural uncertainty (or model uncertainty) that includes the samples
of the error model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add transparency to colors</span></span>
<span><span class="va">t_col</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">color</span>, <span class="va">percent</span> <span class="op">=</span> <span class="fl">50</span>, <span class="va">name</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#      color = color name</span></span>
<span>  <span class="co">#    percent = % transparency</span></span>
<span>  <span class="co">#       name = an optional name for the color</span></span>
<span>  <span class="va">rgb.val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/col2rgb.html" class="external-link">col2rgb</a></span><span class="op">(</span><span class="va">color</span><span class="op">)</span> <span class="co"># Get RGB values for named color</span></span>
<span>  <span class="co">## Make new color using input color as base and alpha set by transparency</span></span>
<span>  <span class="va">t.col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span></span>
<span>    <span class="va">rgb.val</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">rgb.val</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">rgb.val</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>    max <span class="op">=</span> <span class="fl">255</span>,</span>
<span>    alpha <span class="op">=</span> <span class="op">(</span><span class="fl">100</span> <span class="op">-</span> <span class="va">percent</span><span class="op">)</span> <span class="op">*</span> <span class="fl">255</span> <span class="op">/</span> <span class="fl">100</span>,</span>
<span>    names <span class="op">=</span> <span class="va">name</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">t.col</span><span class="op">)</span> <span class="co">## Save the color</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## copied from sofunCalVal package (and adapted to analyse_modobs3)</span></span>
<span><span class="va">analyse_modobs3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>,</span>
<span>                            <span class="va">mod</span>,</span>
<span>                            <span class="va">obs</span>,</span>
<span>                            <span class="va">type</span> <span class="op">=</span> <span class="st">"points"</span>,</span>
<span>                            <span class="va">filnam</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                            <span class="va">relative</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            <span class="va">lower_xlim</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                            <span class="va">use_factor</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                            <span class="va">shortsubtitle</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            <span class="va">plot_subtitle</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            <span class="va">plot_linmod</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            <span class="va">pal</span> <span class="op">=</span> <span class="st">"batlowW"</span>,</span>
<span>                            <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># if (identical(filnam, NA)) filnam &lt;- "analyse_modobs.pdf"</span></span>
<span></span>
<span>  <span class="co">## rename to 'mod' and 'obs' and remove rows with NA in mod or obs</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mod <span class="op">=</span> <span class="va">mod</span>, obs <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">mod</span>, <span class="va">obs</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## get linear regression (coefficients)</span></span>
<span>  <span class="va">linmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">obs</span> <span class="op">~</span> <span class="va">mod</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## construct metrics table using the 'yardstick' library</span></span>
<span>  <span class="va">df_metrics</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metrics.html" class="external-link">metrics</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.metric <span class="op">=</span> <span class="st">"n"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>, .estimate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">df</span>, numb <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.metric <span class="op">=</span> <span class="st">"slope"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>, .estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">linmod</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="co"># dplyr::bind_rows( tibble( .metric = "nse",      .estimator = "standard", .estimate = hydroGOF::NSE( obs, mod, na.rm=TRUE ) ) ) %&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.metric <span class="op">=</span> <span class="st">"mean_obs"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>, .estimate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">df</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      .metric <span class="op">=</span> <span class="st">"prmse"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>,</span>
<span>      .estimate <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.metric</span> <span class="op">==</span> <span class="st">"rmse"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.metric</span> <span class="op">==</span> <span class="st">"mean_obs"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>      .metric <span class="op">=</span> <span class="st">"pmae"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>,</span>
<span>      .estimate <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.metric</span> <span class="op">==</span> <span class="st">"mae"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.metric</span> <span class="op">==</span> <span class="st">"mean_obs"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.metric <span class="op">=</span> <span class="st">"bias"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>, .estimate <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">mod</span> <span class="op">-</span> <span class="va">obs</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.metric <span class="op">=</span> <span class="st">"pbias"</span>, .estimator <span class="op">=</span> <span class="st">"standard"</span>, .estimate <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">mod</span> <span class="op">-</span> <span class="va">obs</span><span class="op">)</span> <span class="op">/</span> <span class="va">obs</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rsq_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"rsq"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">rmse_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"rmse"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">mae_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"mae"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">bias_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"bias"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">slope_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"slope"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">n_val</span> <span class="op">&lt;-</span> <span class="va">df_metrics</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"n"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">relative</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">rmse_val</span> <span class="op">&lt;-</span> <span class="va">rmse_val</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">bias_val</span> <span class="op">&lt;-</span> <span class="va">bias_val</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">rsq_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">rsq_val</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">rmse_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">rmse_val</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">mae_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">mae_val</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">bias_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">bias_val</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">slope_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">slope_val</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">n_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">n_val</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>rsq <span class="op">=</span> <span class="va">rsq_val</span>, rmse <span class="op">=</span> <span class="va">rmse_val</span>, mae <span class="op">=</span> <span class="va">mae_val</span>, bias <span class="op">=</span> <span class="va">bias_val</span>, slope <span class="op">=</span> <span class="va">slope_val</span>, n <span class="op">=</span> <span class="va">n_val</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">shortsubtitle</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">subtitle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">italic</span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">rsq_lab</span><span class="op">)</span> <span class="op">~</span> <span class="op">~</span></span>
<span>      <span class="va">RMSE</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">rmse_lab</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">subtitle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">italic</span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">rsq_lab</span><span class="op">)</span> <span class="op">~</span> <span class="op">~</span></span>
<span>      <span class="va">RMSE</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">rmse_lab</span><span class="op">)</span> <span class="op">~</span> <span class="op">~</span></span>
<span>      <span class="va">bias</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">bias_lab</span><span class="op">)</span> <span class="op">~</span> <span class="op">~</span></span>
<span>      <span class="va">slope</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">slope_lab</span><span class="op">)</span> <span class="op">~</span> <span class="op">~</span></span>
<span>      <span class="fu">italic</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">==</span> <span class="fu">.</span><span class="op">(</span><span class="va">n_lab</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"hex"</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">upper_xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mod</span>, <span class="fl">0.9999</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span>, <span class="fl">0.9999</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">lower_xlim</span><span class="op">)</span> <span class="op">||</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">lower_xlim</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lower_xlim</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">lower_xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">lower_xlim</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mod</span>, <span class="fl">0.0001</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span>, <span class="fl">0.0001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="va">lower_xlim</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## ggplot hexbin</span></span>
<span>    <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mod</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">50</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="co"># geom_hline(yintercept = 0, linetype = "dotted") +</span></span>
<span>      <span class="co"># geom_vline(xintercept = 0, linetype = "dotted") +</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="va">lower_xlim</span>, <span class="va">upper_xlim</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">lower_xlim</span>, <span class="va">upper_xlim</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mod</span>, y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">pal</span> <span class="op">==</span> <span class="st">"batlowW"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span> <span class="fu">khroma</span><span class="fu">::</span><span class="fu"><a href="https://packages.tesselle.org/khroma/reference/scale_crameri_batlowW.html" class="external-link">scale_fill_batlowW</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">pal</span> <span class="op">==</span> <span class="st">"davos"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span> <span class="fu">khroma</span><span class="fu">::</span><span class="fu"><a href="https://packages.tesselle.org/khroma/reference/scale_crameri_davos.html" class="external-link">scale_fill_davos</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">plot_subtitle</span><span class="op">)</span> <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="va">subtitle</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">plot_linmod</span><span class="op">)</span> <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">filnam</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="va">filnam</span>, width <span class="op">=</span> <span class="fl">5</span>, height <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df_metrics <span class="op">=</span> <span class="va">df_metrics</span>, gg <span class="op">=</span> <span class="va">gg</span>, linmod <span class="op">=</span> <span class="va">linmod</span>, results <span class="op">=</span> <span class="va">results</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plot_predobs_gpp_timeseries3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ts_to_plot</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># separate obs</span></span>
<span>  <span class="va">df_tsplot_gpp_obs</span> <span class="op">&lt;-</span> <span class="va">ts_to_plot</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">target</span>, <span class="va">date</span>, <span class="va">obs</span>, <span class="va">Scenario</span>, <span class="va">dataset</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># compute stats of sampled distributions before plotting them</span></span>
<span>  <span class="va">tibble_to_plot</span> <span class="op">&lt;-</span> <span class="va">ts_to_plot</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">target</span> <span class="op">==</span> <span class="st">"gpp"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># dtplyr::lazy_dt() |&gt; # THIS WAS NEEDED FOR THE FULL DATA.FRAME</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Scenario</span>, <span class="va">dataset</span>, <span class="va">parameters</span>, <span class="va">sitename</span>, <span class="va">target</span>, <span class="va">date</span>, <span class="va">model_output_type</span>, <span class="va">y_facet</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span> <span class="co"># mod_no_err_p50 = quantile(mod_no_err, 0.5),</span></span>
<span>      modelled_p50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">modelled</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      modelled_p95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">modelled</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>      modelled_p05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">modelled</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># and bind back obsevations</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>      <span class="va">df_tsplot_gpp_obs</span>,</span>
<span>      by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">target</span>, <span class="va">date</span>, <span class="va">Scenario</span>, <span class="va">dataset</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">n_sites</span> <span class="op">&lt;-</span> <span class="va">tibble_to_plot</span><span class="op">$</span><span class="va">sitename</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pl_timeseries_gpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">tibble_to_plot</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">modelled_p50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Observations underneath (following Cameron 2022)</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">parameters</span>, <span class="op">-</span><span class="va">model_output_type</span>, <span class="op">-</span><span class="va">y_facet</span>, <span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"modelled"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="co"># data = df_tsplot_gpp_obs, # variant 1, but does not allow %+%-replacement of underlying data</span></span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">obs</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>, shape <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Structural uncertainty (including error model), a.k.a prediction band</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>      alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"with struct. uncert."</span><span class="op">)</span>,</span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">modelled_p05</span>, ymax <span class="op">=</span> <span class="va">modelled_p95</span>, fill <span class="op">=</span> <span class="st">"Post.+Error"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># Parametric uncertainty (without error model, only parameter sampling), a.k.a confidence band</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>      alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>      data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"rsofun"</span><span class="op">)</span>,</span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">modelled_p05</span>, ymax <span class="op">=</span> <span class="va">modelled_p95</span>, fill <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"rsofun"</span><span class="op">)</span>,</span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">modelled_p50</span>, color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># layout</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sitename</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="cn">NULL</span>, <span class="co">#' Date',</span></span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"GPP (g C m"</span><span class="op">^</span><span class="op">-</span><span class="fl">2</span>, <span class="st">"s"</span><span class="op">^</span><span class="op">-</span><span class="fl">1</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="cn">NULL</span>, aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"colour"</span>, <span class="st">"fill"</span><span class="op">)</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Post.+Error"</span>,</span>
<span>        <span class="st">"Posterior"</span><span class="op">)</span>,</span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>   <span class="op">=</span> <span class="fu">t_col</span><span class="op">(</span><span class="st">"#29a274ff"</span><span class="op">)</span>,</span>
<span>        <span class="st">"Post.+Error"</span> <span class="op">=</span> <span class="fu">t_col</span><span class="op">(</span><span class="st">"#777055ff"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"12 months"</span>, date_labels <span class="op">=</span> <span class="st">"%Y-%m"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Time series of GPP (Figure C5)</span></span>
<span><span class="va">dflong_gpp_train</span> <span class="op">&lt;-</span> <span class="va">df_predict_231p_gpp_sampled</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Scenario <span class="op">=</span> <span class="st">"231"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select only training sites</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">is_train0_test1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">posterior_sample_id</span>, <span class="va">error_sample_id</span>, <span class="va">Scenario</span>, <span class="va">is_train0_test1</span>, <span class="va">is_MAP</span>, <span class="va">sitename</span>, <span class="va">target</span>,</span>
<span>    <span class="va">obs</span>,                 <span class="va">date</span>, <span class="co"># these are target specific observation_metadata</span></span>
<span>    <span class="va">mod_no_err</span>, <span class="va">mod_biasremoved_no_err</span>, <span class="va">mod_biasremoved_with_err</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># pivot the model_output_types to long</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod_no_err</span>, <span class="va">mod_biasremoved_no_err</span>, <span class="va">mod_biasremoved_with_err</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"model_output_type"</span>, values_to <span class="op">=</span> <span class="st">"modelled"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model_output_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>    <span class="va">model_output_type</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mod_no_err"</span>, <span class="st">"mod_biasremoved_no_err"</span>, <span class="st">"mod_biasremoved_with_err"</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rsofun"</span>,    <span class="st">"bias-corrected"</span>,        <span class="st">"with struct. uncert."</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># derive column `parameters` ("MAP" or "Posterior") from `is_MAP`</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_MAP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_MAP</span>, <span class="st">"MAP"</span>, <span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">is_MAP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># derive column `dataset` ("train" or "test") from column `is_train0_test1`</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_train0_test1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_train0_test1</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"test"</span>, <span class="st">"train"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">is_train0_test1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_B3_timeseries</span> <span class="op">&lt;-</span> <span class="va">dflong_gpp_train</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># remove the bias-corrected values for gpp since we did not fit a bias</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">model_output_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bias-corrected"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># select what to plot and how to name it</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y_facet <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">Scenario</span> <span class="op">==</span> <span class="st">"231"</span> <span class="op">&amp;</span> <span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"rsofun"</span> <span class="op">&amp;</span>               <span class="va">parameters</span> <span class="op">==</span> <span class="st">"MAP"</span>       <span class="op">~</span> <span class="st">"MAP"</span>,</span>
<span>    <span class="va">Scenario</span> <span class="op">==</span> <span class="st">"231"</span> <span class="op">&amp;</span> <span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"rsofun"</span> <span class="op">&amp;</span>               <span class="va">parameters</span> <span class="op">==</span> <span class="st">"Posterior"</span> <span class="op">~</span> <span class="st">"Posterior"</span>,</span>
<span>    <span class="va">Scenario</span> <span class="op">==</span> <span class="st">"231"</span> <span class="op">&amp;</span> <span class="va">model_output_type</span> <span class="op">==</span> <span class="st">"with struct. uncert."</span> <span class="op">&amp;</span> <span class="va">parameters</span> <span class="op">==</span> <span class="st">"Posterior"</span> <span class="op">~</span> <span class="st">"Post.+Error"</span>,</span>
<span>    <span class="co"># all else is not plotted</span></span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"remove"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MAP"</span>, <span class="st">"Posterior"</span>, <span class="st">"Post.+Error"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">y_facet</span> <span class="op">!=</span> <span class="st">"remove"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot raw predictions</span></span>
<span><span class="va">pl_timeseries_gpp</span> <span class="op">&lt;-</span> <span class="fu">plot_predobs_gpp_timeseries3</span><span class="op">(</span><span class="va">df_B3_timeseries</span><span class="op">)</span></span>
<span><span class="va">pl_timeseries_gpp</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fake output since prediction was run previous to vignette rendering</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"files/param_calib_multitarget/predictions/pl_timeseries_gpp.png"</span>,</span>
<span>  dpi <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="files/param_calib_multitarget/predictions/pl_timeseries_gpp.png"><!-- --></p>
<p>Below we show a density scatter plot comparing predictions with
observations. Since we use the MAP values for predictions, the
uncertainty of the parameters is not taken into account. These plots are
useful to detect model biases for specific target variables or specific
ranges of the target variables.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gpp_labs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">xNULL</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">xNULL</span>, <span class="st">" "</span>, <span class="st">"Predicted GPP (g C m-\u00B2 s-\u00B9)"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Observed GPP (g C m-\u00B2 s-\u00B9)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">bigD13C_labs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">xNULL</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">xNULL</span>, <span class="st">" "</span>, <span class="st">"Predicted Δ (\u2030)"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Observed Δ (\u2030)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># compute scatters (and skills) for MAP of test set:</span></span>
<span><span class="va">list_of_scenarios_to_loop_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  s231 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"bigD13C"</span> <span class="op">=</span> <span class="va">df_predict_231p_bigD13C_sampled</span>,  <span class="st">"gpp"</span> <span class="op">=</span> <span class="va">df_predict_231p_gpp_sampled</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">parameter_set</span> <span class="op">&lt;-</span> <span class="st">"MAP"</span></span>
<span><span class="va">list_of_scatters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">list_of_scenarios_to_loop_over</span>, <span class="kw">function</span><span class="op">(</span><span class="va">list_of_targets</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">list_of_targets</span>, <span class="kw">function</span><span class="op">(</span><span class="va">df_target_prediction</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curr_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">df_target_prediction</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># (MAP, Posterior, Posterior+Error)</span></span>
<span>    <span class="co"># MAP:             is posterior_sample_id==0</span></span>
<span>    <span class="co">#                  e.g. filter(df_gpp, is_train0_test1 == 1,     is_MAP, error_sample_id==1)</span></span>
<span>    <span class="co"># Posterior:       just take one error sampling, but all (~25 posterior samples)</span></span>
<span>    <span class="co">#                  e.g. filter(df_gpp, is_train0_test1 == 1,             error_sample_id==1),</span></span>
<span>    <span class="co"># Posterior+Error: take all errors</span></span>
<span>    <span class="co">#                  e.g. filter(df_gpp, is_train0_test1 == 1,             error_sample_id&gt;=1)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df_target_prediction</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">parameter_set</span> <span class="op">==</span> <span class="st">"MAP"</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">is_MAP</span><span class="op">)</span> <span class="kw">else</span> <span class="va">.</span></span>
<span>      <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">error_sample_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># , is_train0_test1 == 1 # TODO: why was this removed?</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="st">"mod_biasremoved_no_err"</span></span>
<span>    <span class="va">lower_xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">curr_target</span> <span class="op">==</span> <span class="st">"gpp"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gg <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">analyse_modobs3</span><span class="op">(</span><span class="va">df</span>, mod <span class="op">=</span> <span class="va">mod</span>, obs <span class="op">=</span> <span class="st">"obs"</span>, type <span class="op">=</span> <span class="st">"hex"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### single comparison plot: ----</span></span>
<span><span class="va">mark_as_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">t_col</span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pl_scatter_comparison</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="va">list_of_scatters</span><span class="op">$</span><span class="va">s231</span><span class="op">$</span><span class="va">bigD13C</span><span class="op">$</span><span class="va">gg</span> <span class="op">+</span> <span class="va">mark_as_target</span> <span class="op">+</span> <span class="fu">bigD13C_labs</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">list_of_scatters</span><span class="op">$</span><span class="va">s231</span><span class="op">$</span><span class="va">gpp</span><span class="op">$</span><span class="va">gg</span>     <span class="op">+</span> <span class="va">mark_as_target</span> <span class="op">+</span> <span class="fu">gpp_labs</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pl_scatter_comparison</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fake output since prediction was run previous to vignette rendering</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"files/param_calib_multitarget/predictions/pl_scatter_comparison.png"</span>,</span>
<span>  dpi <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span></code></pre></div>
<p><img src="files/param_calib_multitarget/predictions/pl_scatter_comparison.png"><!-- --></p>
<p>The above vignette hopefully gives a first glimpse into a realistic
workflow that calibrates <code>rsofun</code> for multiple sites to
multiple targets. For more details refer to the model documentation
paper <a href="https://doi.org/10.5194/gmd-18-9855-2025" class="external-link">(Paredes et
al. 2025)</a> and the code referred therein.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameter calibration and cost functions • rsofun</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Parameter calibration and cost functions">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>rsofun <small>v5.1.0</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/geco-bern/rsofun/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parameter calibration and cost functions</h1>
                        <h4 data-toc-skip class="author">Josefa
Arán</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/geco-bern/rsofun/blob/master/vignettes/new_cost_function.Rmd" class="external-link"><code>vignettes/new_cost_function.Rmd</code></a></small>
      <div class="hidden name"><code>new_cost_function.Rmd</code></div>

    </div>

    
    
<p>The <code>rsofun</code> package allows to calibrate parameters of the
<code>pmodel</code> and <code>biomee</code> models via the
<code><a href="../reference/calib_sofun.html">calib_sofun()</a></code> function. The implementation of the
calibration is fairly flexible and can be adapted to a specific use-case
via a cost function (used as metrics for the optimization routines in
<code><a href="../reference/calib_sofun.html">calib_sofun()</a></code>). The package provides a set of standard cost
functions named <code>cost_*</code>, which can be used for a variety of
calibrations (different sets of model parameters, using various target
variables, etc.). Alternatively, it’s possible to write a more specific
new cost function to be used together with
<code><a href="../reference/calib_sofun.html">calib_sofun()</a></code>.</p>
<p>In this vignette, we go over some examples on how to use the
<code>rsofun</code> cost functions for parameter calibration and how to
write your own custom one from scratch.</p>
<div class="section level3">
<h3 id="calibration-to-gpp-using-rmse-and-gensa-optimizer">Calibration to GPP using RMSE and GenSA optimizer<a class="anchor" aria-label="anchor" href="#calibration-to-gpp-using-rmse-and-gensa-optimizer"></a>
</h3>
<p>A simple approach to parameter calibration is to find the parameter
values that lead to the best prediction performance, in terms of the
RMSE (root mean squared error). The function
<code><a href="../reference/cost_rmse_pmodel.html">cost_rmse_pmodel()</a></code> runs the P-model internally to calculate
the RMSE between predicted target values (in this case GPP) and the
corresponding observations.</p>
<p>The implementation of <code><a href="../reference/cost_rmse_pmodel.html">cost_rmse_pmodel()</a></code> allows
flexibility in various ways. We can simultaneously calibrate a subset of
model parameters and also replicate the different calibration setups in
Stocker et al., 2020 GMD. For example, following the <code>ORG</code>
setup, only parameter <code>kphio</code> is calibrated. Furthermore, the
standard cost functions allow to calibrate to several targets (fluxes
and leaf traits predicted by the P-model) simultaneously and to
parallelize the simulations. Since the P-model is run internally to make
predictions, we must always specify which values the model parameters
should take, i.e. the parameters that aren’t calibrated (via argument
<code>par_fixed</code>).</p>
<p>The syntax to run the calibration routine is as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings and parameter ranges from previous work</span></span>
<span><span class="va">settings_rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'GenSA'</span>,                   <span class="co"># minimizes the RMSE</span></span>
<span>  metric <span class="op">=</span> <span class="va">cost_rmse_pmodel</span>,          <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>                     <span class="co"># control parameters for optimizer GenSA</span></span>
<span>    maxit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,                     </span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>                         <span class="co"># bounds for the parameter space</span></span>
<span>    kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.02</span>, upper<span class="op">=</span><span class="fl">0.2</span>, init<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters using</span></span>
<span><span class="co"># demo datasets</span></span>
<span><span class="va">pars_calib_rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  <span class="co"># calib_sofun arguments:</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,  </span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_rmse</span>,</span>
<span>  <span class="co"># extra arguments passed to the cost function:</span></span>
<span>  par_fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>         <span class="co"># fix all other parameters</span></span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,        <span class="co"># set to zero to disable temperature-dependence </span></span>
<span>                                     <span class="co"># of kphio, setup ORG</span></span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover paper setup with soil moisture stress</span></span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span></span>
<span>  <span class="op">)</span>,</span>
<span>  targets <span class="op">=</span> <span class="st">"gpp"</span>           <span class="co"># define target variable GPP</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/calib_sofun.html">calib_sofun()</a></code> is a list containing the
calibrated parameter values and the raw optimization output from the
optimizer (here from <code>GenSA</code> or, as we see next, from
<code><a href="https://rdrr.io/pkg/BayesianTools/man/runMCMC.html" class="external-link">BayesianTools::runMCMC</a></code>).</p>
</div>
<div class="section level3">
<h3 id="calibration-to-gpp-using-a-simple-likelihood-function-and-bayesiantools">Calibration to GPP using a simple likelihood function and
BayesianTools<a class="anchor" aria-label="anchor" href="#calibration-to-gpp-using-a-simple-likelihood-function-and-bayesiantools"></a>
</h3>
<p>Let’s calibrate the parameters involved in the temperature dependency
of the quantum yield efficiency, <code>kphio</code>,
<code>kphio_par_a</code> and <code>kphio_par_b</code>, taking a Bayesian
calibration approach. We assume that the target variable
(<code>'gpp'</code>) follows a normal distribution centered at the
observations and with its standard deviation being a new calibratable
parameter (<code>'err_gpp'</code>). We also assume a uniform prior
distribution for all calibratable parameters. By maximizing the normal
log-likelihood, the MAP (maximum a posteriori) estimators for all 4
parameters are computed. With the function
<code><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel()</a></code>, we can easily perform this
calibration, as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings</span></span>
<span><span class="va">settings_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'BayesianTools'</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">cost_likelihood_pmodel</span>,            <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>                             <span class="co"># optimization control settings for </span></span>
<span>    sampler <span class="op">=</span> <span class="st">'DEzs'</span>,                           <span class="co"># BayesianTools::runMCMC</span></span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">1500</span>,</span>
<span>      iterations <span class="op">=</span> <span class="fl">3000</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">0.2</span>, init <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    kphio_par_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, upper <span class="op">=</span> <span class="fl">0.5</span>, init <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    kphio_par_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">10</span>, upper <span class="op">=</span> <span class="fl">40</span>, init <span class="op">=</span><span class="fl">25</span><span class="op">)</span>,</span>
<span>    err_gpp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">4</span>, init <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters using</span></span>
<span><span class="co"># demo datasets</span></span>
<span><span class="va">pars_calib_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  <span class="co"># calib_sofun arguments:</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_likelihood</span>,</span>
<span>  <span class="co"># extra arguments passed ot the cost function:</span></span>
<span>  par_fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>         <span class="co"># fix all other parameters</span></span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover paper setup with soil moisture stress</span></span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span></span>
<span>  <span class="op">)</span>,</span>
<span>  targets <span class="op">=</span> <span class="st">"gpp"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Furthermore, there are equivalent cost functions available for the
BiomeE model. Check out the reference pages for more details on how to
use <code><a href="../reference/cost_likelihood_biomee.html">cost_likelihood_biomee()</a></code> and
<code><a href="../reference/cost_rmse_biomee.html">cost_rmse_biomee()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="calibration-to-gpp-and-vcmax25-using-the-joint-log-likelihood-and-bayesiantools">Calibration to GPP and Vcmax25 using the joint log-likelihood and
BayesianTools<a class="anchor" aria-label="anchor" href="#calibration-to-gpp-and-vcmax25-using-the-joint-log-likelihood-and-bayesiantools"></a>
</h3>
<p>You may be interested in calibrating the model to different target
variables simultaneously, like flux and leaf trait measurements. Here we
present an example, where we use <code><a href="../reference/cost_likelihood_pmodel.html">cost_likelihood_pmodel()</a></code>
to compute the joint normal likelihood of all the targets specified
(that is, by summing the log-likelihoods of GPP and Vcmax25) and
ultimately calibrate the <code>kc_jmax</code> parameter. It would be
possible to follow this workflow for several-target calibration also
with RMSE as the optimization metric, using
<code><a href="../reference/cost_rmse_pmodel.html">cost_rmse_pmodel()</a></code> and <code>GenSA</code> optimization.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings for two targets</span></span>
<span><span class="va">settings_joint_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">"BayesianTools"</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">cost_likelihood_pmodel</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler <span class="op">=</span> <span class="st">"DEzs"</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">1500</span>,             <span class="co"># kept artificially low</span></span>
<span>      iterations <span class="op">=</span> <span class="fl">3000</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>kc_jmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.2</span>, upper <span class="op">=</span> <span class="fl">0.8</span>, init <span class="op">=</span> <span class="fl">0.41</span><span class="op">)</span>,  <span class="co"># uniform priors</span></span>
<span>             err_gpp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">4</span>, init <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>             err_vcmax25 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0.000001</span>, upper <span class="op">=</span> <span class="fl">0.0001</span>, init <span class="op">=</span> <span class="fl">0.00001</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the calibration on the concatenated data</span></span>
<span><span class="va">par_calib_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">p_model_drivers</span>,</span>
<span>                  <span class="va">p_model_drivers_vcmax25</span><span class="op">)</span>, </span>
<span>  obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">p_model_validation</span>,</span>
<span>              <span class="va">p_model_validation_vcmax25</span><span class="op">)</span>, </span>
<span>  settings <span class="op">=</span> <span class="va">settings_joint_likelihood</span>,</span>
<span>  <span class="co"># arguments for the cost function</span></span>
<span>  par_fixed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>         <span class="co"># fix parameter value from previous calibration</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.041</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">16</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="fl">240</span>,  <span class="co"># to recover paper setup with soil moisture stress</span></span>
<span>    soilm_betao        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,      <span class="co"># value from Atkin et al. 2015 for C3 herbaceous</span></span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span></span>
<span>  <span class="op">)</span>,    </span>
<span>  targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'gpp'</span>, <span class="st">'vcmax25'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that GPP predictions are directly compared to GPP observations
on that day, but Vcmax25 predicted by the P-model (being a leaf trait)
is averaged over the growing season and compared to a single Vcmax25
observation taken per site. The cost functions provided in the package
tell apart fluxes and leaf traits by the presence of a
<code>"date"</code> column in the nested validation data frames
<code>p_model_validation</code> and
<code>p_model_validation_vcmax25</code>.</p>
</div>
<div class="section level3">
<h3 id="write-your-custom-cost-function">Write your custom cost function<a class="anchor" aria-label="anchor" href="#write-your-custom-cost-function"></a>
</h3>
<p>If the RMSE or normal log-likelihood (for one or several targets)
cost functions that we provide do not fit your use case, you can easily
write a custom one. In this section, we drive you through the main ideas
with an example.</p>
<p>All cost functions must take at least three arguments:</p>
<ul>
<li><p><code>par</code>: A vector of calibratable model parameters. In
each iteration of the optimization, a new set of values of
<code>par</code> is used to run the model and compute the cost.</p></li>
<li><p><code>obs</code>: A data frame of observations, against which to
compare the simulation results.</p></li>
<li><p><code>drivers</code>: A data frame of driver data, used to run
the simulations.</p></li>
<li><p>Additional optional arguments can be used, like for example the
model parameter values that should be fixed across simulations,
etc.</p></li>
</ul>
<p>Since we are calibrating the parameters based on model outputs, the
cost function runs the P-model and compare its output to observed
validation data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Your code</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In the optimization procedure, the cost function only takes as
argument the parameters <code>par</code> that are fed to
<code><a href="../reference/calib_sofun.html">calib_sofun()</a></code> via <code>settings$par</code> (see previous
sections). Nevertheless, within the cost function we call
<code><a href="../reference/runread_pmodel_f.html">runread_pmodel_f()</a></code> and this function needs a full set of
model parameters. Therefore, the parameters that aren’t being calibrated
must be hard coded inside the cost function (or passed as an argument
like the <code>rsofun</code> cost functions). In this example, we only
want to calibrate the soil moisture stress parameters.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Set values for the list of calibrated and non-calibrated model parameters</span></span>
<span>  <span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">25</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Run the model</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span></span>
<span>    <span class="va">drivers</span>,</span>
<span>    par <span class="op">=</span> <span class="va">params_modl</span>,</span>
<span>    makecheck <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Your code to compute the cost</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The following chunk defines the final function. We clean the
observations and model output and align the data according to site and
date, to compute the mean absolute error (MAE) on GPP. Finally, the
function should return a scalar value, in this case the MAE, which we
want to minimize. Keep in mind that the GenSA optimization will minimize
the cost, but with the BayesianTools method the cost is always
maximized.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cost_mae</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Set values for the list of calibrated and non-calibrated model parameters</span></span>
<span>  <span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio              <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>    kphio_par_a        <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>    kphio_par_b        <span class="op">=</span> <span class="fl">25</span>,</span>
<span>    soilm_thetastar    <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    soilm_betao        <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    beta_unitcostratio <span class="op">=</span> <span class="fl">146.0</span>,</span>
<span>    rd_to_vcmax        <span class="op">=</span> <span class="fl">0.014</span>,</span>
<span>    tau_acclim         <span class="op">=</span> <span class="fl">30.0</span>,</span>
<span>    kc_jmax            <span class="op">=</span> <span class="fl">0.41</span></span>
<span>  <span class="op">)</span> <span class="co"># Set values for the list of calibrated and non-calibrated model parameters</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># Run the model</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span></span>
<span>    drivers <span class="op">=</span> <span class="va">drivers</span>,</span>
<span>    par <span class="op">=</span> <span class="va">params_modl</span>,</span>
<span>    makecheck <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Clean model output to compute cost</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co"># Clean validation data to compute cost</span></span>
<span>  <span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">'gpp_obs'</span> <span class="op">=</span> <span class="st">'gpp'</span><span class="op">)</span> <span class="co"># rename for later</span></span>
<span>    </span>
<span>  <span class="co"># Left join model output with observations by site and date</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">obs</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sitename'</span>, <span class="st">'date'</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute mean absolute error</span></span>
<span>  <span class="va">cost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">gpp</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">gpp_obs</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return the computed cost</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As a last step, let’s verify that the calibration procedure runs
using this cost function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings and parameter ranges</span></span>
<span><span class="va">settings_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'GenSA'</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">cost_mae</span>, <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    maxit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    soilm_thetastar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.0</span>, upper<span class="op">=</span><span class="fl">3000</span>, init<span class="op">=</span><span class="fl">0.6</span><span class="op">*</span><span class="fl">240</span><span class="op">)</span>,</span>
<span>    soilm_betao <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">1</span>, init<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters</span></span>
<span><span class="va">pars_calib_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_mae</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>

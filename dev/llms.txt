# rsofun

An R Simulating Optimal FUNctioning (RSOFUN) framework for site-scale
simulations of ecosystem processes. The package contains the following
modules:

- P-model for leaf-level acclimation of photosynthesis from [Stocker et
  al. (2019)](https://gmd.copernicus.org/preprints/gmd-2019-200/).
- SPLASH for bioclimatic variables, including the surface radiation
  budget and the soil water balance from [Davis et
  al. (2017)](https://doi.org/10.5194/gmd-10-689-2017).
- BiomeE for comprehensive simulations of ecosystem carbon and water
  cycling, tree growth, and tree cohort-explicit forest dynamics
  following the Perfect Plasticity Approximation, from [Weng et al.,
  (2015)](https://doi.org/10.5194/bg-12-2655-2015).

## Installation

### Stable release

To install the current stable release use a CRAN repository:

``` r
install.packages("rsofun")
library("rsofun")
```

### Development release

To install the latest development release of the package run the
following commands to install rsofun directly from GitHub:

``` r
if(!require(remotes)){install.packages("remotes")}
remotes::install_github("geco-bern/rsofun")
library("rsofun")
```

**NOTE:** Installing from GitHub requires compilation of Fortran and C
source code contained in {rsofun}. To enable compiling source code,
install [Rtools](https://cran.r-project.org/bin/windows/Rtools/) on
Windows, or [Xcode](https://developer.apple.com/xcode/) and the [GNU
Fortran compiler on
Mac](https://github.com/fxcoudert/gfortran-for-macOS) (see also
‘Mandatory tools’ [here](https://mac.r-project.org/tools/)). On Linux,
the gfortran compiler is usually installed already.

Vignettes are not rendered by default, if you want to include additional
documentation please use:

``` r
if(!require(remotes)){install.packages("remotes")}
remotes::install_github("geco-bern/rsofun", build_vignettes = TRUE)
library("rsofun")
```

### From source

Assuming `rsofun` is the location of the source directory, on can build
the R package (with extension .tar.gz) from the command line using:

``` bash
R CMD build --no-manual --no-build-vignettes rsofun
```

The package can then be installed with:

``` bash
R CMD INSTALL -c --preclean  *.tar.gz
```

, where the star `*` can be replaced by the name of the package produced
at the previous step.

## Use

Below sections show the ease of use of the package in terms of model
parameter specification and running both a single run or optimizing the
parameters for a given site (or multiple sites). For an in depth
discussion we refer to the
[vignettes](https://geco-bern.github.io/rsofun/articles/).

### Running model

With all data prepared we can run the P-model using
[`runread_pmodel_f()`](https://geco-bern.github.io/rsofun/dev/reference/runread_pmodel_f.md).
This function takes the nested data structure and runs the model site by
site, returning nested model output results matching the input drivers.

``` r
# define model parameter values from previous
# work
params_modl <- list(
    kphio              = 0.04998,    # setup ORG in Stocker et al. 2020 GMD
    kphio_par_a        = 0.0,        # set to zero to disable temperature-dependence of kphio
    kphio_par_b        = 1.0,
    soilm_thetastar    = 0.6 * 240,  # to recover old setup with soil moisture stress
    soilm_betao        = 0.0,
    beta_unitcostratio = 146.0,
    rd_to_vcmax        = 0.014,      # value from Atkin et al. 2015 for C3 herbaceous
    tau_acclim         = 30.0,
    kc_jmax            = 0.41
  )

# run the model for these parameters
output <- rsofun::runread_pmodel_f(
  p_model_drivers,
  par = params_modl
  )
```

### Parameter optimization

To optimize new parameters based upon driver data and a validation
dataset we must first specify an optimization strategy and settings, as
well as a cost function and parameter ranges.

``` r
settings <- list(
  method              = "GenSA",
  metric              = cost_rmse_pmodel,
  control = list(
    maxit = 100),
  par = list(
    kphio = list(lower=0.02, upper=0.2, init = 0.05)
    )
)
```

`rsofun` supports both optimization using the `GenSA` and
`BayesianTools` packages. The above statement provides settings for a
`GenSA` optimization approach. For this example the maximum number of
iterations is kept artificially low. In a real scenario you will have to
increase this value orders of magnitude. Keep in mind that optimization
routines rely on a cost function, which, depending on its structure
influences parameter selection. A limited set of cost functions is
provided but the model structure is transparent and custom cost
functions can be easily written. More details can be found in the
“Parameter calibration and cost functions” vignette.

In addition starting values and ranges are provided for the free
parameters in the model. Free parameters include: parameters for the
quantum yield efficiency `kphio`, `kphio_par_a` and `kphio_par_b`, soil
moisture stress parameters `soilm_thetastar` and `soilm_betao`, and also
`beta_unitcostratio`, `rd_to_vcmax`, `tau_acclim` and `kc_jmax` (see
[`?runread_pmodel_f`](https://geco-bern.github.io/rsofun/dev/reference/runread_pmodel_f.md)).
Be mindful that with newer versions of `rsofun` additional parameters
might be introduced, so re-check vignettes and function documentation
when updating existing code.

With all settings defined the optimization function
[`calib_sofun()`](https://geco-bern.github.io/rsofun/dev/reference/calib_sofun.md)
can be called with driver data and observations specified. Extra
arguments for the cost function (like what variable should be used as
target to compute the root mean squared error (RMSE) and previous values
for the parameters that aren’t calibrated, which are needed to run the
P-model).

``` r
# calibrate the model and optimize free parameters
pars <- calib_sofun(
    drivers = p_model_drivers,  
    obs = p_model_validation,
    settings = settings,
    # extra arguments passed to the cost function:
    targets = "gpp",             # define target variable GPP
    par_fixed = params_modl[-1]  # fix non-calibrated parameters to previous 
                                 # values, removing kphio
  )
```

## Data and code for model documentation paper (Paredes et al., in rev.)

Versioned releases of this repository are deposited on Zenodo (see badge
at the top of the README file). Code to reproduce the analysis and plots
presented here is contained in this repository (subdirectory
`analysis/`) and is demonstrated on the model documentation website
(<https://geco-bern.github.io/rsofun/>, article ‘Sensitivity analysis
and calibration interpretation’).

The model forcing and evaluation data is based on the publicly available
FLUXNET2015 data for the site FR-Pue, prepared by FluxDataKit v3.4.2
(10.5281/zenodo.14808331), taken here as a subset of the originally
published data for years 2007-2012. It is accessible through the
{rsofun} R package and contained as part of this repository
(subdirectory `data/`) as CSV and as files. Outputs of the analysis
presented here are archived in the `analysis/paper_results_files/`
subfolder.

The model documentation paper is currently under review. A preprint is
available at:
<https://www.biorxiv.org/content/10.1101/2023.11.24.568574v3>

## References

Stocker, B. D., Wang, H., Smith, N. G., Harrison, S. P., Keenan, T. F.,
Sandoval, D., Davis, T., and Prentice, I. C.: P-model v1.0: an
optimality-based light use efficiency model for simulating ecosystem
gross primary production, Geosci. Model Dev., 13, 1545–1581,
<https://doi.org/10.5194/gmd-13-1545-2020>, 2020.

Davis, T. W., Prentice, I. C., Stocker, B. D., Thomas, R. T., Whitley,
R. J., Wang, H., Evans, B. J., Gallego-Sala, A. V., Sykes, M. T., and
Cramer, W.: Simple process-led algorithms for simulating habitats
(SPLASH v.1.0): robust indices of radiation, evapotranspiration and
plant-available moisture, Geoscientific Model Development, 10, 689–708,
<doi:10.5194/gmd-10-689-2017>, URL http:
//www.geosci-model-dev.net/10/689/2017/, 2017.

Weng, E. S., Malyshev, S., Lichstein, J. W., Farrior, C. E., Dybzinski,
R., Zhang, T., Shevliakova, E., and Pacala, S. W.: Scaling from
individual trees to forests in an Earth system modeling framework using
a mathematically tractable model of height-structured competition,
Biogeosciences, 12, 2655–2694,
<https://doi.org/10.5194/bg-12-2655-2015>, 2015.

## Acknowledgements

The {rsofun} is part of the LEMONTREE project and funded by Schmidt
Futures and under the umbrella of the Virtual Earth System Research
Institute (VESRI).

# Package index

## All functions

- [`biomee_gs_leuning_drivers`](https://geco-bern.github.io/rsofun/dev/reference/biomee_gs_leuning_drivers.md)
  : rsofun BiomeE driver data (Leuning photosynthesis model)
- [`biomee_gs_leuning_output`](https://geco-bern.github.io/rsofun/dev/reference/biomee_gs_leuning_output.md)
  : rsofun BiomeE (gs_leuning) output data
- [`biomee_p_model_drivers`](https://geco-bern.github.io/rsofun/dev/reference/biomee_p_model_drivers.md)
  : rsofun BiomeE driver data (P-model photosynthesis model)
- [`biomee_p_model_luluc_drivers`](https://geco-bern.github.io/rsofun/dev/reference/biomee_p_model_luluc_drivers.md)
  : rsofun BiomeE driver data (P-model photosynthesis model) with LULUC
- [`biomee_p_model_luluc_output`](https://geco-bern.github.io/rsofun/dev/reference/biomee_p_model_luluc_output.md)
  : rsofun BiomeE (P-model) output data
- [`biomee_p_model_output`](https://geco-bern.github.io/rsofun/dev/reference/biomee_p_model_output.md)
  : rsofun BiomeE (P-model) output data
- [`biomee_validation`](https://geco-bern.github.io/rsofun/dev/reference/biomee_validation.md)
  : rsofun BiomeE targets validation data
- [`build_luc_matrix()`](https://geco-bern.github.io/rsofun/dev/reference/build_luc_matrix.md)
  : Build LUC matrix
- [`calib_sofun()`](https://geco-bern.github.io/rsofun/dev/reference/calib_sofun.md)
  : Calibrates SOFUN model parameters
- [`cost_likelihood_biomee()`](https://geco-bern.github.io/rsofun/dev/reference/cost_likelihood_biomee.md)
  : Log-likelihood cost function for BiomeE with different targets
- [`cost_likelihood_pmodel()`](https://geco-bern.github.io/rsofun/dev/reference/cost_likelihood_pmodel.md)
  : Cost function computing a log-likelihood for calibration of P-model
  parameters
- [`cost_rmse_biomee()`](https://geco-bern.github.io/rsofun/dev/reference/cost_rmse_biomee.md)
  : RMSE cost function for BiomeE
- [`cost_rmse_pmodel()`](https://geco-bern.github.io/rsofun/dev/reference/cost_rmse_pmodel.md)
  : Cost function computing RMSE for calibration of P-model parameters
- [`init_dates_dataframe()`](https://geco-bern.github.io/rsofun/dev/reference/init_dates_dataframe.md)
  : Initialises a tibble with dates
- [`p_model_drivers`](https://geco-bern.github.io/rsofun/dev/reference/p_model_drivers.md)
  : rsofun P-model driver data
- [`p_model_drivers_vcmax25`](https://geco-bern.github.io/rsofun/dev/reference/p_model_drivers_vcmax25.md)
  : rsofun P-model driver data (for leaf traits)
- [`p_model_output`](https://geco-bern.github.io/rsofun/dev/reference/p_model_output.md)
  : rsofun P-model output data
- [`p_model_output_vcmax25`](https://geco-bern.github.io/rsofun/dev/reference/p_model_output_vcmax25.md)
  : rsofun P-model output data (using vcmax25 drivers)
- [`p_model_validation`](https://geco-bern.github.io/rsofun/dev/reference/p_model_validation.md)
  : rsofun P-model GPP validation data
- [`p_model_validation_vcmax25`](https://geco-bern.github.io/rsofun/dev/reference/p_model_validation_vcmax25.md)
  : rsofun P-model Vcmax25 validation data
- [`run_biomee_f_bysite()`](https://geco-bern.github.io/rsofun/dev/reference/run_biomee_f_bysite.md)
  : Run BiomeE (R wrapper)
- [`run_pmodel_f_bysite()`](https://geco-bern.github.io/rsofun/dev/reference/run_pmodel_f_bysite.md)
  : Run P-model (time series)
- [`run_pmodel_onestep_f_bysite()`](https://geco-bern.github.io/rsofun/dev/reference/run_pmodel_onestep_f_bysite.md)
  : Run P-model (single time step)
- [`runread_biomee_f()`](https://geco-bern.github.io/rsofun/dev/reference/runread_biomee_f.md)
  : Run BiomeE
- [`runread_pmodel_f()`](https://geco-bern.github.io/rsofun/dev/reference/runread_pmodel_f.md)
  : Run P-model

# Articles

### All vignettes

- [P-model
  usage](https://geco-bern.github.io/rsofun/dev/articles/pmodel_use.md):
- [BiomeE
  usage](https://geco-bern.github.io/rsofun/dev/articles/biomee_use.md):
- [BiomeE
  LULUC](https://geco-bern.github.io/rsofun/dev/articles/biomee_luluc.md):
- [Data
  format](https://geco-bern.github.io/rsofun/dev/articles/data_format.md):
- [Parameter calibration and cost
  functions](https://geco-bern.github.io/rsofun/dev/articles/new_cost_function.md):
- [Sensitivity analysis and calibration
  interpretation](https://geco-bern.github.io/rsofun/dev/articles/sensitivity_analysis.md):

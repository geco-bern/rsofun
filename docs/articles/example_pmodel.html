<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example using P-model • rsofun</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example using P-model">
<meta property="og:description" content="rsofun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rsofun</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/benchmark_gpp_FLUXNET2015_ensemble_EXAMPLE.html">Benchmarking rsofun</a>
    </li>
    <li>
      <a href="../articles/example_lm3ppa.html">Example using LM3-PPA</a>
    </li>
    <li>
      <a href="../articles/example_pmodel.html">Example using P-model</a>
    </li>
    <li>
      <a href="../articles/prepare_inputs_rsofun.html">Prepare rsofun forcing data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stineb/rsofun/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="example_pmodel_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example using P-model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stineb/rsofun/blob/master/vignettes/example_pmodel.Rmd"><code>vignettes/example_pmodel.Rmd</code></a></small>
      <div class="hidden name"><code>example_pmodel.Rmd</code></div>

    </div>

    
    
<div id="example-using-rsofun-for-p-model-simulations" class="section level2">
<h2 class="hasAnchor">
<a href="#example-using-rsofun-for-p-model-simulations" class="anchor"></a>Example using rsofun for P-model simulations</h2>
<p>The following describes the use of <code>rsofun</code> for an ensemble of site-scale P-model simulations, including steps for model calibration and evaluation (benchmarking). <code>rsofun</code> is designed in a modular and hierarchical fashion. This enables multiple setups within the same modelling framework. The P-model implementation in <code>rsofun</code> is described in Stocker et al. (2020) <em>Geosci. Mod. Dev.</em>.</p>
<p>In the P-model setup, the model requires time series of daily meteorological data as input and is calibrated against observational GPP data. This example describes simulations at a subset of FLUXNET 2015 Tier 1 sites, using GPP based on the night-time flux partitioning method as calibration target and benchmark (no worries, an out-of-sample calibration/evaluation function is available, too).</p>
<div id="site-selection-and-meta-data" class="section level3">
<h3 class="hasAnchor">
<a href="#site-selection-and-meta-data" class="anchor"></a>Site selection and meta data</h3>
<p>We manually define a subset of sites that are part of the FLUXNET 2015 Tier 1 set of sites:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mysites</span> <span class="op">&lt;-</span> <span class="st">"FR-Pue"</span></code></pre></div>
<p>A small number of meta data variables have to be specified for each site specifically to define the simulation years. This information is also used for input, calibration, and evaluation data ingestion. Required meta information is specified for each site (in rows) and a number of variables:</p>
<ul>
<li>
<code>lat</code> for latitude (decimal degrees)</li>
<li>
<code>lon</code> for longitude (decimal degrees) - this is only used for data ingestion but not for the P-model simulation with <code>rsofun</code>.</li>
<li>
<code>elv</code> for elevation (m a.s.l.)</li>
<li>
<code>year_start</code> and <code>year_end</code> specifying years covered by the simulation</li>
<li>
<code>whc</code> for the soil water holding capacity</li>
<li>
<code>koeppen_code</code> to group sites for evaluation by Koeppen-Geiger climate zones.</li>
</ul>
<p>This information is provided by the data frame <code>siteinfo_fluxnet2015</code> which is available as part of the ingestr package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ingestr/man/siteinfo_fluxnet2015.html">siteinfo_fluxnet2015</a></span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">mysites</span><span class="op">)</span> <span class="op">%&gt;%</span> 

  <span class="co">## take only year 2007 to 2014, corresponding to subset of data for site FR-Pue provided in this package as demo</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year_start <span class="op">=</span> <span class="fl">2007</span>, year_end <span class="op">=</span> <span class="fl">2014</span><span class="op">)</span> <span class="op">%&gt;%</span> 

  <span class="co">## add info</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_start <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year_start</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_end <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">year_end</span>, <span class="st">"-12-31"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="simulation-settings" class="section level3">
<h3 class="hasAnchor">
<a href="#simulation-settings" class="anchor"></a>Simulation settings</h3>
<!-- Create a site meta info table that contains all the site-specific information that is used to force site-simulations (e.g. starting year, number of simulations years, elevation, etc.). For FLUXNET2015 data, required meta info is provided by the `rsofun` package (data frame `rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015`). -->
<!-- ```{r} -->
<!-- path_siteinfo <- "~/siteinfo_example_fortran.csv" -->
<!-- siteinfo <- rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015 %>%  -->
<!--   dplyr::filter(sitename %in% mysites) %>% -->
<!--   write_csv(path = path_siteinfo) -->
<!-- ``` -->
<p>Specify additional simulation parameters that are identical for all site-scale simulations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  spinup             <span class="op">=</span> <span class="cn">TRUE</span>,
  spinupyears        <span class="op">=</span> <span class="fl">10</span>,
  recycle            <span class="op">=</span> <span class="fl">1</span>,
  soilmstress        <span class="op">=</span> <span class="cn">TRUE</span>,
  tempstress         <span class="op">=</span> <span class="cn">TRUE</span>,
  calc_aet_fapar_vpd <span class="op">=</span> <span class="cn">FALSE</span>,
  in_ppfd            <span class="op">=</span> <span class="cn">TRUE</span>,
  in_netrad          <span class="op">=</span> <span class="cn">FALSE</span>,
  outdt              <span class="op">=</span> <span class="fl">1</span>,
  ltre               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltne               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltrd               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltnd               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr3               <span class="op">=</span> <span class="cn">TRUE</span>,
  lgn3               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr4               <span class="op">=</span> <span class="cn">FALSE</span>
    <span class="op">)</span></code></pre></div>
<p>Run <code><a href="../reference/prepare_setup_sofun.html">prepare_setup_sofun()</a></code> to define the simulation settings that contain all the information specified by the two steps above (meta info, and simulation parameters), global simulation parameters are wrapped inside an additional column <code>params_siml</code>, added to the site meta info dataframe.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_setup_sofun.html">prepare_setup_sofun</a></span><span class="op">(</span>siteinfo <span class="op">=</span> <span class="va">siteinfo</span>, params_siml <span class="op">=</span> <span class="va">params_siml</span><span class="op">)</span></code></pre></div>
</div>
<div id="define-model-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#define-model-parameters" class="anchor"></a>Define model parameters</h3>
<p>First, let’s do it by hand (calibration of parameters is shown later).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    kphio           <span class="op">=</span> <span class="fl">0.05</span>,
    soilm_par_a     <span class="op">=</span> <span class="fl">1.0</span>,
    soilm_par_b     <span class="op">=</span> <span class="fl">0.0</span>,
    vpdstress_par_a <span class="op">=</span> <span class="fl">0.2</span>,
    vpdstress_par_b <span class="op">=</span> <span class="fl">0.2</span>,
    vpdstress_par_m <span class="op">=</span> <span class="fl">5</span>
    <span class="op">)</span></code></pre></div>
</div>
<div id="define-soil-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#define-soil-parameters" class="anchor"></a>Define soil parameters</h3>
<p>For now, this is implemented as an illustration. Should be made site-specific. Values entered here take no effect.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_soiltexture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  top    <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"top"</span>,    fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
  bottom <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"bottom"</span>, fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="get-input" class="section level3">
<h3 class="hasAnchor">
<a href="#get-input" class="anchor"></a>Get input</h3>
<p>Now, meteorological forcing data and fAPAR data for each time step have to be collected. These steps are described in the vignette <code>vignettes/prepare_inputs_rsofun.Rmd</code> for FLUXNET 2015 simulations. All forcing data, combined with model and simulations parameters are collected into one big nested data frame <code>df_drivers</code>, which stores all required information by rows for each site. An example of how this looks like is provided as part of the rsofun package.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_drivers</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va">df_drivers</span>
<span class="va">df_drivers</span></code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   sitename params_siml       siteinfo         df_soiltexture    forcing         
##   &lt;chr&gt;    &lt;list&gt;            &lt;list&gt;           &lt;list&gt;            &lt;list&gt;          
## 1 FR-Pue   &lt;tibble[,18] [1 … &lt;tibble[,12] [1… &lt;tibble[,5] [2 ×… &lt;tibble[,10] [2…</code></pre>
<p>The units of fluxes have changed, but the object <code>df_drivers</code> has not been adjusted accordingly. Do it “by hand”.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prec</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prec</span> <span class="op">/</span> <span class="op">(</span><span class="fl">60</span><span class="op">*</span><span class="fl">60</span><span class="op">*</span><span class="fl">24</span><span class="op">)</span>
<span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">rain</span> <span class="op">&lt;-</span> <span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">prec</span>
<span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">snow</span> <span class="op">&lt;-</span> <span class="fl">0.0</span>
<span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ppfd</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ppfd</span> <span class="op">/</span> <span class="op">(</span><span class="fl">60</span><span class="op">*</span><span class="fl">60</span><span class="op">*</span><span class="fl">24</span><span class="op">)</span></code></pre></div>
</div>
<div id="run-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#run-the-model" class="anchor"></a>Run the model</h3>
<p>Run the model for all the sites specified in the first step.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## run for a single site</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_pmodel_f_bysite.html">run_pmodel_f_bysite</a></span><span class="op">(</span> 
  <span class="va">df_drivers</span><span class="op">$</span><span class="va">sitename</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, 
  <span class="va">df_drivers</span><span class="op">$</span><span class="va">params_siml</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
  <span class="va">df_drivers</span><span class="op">$</span><span class="va">siteinfo</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
  <span class="va">df_drivers</span><span class="op">$</span><span class="va">forcing</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
  <span class="va">df_drivers</span><span class="op">$</span><span class="va">df_soiltexture</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
  params_modl <span class="op">=</span> <span class="va">params_modl</span>, 
  makecheck <span class="op">=</span> <span class="cn">TRUE</span> 
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning in if (is.nanull(params_siml)) if (is.nanull(params_siml$spinup)) {: the
## condition has length &gt; 1 and only the first element will be used</code></pre>
<p>Run for the full set of sites</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">df_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span>
     <span class="va">df_drivers</span>, 
     params_modl <span class="op">=</span> <span class="va">params_modl</span>, 
     makecheck <span class="op">=</span> <span class="cn">TRUE</span>,
     parallel <span class="op">=</span> <span class="cn">FALSE</span>
     <span class="op">)</span></code></pre></div>
<pre><code>## Warning in if (is.nanull(params_siml)) if (is.nanull(params_siml$spinup)) {: the
## condition has length &gt; 1 and only the first element will be used</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ptm</span><span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.196   0.242   3.650</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># microbenchmark::microbenchmark(</span>
<span class="co">#   runread_pmodel_f(</span>
<span class="co">#     df_drivers, </span>
<span class="co">#     params_modl = params_modl, </span>
<span class="co">#     makecheck = TRUE,</span>
<span class="co">#     parallel = TRUE,</span>
<span class="co">#     ncores = 4</span>
<span class="co">#     ),</span>
<span class="co">#   runread_pmodel_f(</span>
<span class="co">#     df_drivers, </span>
<span class="co">#     params_modl = params_modl, </span>
<span class="co">#     makecheck = TRUE,</span>
<span class="co">#     parallel = FALSE</span>
<span class="co">#     ),</span>
<span class="co">#   times = 5,</span>
<span class="co">#   units = 's'</span>
<span class="co"># )</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_output</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">gpp</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="va">df_output</span><span class="op">$</span><span class="va">sitename</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, subtitle <span class="op">=</span> <span class="st">"SOFUN output"</span><span class="op">)</span></code></pre></div>
<p><img src="example_pmodel_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="calibrate" class="section level3">
<h3 class="hasAnchor">
<a href="#calibrate" class="anchor"></a>Calibrate</h3>
<p>Define calibration settings.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  method              <span class="op">=</span> <span class="st">"gensa"</span>,
  targetvars          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gpp"</span><span class="op">)</span>,
  timescale           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> gpp <span class="op">=</span> <span class="st">"d"</span> <span class="op">)</span>,
  maxit               <span class="op">=</span> <span class="fl">5</span>, <span class="co"># (5 for gensa) (30 for optimr)    #</span>
  sitenames           <span class="op">=</span> <span class="st">"FR-Pue"</span>,
  metric              <span class="op">=</span> <span class="st">"rmse"</span>,
  dir_results         <span class="op">=</span> <span class="st">"./"</span>,
  name                <span class="op">=</span> <span class="st">"ORG"</span>,
  par                 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> lower<span class="op">=</span><span class="fl">0.02</span>, upper<span class="op">=</span><span class="fl">0.07</span>, init<span class="op">=</span><span class="fl">0.0496</span> <span class="op">)</span> <span class="op">)</span>
 <span class="op">)</span></code></pre></div>
<p>Use the <a href="https://github.com/stineb/ingestr">ingestr</a> package once again, now for collecting calibration target data. I.e., GPP based on the nighttime flux decomposition method.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_ingestr_fluxnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  dir_hh <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/HH/"</span>, 
  getswc <span class="op">=</span> <span class="cn">FALSE</span>,
  filter_ntdt <span class="op">=</span> <span class="cn">TRUE</span>,
  threshold_GPP <span class="op">=</span> <span class="fl">0.8</span>,
  remove_neg <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="va">ddf_fluxnet_gpp</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">siteinfo</span>, <span class="va">sitename</span> <span class="op">==</span> <span class="st">"FR-Pue"</span><span class="op">)</span>,
  source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
  getvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gpp <span class="op">=</span> <span class="st">"GPP_NT_VUT_REF"</span>,
                 gpp_unc <span class="op">=</span> <span class="st">"GPP_NT_VUT_SE"</span><span class="op">)</span>,
  dir <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/DD/"</span>,
  settings <span class="op">=</span> <span class="va">settings_ingestr_fluxnet</span>,
  timescale <span class="op">=</span> <span class="st">"d"</span>
  <span class="op">)</span></code></pre></div>
<p>Calibrate the model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1982</span><span class="op">)</span>
<span class="va">settings_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span>
  df_drivers <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">df_drivers</span>, <span class="va">sitename</span> <span class="op">%in%</span> <span class="va">settings_calib</span><span class="op">$</span><span class="va">sitenames</span><span class="op">)</span>,  <span class="co"># use only one site</span>
  ddf_obs <span class="op">=</span> <span class="va">ddf_fluxnet_gpp</span>,
  settings <span class="op">=</span> <span class="va">settings_calib</span>
  <span class="op">)</span></code></pre></div>
<pre><code>##      kphio 
## 0.04545092 
## [1] "writing output from GenSA function to .//out_gensa_ORG.Rdata"
## [1] "writing calibrated parameters to .//params_opt_ORG.csv"</code></pre>
<p>The calibrated parameters are returned by <code><a href="../reference/calib_sofun.html">calib_sofun()</a></code> as part of the list:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">settings_calib</span><span class="op">$</span><span class="va">par_opt</span><span class="op">)</span></code></pre></div>
<pre><code>##      kphio 
## 0.04545092</code></pre>
<p>Update model parameters.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_params.html">update_params</a></span><span class="op">(</span><span class="va">params_modl</span>, <span class="va">settings_calib</span><span class="op">)</span></code></pre></div>
<p>Run the model again with updated parameters.</p>
</div>
<div id="evaluate" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluate" class="anchor"></a>Evaluate</h3>
<p>Run the model once again with these parameters and evaluate results.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_modl</span><span class="op">$</span><span class="va">kphio</span> <span class="op">&lt;-</span> <span class="va">settings_calib</span><span class="op">$</span><span class="va">par_opt</span><span class="op">[</span><span class="st">"kphio"</span><span class="op">]</span>

<span class="va">df_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span>
     <span class="va">df_drivers</span>, 
     params_modl <span class="op">=</span> <span class="va">params_modl</span>, 
     makecheck <span class="op">=</span> <span class="cn">TRUE</span>,
     parallel <span class="op">=</span> <span class="cn">FALSE</span>
     <span class="op">)</span></code></pre></div>
<p>Get evaluation data (benchmarking data).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## get data for idfferent time scales separately</span>
<span class="va">settings_fluxnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  getswc <span class="op">=</span> <span class="cn">FALSE</span>,
  filter_ntdt <span class="op">=</span> <span class="cn">TRUE</span>,
  threshold_GPP <span class="op">=</span> <span class="fl">0.8</span>,
  remove_neg <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="va">ddf_eval</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">mysites</span><span class="op">)</span>,
  source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gpp <span class="op">=</span> <span class="st">"GPP_NT_VUT_REF"</span>,
                   gpp_unc <span class="op">=</span> <span class="st">"GPP_NT_VUT_SE"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html">path.package</a></span><span class="op">(</span><span class="st">"ingestr"</span><span class="op">)</span>, <span class="st">"/extdata/"</span><span class="op">)</span>,
  settings  <span class="op">=</span> <span class="va">settings_fluxnet</span>,
  timescale <span class="op">=</span> <span class="st">"d"</span>
  <span class="op">)</span>

<span class="va">mdf_eval</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">mysites</span><span class="op">)</span>,
  source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gpp <span class="op">=</span> <span class="st">"GPP_NT_VUT_REF"</span>,
                   gpp_unc <span class="op">=</span> <span class="st">"GPP_NT_VUT_SE"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html">path.package</a></span><span class="op">(</span><span class="st">"ingestr"</span><span class="op">)</span>, <span class="st">"/extdata/"</span><span class="op">)</span>,
  settings  <span class="op">=</span> <span class="va">settings_fluxnet</span>,
  timescale <span class="op">=</span> <span class="st">"m"</span>
  <span class="op">)</span>

<span class="va">adf_eval</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">mysites</span><span class="op">)</span>,
  source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gpp <span class="op">=</span> <span class="st">"GPP_NT_VUT_REF"</span>,
                   gpp_unc <span class="op">=</span> <span class="st">"GPP_NT_VUT_SE"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/find.package.html">path.package</a></span><span class="op">(</span><span class="st">"ingestr"</span><span class="op">)</span>, <span class="st">"/extdata/"</span><span class="op">)</span>,
  settings  <span class="op">=</span> <span class="va">settings_fluxnet</span>,
  timescale <span class="op">=</span> <span class="st">"y"</span>
  <span class="op">)</span></code></pre></div>
<p>Use rsofun to create a standardised object used for benchmarking the model output.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  benchmark <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> gpp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fluxnet"</span><span class="op">)</span> <span class="op">)</span>,
  sitenames <span class="op">=</span> <span class="va">mysites</span>,
  agg       <span class="op">=</span> <span class="fl">8</span>  <span class="co"># An integer specifying the number of days used to define the width of bins for daily data aggregated to several days</span>
  <span class="op">)</span>
<span class="va">obs_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collect_obs_eval.html">collect_obs_eval</a></span><span class="op">(</span> 
  siteinfo <span class="op">=</span> <span class="va">siteinfo</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">%in%</span> <span class="va">mysites</span><span class="op">)</span>,
  settings <span class="op">=</span> <span class="va">settings_eval</span>, 
  adf <span class="op">=</span> <span class="va">adf_eval</span>, 
  mdf <span class="op">=</span> <span class="va">mdf_eval</span>, 
  ddf <span class="op">=</span> <span class="va">ddf_eval</span> 
  <span class="op">)</span></code></pre></div>
<p><code>obs_eval</code> is now a list of data frames for different temporal resolutions. The data frames have rows for sites and time series for each site nested inside the column <code>data</code>.</p>
<p><code>df_output</code> is the model output, also a data frame with rows for sites and time series for each site nested inside a column named <code>data</code>.</p>
<p>And finally do the evaluation.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eval_sofun.html">eval_sofun</a></span><span class="op">(</span> 
  <span class="va">df_output</span>, 
  <span class="va">settings_eval</span>, 
  <span class="va">settings_sims</span>, 
  obs_eval <span class="op">=</span> <span class="va">obs_eval</span>, 
  overwrite <span class="op">=</span> <span class="cn">TRUE</span>, 
  light <span class="op">=</span> <span class="cn">FALSE</span> 
  <span class="op">)</span></code></pre></div>
<p>Print some results.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_eval</span><span class="op">$</span><span class="va">gpp</span><span class="op">$</span><span class="va">fluxnet</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">xdaily_pooled</span></code></pre></div>
<pre><code>## # A tibble: 1 x 5
##     rsq  rmse slope   bias nvals
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;
## 1 0.448  1.32 0.817 -0.305   355</code></pre>
<p>Get the <a href="https://github.com/stineb/rbeni">rbeni</a> R package for nice plotting functions that can be used with the output of <code><a href="../reference/eval_sofun.html">eval_sofun()</a></code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stineb/rbeni">rbeni</a></span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Attaching package: 'rbeni'</code></pre>
<pre><code>## The following objects are masked from 'package:LSD':
## 
##     colorpalette, complementarycolor, convertcolor, convertgrey,
##     daltonize, disco, distinctcolors, heatpairs, heatscatter,
##     heatscatterpoints</code></pre>
<pre><code>## The following object is masked from 'package:ingestr':
## 
##     remove_outliers</code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">out_eval</span><span class="op">$</span><span class="va">gpp</span><span class="op">$</span><span class="va">fluxnet</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">xdf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/rbeni/man/analyse_modobs2.html">analyse_modobs2</a></span><span class="op">(</span><span class="st">"mod"</span>, <span class="st">"obs"</span>, type <span class="op">=</span> <span class="st">"heat"</span><span class="op">)</span>
<span class="va">gg</span><span class="op">$</span><span class="va">gg</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"FR-Pue: modelled vs. observed GPP"</span>, 
       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Modelled GPP (gC m"</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span>, <span class="st">"d"</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">}</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span>, 
       y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Observed GPP (gC m"</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span>, <span class="st">"d"</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">}</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula 'y ~ x'</code></pre>
<p><img src="example_pmodel_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Benjamin Stocker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameter calibration and cost functions • rsofun</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Parameter calibration and cost functions">
<meta property="og:description" content="rsofun">
<meta name="twitter:card" content="summary">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://computationales.ethz.ch/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://computationales.ethz.ch/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>rsofun <small>v4.3</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/biomee_model_structure.html">BiomeE model structure</a>
    </li>
    <li>
      <a href="../articles/biomee_use.html">BiomeE usage</a>
    </li>
    <li>
      <a href="../articles/new_cost_function.html">Parameter calibration and cost functions</a>
    </li>
    <li>
      <a href="../articles/pmodel_use.html">P-model usage</a>
    </li>
    <li>
      <a href="../articles/prepare_forcing.html">Prepare forcing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/computationales/rsofun/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parameter calibration and cost functions</h1>
                        <h4 data-toc-skip class="author">Pepa Aran</h4>
            
            <h4 data-toc-skip class="date">2022-10-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/computationales/rsofun/blob/HEAD/vignettes/new_cost_function.Rmd" class="external-link"><code>vignettes/new_cost_function.Rmd</code></a></small>
      <div class="hidden name"><code>new_cost_function.Rmd</code></div>

    </div>

    
    
<p>The <code>rsofun</code> package allows to calibrate parameters of the
<code>pmodel</code> via the <code><a href="../reference/calib_sofun.html">calib_sofun()</a></code> function and
various cost functions. All cost functions must take three arguments: -
<code>par</code>: A vector of calibratable model parameters. In each
iteration of the optimization, a new set of values of <code>par</code>
is used to run the model and compute the cost. - <code>obs</code>: A
data frame of observations, against which to compare the simulationn
results. - <code>drivers</code>: A data frame of driver data, used to
run the simulations. In this vignette, we go over some examples on how
to use these cost functions for parameter calibration and how to write
your own custom one, either using our standard framework or from
scratch.</p>
<div class="section level3">
<h3 id="calibration-using-rmse-on-gpp-and-gensa-optimizer">Calibration using RMSE on GPP and GenSA optimizer<a class="anchor" aria-label="anchor" href="#calibration-using-rmse-on-gpp-and-gensa-optimizer"></a>
</h3>
<p>A simple approach to parameter calibration is to fit the one that
leads to the best GPP prediction performance, in terms of the RMSE (root
mean squared error) . With <code><a href="../reference/create_cost_rmse_pmodel.html">create_cost_rmse_pmodel()</a></code>, we
can create a cost function that corresponds to different calibration
setups in Stocker et al., 2020 GMD. For example, following the
<code>FULL</code> setup, we can calibrate parameters <code>kphio</code>,
<code>soilm_par_a</code> and <code>soilm_par_b</code>. We must always
specify which values the fixed parameters should take, i.e. the
parameters that aren’t calibrated, and also the optimization method, in
this case <code>GenSA</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set parameter values</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio           <span class="op">=</span> <span class="fl">0.04607080</span>,</span>
<span>    soilm_par_a     <span class="op">=</span> <span class="fl">2.75687824</span>,</span>
<span>    soilm_par_b     <span class="op">=</span> <span class="fl">1.68140444</span>,</span>
<span>    tau_acclim_tempstress <span class="op">=</span> <span class="fl">7.35259044</span>,</span>
<span>    par_shape_tempstress  <span class="op">=</span> <span class="fl">0.09863961</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the cost function</span></span>
<span><span class="va">cost_rmse_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_cost_rmse_pmodel.html">create_cost_rmse_pmodel</a></span><span class="op">(</span></span>
<span>  params_modl <span class="op">=</span> <span class="va">pars</span>,</span>
<span>  setup <span class="op">=</span> <span class="st">'FULL'</span>,</span>
<span>  method <span class="op">=</span> <span class="st">'GenSA'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we can run the calibration routine, as follows.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings and parameter ranges from previous work</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'GenSA'</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">cost_rmse_full</span>, <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    maxit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.04</span>, upper<span class="op">=</span><span class="fl">0.2</span>, init<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    soilm_par_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.1</span>, upper<span class="op">=</span><span class="fl">5</span>, init<span class="op">=</span><span class="fl">2.4</span><span class="op">)</span>,</span>
<span>    soilm_par_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">2</span>, init<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters using</span></span>
<span><span class="co"># demo datasets</span></span>
<span><span class="va">pars_calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>When defining your custom cost function, you must keep in mind that
<code>GenSa</code> will minimize your cost function and
<code>BayesianTools</code> will maximize it, since the latter was
developed for likelihood maximization. NOTE: For now, only GPP is used
as a target variable for the simulation and calibration, but it will be
expanded in the future. Each cost function should be written for a
specific set of target variables.</p>
</div>
<div class="section level3">
<h3 id="calibration-using-simple-likelihood-function-and-bayesiantools">Calibration using simple likelihood function and BayesianTools<a class="anchor" aria-label="anchor" href="#calibration-using-simple-likelihood-function-and-bayesiantools"></a>
</h3>
<p>Let’s create a cost function to calibrate only the <code>kphio</code>
parameter, taking a Bayesian estimation approach. By maximizing the
normal log-likelihood, the MAP (maximum a posteriori) estimator for
<code>kphio</code> is computed.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">likelihood_pmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_cost_likelihood_pmodel.html">create_cost_likelihood_pmodel</a></span><span class="op">(</span></span>
<span>  params_modl <span class="op">=</span> <span class="va">pars</span>,  <span class="co"># reuse previous initial values</span></span>
<span>  setup <span class="op">=</span> <span class="st">'BRC'</span>,       <span class="co"># calibrate only kphio</span></span>
<span>  target <span class="op">=</span> <span class="st">'gpp'</span>       <span class="co"># same target name as column name in dataframe</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Note that, in the definition of the calibration settings, the control
parameters differ from the ones used with <code>GensA</code>. A uniform
prior for the parameter is also defined, by giving lower and upper
limits.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings</span></span>
<span><span class="va">settings_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'BayesianTools'</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">likelihood_pmodel</span>, <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sampler <span class="op">=</span> <span class="st">'DEzs'</span>,</span>
<span>    settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      burnin <span class="op">=</span> <span class="fl">500</span>,</span>
<span>      iterations <span class="op">=</span> <span class="fl">1500</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.04</span>, upper<span class="op">=</span><span class="fl">0.2</span>, init<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters using</span></span>
<span><span class="co"># demo datasets</span></span>
<span><span class="va">pars_calib_likelihood</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_likelihood</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>There are equivalent cost functions available for the LM3PPA model.
Check out the reference pages for more details on how to use
<code>create_cost_likelihood_lm3ppa</code> and
<code>create_cost_rmse_lm3ppa</code>.</p>
</div>
<div class="section level3">
<h3 id="write-your-custom-cost-function">Write your custom cost function<a class="anchor" aria-label="anchor" href="#write-your-custom-cost-function"></a>
</h3>
<p>If the RMSE or normal log-likelihood cost functions that we provide
do not fit your use case, you can easily write a custom one. In this
section, we drive you through the main ideas with an example.</p>
<p>All cost functions must take three arguments: a vector of
calibratable parameter values <code>par</code>, a data frame of observed
values which contains the target variable <code>obs</code> and a data
frame of drivers used to run the model <code>drivers</code>. Since we
are calibrating the parameters based on model outputs, the cost function
runs the p-model and compare its output to observed validation data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Your code</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In the optimization procedure, the cost function only takes as
argument the parameters <code>par</code> that are fed to
<code>calib_sofun</code> via <code>settings$par</code> (see previous
sections). Nevertheless, within the cost function we call
<code>runread_pmodel_f</code> and this function needs a full set of
model parameters. Therefore, the parameters that aren’t being calibrated
must be hard coded inside the cost function. In this example, we only
want to calibrate the soil moisture stress parameters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Set values for the list of calibrated and non-calibrated model parameters</span></span>
<span>  <span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    soilm_par_a <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    soilm_par_b <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    tau_acclim_tempstress <span class="op">=</span> <span class="fl">7.4</span>,</span>
<span>    par_shape_tempstress <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Run the model</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span></span>
<span>    <span class="va">drivers</span>,</span>
<span>    par <span class="op">=</span> <span class="va">params_modl</span>,</span>
<span>    makecheck <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Your code to compute the cost</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The following chunk defines the final function. We clean the
observations and model output and align the data according to site and
date, to compute the mean absolute error (MAE). Finally, the function
should return a scalar value, in this case the MAE, which we want to
minimize. The GenSA optimization will minimize the cost, but if we
wanted to use BayesianTools we should write <code>return(-cost)</code>
because it’s a maximizing routine.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cost_mae</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">obs</span>, <span class="va">drivers</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Set values for the list of calibrated and non-calibrated model parameters</span></span>
<span>  <span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    kphio <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    soilm_par_a <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    soilm_par_b <span class="op">=</span> <span class="va">par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>    tau_acclim_tempstress <span class="op">=</span> <span class="fl">7.4</span>,</span>
<span>    par_shape_tempstress <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Run the model</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span></span>
<span>    drivers <span class="op">=</span> <span class="va">drivers</span>,</span>
<span>    par <span class="op">=</span> <span class="va">params_modl</span>,</span>
<span>    makecheck <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Clean model output to compute cost</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="co"># Clean validation data to compute cost</span></span>
<span>  <span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sitename</span>, <span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">'gpp_obs'</span> <span class="op">=</span> <span class="st">'gpp'</span><span class="op">)</span> <span class="co"># rename for later</span></span>
<span>    </span>
<span>  <span class="co"># Left join model output with observations by site and date</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">obs</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'sitename'</span>, <span class="st">'date'</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute mean absolute error</span></span>
<span>  <span class="va">cost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">gpp</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">gpp_obs</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return the computed cost</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As a last step, let’s verify that the calibration procedure runs
using this cost function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define calibration settings and parameter ranges</span></span>
<span><span class="va">settings_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="st">'GenSA'</span>,</span>
<span>  metric <span class="op">=</span> <span class="va">cost_mae</span>, <span class="co"># our cost function</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    maxit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    soilm_par_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">0.1</span>, upper<span class="op">=</span><span class="fl">5</span>, init<span class="op">=</span><span class="fl">2.4</span><span class="op">)</span>,</span>
<span>    soilm_par_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lower<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">2</span>, init<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate the model and optimize the free parameters</span></span>
<span><span class="va">pars_calib_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_sofun.html">calib_sofun</a></span><span class="op">(</span></span>
<span>  drivers <span class="op">=</span> <span class="va">p_model_drivers</span>,</span>
<span>  obs <span class="op">=</span> <span class="va">p_model_validation</span>,</span>
<span>  settings <span class="op">=</span> <span class="va">settings_mae</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/computationales" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://computationales.ethz.ch/" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Computationales</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Our Team</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/computationales" class="external-link">Packages</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Publications</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>
